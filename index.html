<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>온라인 확정매출·집계 매뉴얼 - 넷폼알앤디</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL@20..48,100..700,0..1" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<style>
:root {
  --sky: #B0D4E8;
  --sky-deep: #528A9E;
  --sky-darker: #42798D;
  --sky-tint: #EDF4F8;
  --pink: #E4C0CC;
  --pink-deep: #96586A;
  --pink-tint: #F5ECF0;
  --yellow: #E4DCBA;
  --yellow-deep: #8A7A32;
  --yellow-tint: #F5F1E4;
  --lavender: #CCC4DA;
  --lavender-deep: #706088;
  --lavender-tint: #F0EDF4;
  --teal: #A8D5D8;
  --teal-deep: #4A7C7F;
  --teal-tint: #E8F4F5;
  --danger: #9A4444;
  --dark: #2A3A3A;
  --dark-mid: #3A4A4A;
  --text: #1E2E2E;
  --text-body: #3A4A4A;
  --text-muted: #6A7A7A;
  --gray: #94A4A4;
  --gray-light: #D8DED8;
  --card: #ffffff;
  --bg: #F1F5F9;
  --main: var(--sky-deep);
  --radius: 12px;
  --radius-sm: 10px;
  --radius-xs: 6px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Pretendard', 'Noto Sans KR', -apple-system, sans-serif;
  font-weight: 700;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  min-height: 100vh;
}

/* ===== 헤더 ===== */
.top-header {
  background: linear-gradient(135deg, var(--dark) 0%, var(--dark-mid) 100%);
  padding: 0 30px;
  height: 58px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}
.top-header h1 { font-size: 1.05rem; font-weight: 600; color: white; }
.header-right { display: flex; align-items: center; gap: 18px; }
.header-right .date { font-size: 0.78rem; color: var(--gray); }
.header-right .badge {
  background: linear-gradient(135deg, var(--pink), var(--lavender));
  color: var(--dark); padding: 4px 14px;
  border-radius: 12px; font-size: 0.68rem; font-weight: 600;
}
.month-sel {
  display: flex; align-items: center; gap: 6px;
}
.month-sel select {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: white; padding: 3px 10px;
  border-radius: 6px; font-size: 0.8rem;
  font-family: inherit; cursor: pointer;
}
.month-sel select option { color: var(--text); background: white; }

/* ===== 레이아웃 ===== */
.layout { display: flex; max-width: 1400px; margin: 0 auto; }

/* ===== 사이드바 ===== */
.side-nav {
  width: 240px;
  background: var(--card);
  position: sticky;
  top: 58px;
  height: calc(100vh - 58px);
  overflow-y: auto;
  border-right: 1px solid var(--gray-light);
  padding: 0 0 18px 0;
  flex-shrink: 0;
}
.side-nav::-webkit-scrollbar { width: 3px; }
.side-nav::-webkit-scrollbar-thumb { background: var(--gray-light); border-radius: 2px; }
.nav-sticky-header {
  position: sticky;
  top: 0;
  background: var(--card);
  z-index: 10;
  padding-top: 18px;
  border-bottom: 1px solid var(--gray-light);
}
.nav-section-title {
  font-size: 10px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 10px 20px;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 6px;
  background: var(--sky-tint);
  border-top: 1px solid rgba(0,0,0,0.04);
  border-bottom: 1px solid rgba(0,0,0,0.04);
}
.nav-section-title.pour-title { background: var(--sky-tint); color: var(--sky-deep); }
.nav-section-title.both-title { background: var(--pink-tint); color: var(--pink-deep); }
.nav-section-title.gro-title { background: var(--lavender-tint); color: var(--lavender-deep); }
.nav-section-title .dot {
  width: 6px; height: 6px; border-radius: 50%;
}
.nav-section-title .dot.sky { background: var(--sky-deep); }
.nav-section-title .dot.lavender { background: var(--lavender-deep); }
.nav-section-title .dot.pink { background: var(--pink-deep); }
.nav-section-title .dot.teal { background: var(--teal-deep); }
.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 20px;
  cursor: pointer;
  color: var(--text-body);
  font-size: 12.5px;
  font-weight: 400;
  transition: all 0.15s;
  border-left: 3px solid transparent;
}
.nav-item:hover { background: var(--sky-tint); }
.nav-item.active { background: var(--sky-tint); color: var(--main); font-weight: 500; border-left-color: var(--main); }
/* 드래그앤드롭 스타일 */
.nav-item.dragging { opacity: 0.5; background: var(--gray-light); }
.nav-item.drag-over { border-top: 2px solid var(--sky-deep); background: var(--sky-tint); }
.nav-drag-hint {
  font-size: 0.65rem; color: var(--gray); text-align: center;
  padding: 12px 10px; border-top: 1px solid var(--gray-light);
  margin-top: 10px;
}
.nav-item.grohome.active { background: var(--lavender-tint); color: var(--lavender-deep); border-left-color: var(--lavender-deep); }
.nav-item.both.active { background: var(--pink-tint); color: var(--pink-deep); border-left-color: var(--pink-deep); }
.nav-item.both:hover { background: var(--pink-tint); }
.nav-item.moyeora.active { background: var(--teal-tint); color: var(--teal-deep); border-left-color: var(--teal-deep); }
.nav-item.moyeora:hover { background: var(--teal-tint); }
.nav-item .nav-check {
  margin-left: auto; font-size: 14px; color: #4CAF50; display: none; flex-shrink: 0;
}
.nav-item.completed .nav-check { display: block; }
.nav-item .nav-dot {
  margin-left: auto; width: 6px; height: 6px; border-radius: 50%;
  background: var(--gray-light); flex-shrink: 0;
}
.nav-item.completed .nav-dot { display: none; }

/* ===== 메인 ===== */
.main-content { flex: 1; padding: 22px 28px 70px; min-width: 0; }

/* ===== 대시보드 ===== */
.dashboard-section {
  background: linear-gradient(135deg, #1E3A5F 0%, #2E4A6F 100%);
  border-radius: var(--radius);
  padding: 20px 24px;
  margin-bottom: 20px;
  color: white;
}
.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.dashboard-title {
  font-size: 0.9rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}
.dashboard-title .month-badge {
  background: rgba(255,255,255,0.15);
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 0.72rem;
  font-weight: 500;
}
.dashboard-update {
  font-size: 0.68rem;
  color: rgba(255,255,255,0.6);
}
.summary-cards {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
}
.dash-card {
  background: rgba(255,255,255,0.08);
  border-radius: 10px;
  padding: 14px 16px;
  text-align: left;
  border-left: 3px solid transparent;
  transition: all 0.2s;
}
.dash-card:hover {
  background: rgba(255,255,255,0.12);
}
.dash-card.sky { border-left-color: #60A5FA; }
.dash-card.lavender { border-left-color: #A78BFA; }
.dash-card.pink { border-left-color: #F472B6; }
.dash-card.teal { border-left-color: #2DD4BF; }
.dash-title { font-size: 0.68rem; color: rgba(255,255,255,0.6); font-weight: 500; margin-bottom: 4px; }
.dash-value { font-size: 1.4rem; font-weight: 700; color: white; }
.dash-sub { font-size: 0.65rem; color: rgba(255,255,255,0.5); margin-top: 2px; }
.progress-track {
  width: 100%; height: 4px; background: rgba(255,255,255,0.15);
  border-radius: 4px; overflow: hidden; margin-top: 8px;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #60A5FA, #A78BFA);
  border-radius: 4px; transition: width 0.5s ease;
}
/* 브랜드별 매출 바 */
.brand-bars {
  display: flex;
  gap: 16px;
  margin-top: 16px;
  padding-top: 14px;
  border-top: 1px solid rgba(255,255,255,0.1);
}
.brand-bar-item {
  flex: 1;
}
.brand-bar-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.7rem;
  margin-bottom: 4px;
}
.brand-bar-name { color: rgba(255,255,255,0.7); }
.brand-bar-value { color: white; font-weight: 600; }
.brand-bar-track {
  height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  overflow: hidden;
}
.brand-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.5s ease;
}
.brand-bar-fill.grohome { background: #A78BFA; }
.brand-bar-fill.pourstore { background: #60A5FA; }
.brand-bar-fill.moyeora { background: #2DD4BF; }

/* ===== 콘텐츠 카드 ===== */
.shop-content { display: none; }
.shop-content.active { display: block; }

.content-card {
  background: var(--card);
  border-radius: var(--radius);
  margin-bottom: 12px;
  box-shadow: 0 3px 14px rgba(0,0,0,0.05);
  overflow: hidden;
  border: 1px solid var(--gray-light);
}
.content-card.pour { border-left: 3px solid var(--sky); }
.content-card.grohome { border-left: 3px solid var(--lavender); }
.content-card.both { border-left: 3px solid var(--pink); }

.card-header {
  padding: 16px 22px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: default;
  transition: background 0.15s;
}
.card-header-icon {
  width: 34px; height: 34px;
  border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  color: white; flex-shrink: 0; font-size: 16px;
}
.card-header-icon.sky { background: var(--sky-deep); }
.card-header-icon.pink { background: var(--pink-deep); }
.card-header-icon.lavender { background: var(--lavender-deep); }
.card-header-icon.yellow { background: var(--yellow-deep); }
.card-header-icon.teal { background: var(--teal-deep); }
.card-header-title { font-size: 0.92rem; font-weight: 600; color: var(--text); }
.card-header-sub { font-size: 0.72rem; color: var(--text-muted); margin-top: 1px; }
.card-header-right { margin-left: auto; display: flex; align-items: center; gap: 6px; }
.card-toggle { display: none; }
.card-body {
  padding: 0 22px 16px;
  transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.25s ease;
  overflow: hidden;
}

/* ===== 체크포인트 박스 (접속정보 영역) ===== */
.checkpoint-box {
  border: 1px solid rgba(184,216,232,0.3);
  border-radius: var(--radius-sm);
  margin: 6px 0;
  overflow: hidden;
  background: linear-gradient(180deg, rgba(184,216,232,0.04), transparent);
}
.checkpoint-box.lav {
  border-color: rgba(208,200,216,0.3);
  background: linear-gradient(180deg, rgba(208,200,216,0.04), transparent);
}
.checkpoint-box.pink-box {
  border-color: rgba(232,200,208,0.3);
  background: linear-gradient(180deg, rgba(232,200,208,0.04), transparent);
}
.checkpoint-box.teal-box {
  border-color: rgba(74,124,127,0.2);
  background: linear-gradient(180deg, rgba(232,244,245,0.3), transparent);
}
.checkpoint-title {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 16px;
  font-size: 0.72rem; font-weight: 700;
  color: var(--sky-deep);
  text-transform: uppercase; letter-spacing: 0.8px;
  border-bottom: 1px solid rgba(184,216,232,0.2);
}
.checkpoint-box.lav .checkpoint-title {
  color: var(--lavender-deep);
  border-bottom-color: rgba(208,200,216,0.2);
}
.checkpoint-box.pink-box .checkpoint-title {
  color: var(--pink-deep);
  border-bottom-color: rgba(232,200,208,0.2);
}
.checkpoint-title .material-symbols-outlined { font-size: 16px; }

.info-item {
  display: flex; align-items: center;
  padding: 0;
  border-bottom: 1px solid rgba(0,0,0,0.04);
}
.info-item:last-child { border-bottom: none; }
.info-item .label {
  width: 90px; flex-shrink: 0;
  padding: 10px 16px;
  font-weight: 600; color: var(--text-muted);
  font-size: 0.76rem;
  background: rgba(0,0,0,0.015);
}
.info-item .value {
  flex: 1; padding: 10px 14px;
  color: var(--text); font-weight: 400;
  font-size: 0.85rem; word-break: break-all;
}
.info-item .value a { color: var(--sky-deep); text-decoration: none; font-weight: 600; }
.info-item .value a:hover { text-decoration: underline; }
.info-item .value.masked { letter-spacing: 2px; color: var(--text-muted); }
.info-item .actions {
  display: flex; gap: 4px; padding-right: 14px; flex-shrink: 0;
}

/* 편집모드 info-row */
.info-row {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 14px; margin: 3px 0;
  background: var(--bg); border-radius: var(--radius-xs);
  font-size: 0.82rem;
}
.info-row .label {
  font-weight: 600; color: var(--text-muted);
  min-width: 70px; font-size: 0.75rem;
}

.btn-icon {
  width: 28px; height: 28px;
  border: 1px solid var(--gray-light); border-radius: 6px;
  background: white; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s; flex-shrink: 0;
}
.btn-icon:hover { border-color: var(--main); color: var(--main); box-shadow: 0 1px 4px rgba(74,122,142,0.1); }
.btn-icon .material-symbols-outlined { font-size: 14px; }

.btn-edit {
  padding: 5px 12px;
  border: 1px solid var(--gray-light); border-radius: 8px;
  background: white; color: var(--text-body);
  font-size: 0.74rem; font-weight: 500;
  cursor: pointer; font-family: inherit;
  transition: all 0.15s;
  display: flex; align-items: center; gap: 4px;
}
.btn-edit:hover { border-color: var(--main); color: var(--main); }
.btn-save {
  padding: 5px 14px; border: 1px solid var(--sky-deep);
  border-radius: 8px; background: var(--sky-deep); color: white;
  font-size: 0.74rem; font-weight: 500; cursor: pointer; font-family: inherit;
}
.btn-save:hover { background: var(--sky-darker); }
.btn-cancel {
  padding: 5px 14px; border: 1px solid var(--gray-light);
  border-radius: 8px; background: white; color: var(--text-muted);
  font-size: 0.74rem; font-weight: 500; cursor: pointer; font-family: inherit;
}
.edit-input {
  width: 100%; padding: 6px 10px;
  border: 1px solid var(--sky); border-radius: 6px;
  font-size: 0.84rem; font-family: inherit; outline: none;
}
.edit-input:focus { border-color: var(--sky-deep); box-shadow: 0 0 0 2px rgba(74,122,142,0.1); }

/* ===== 경로 ===== */
.path-section {
  display: flex; align-items: center;
  padding: 14px 16px; gap: 14px;
}
.path-section + .path-section { border-top: 1px solid rgba(0,0,0,0.04); }
.path-label {
  flex-shrink: 0;
  font-size: 0.82rem; font-weight: 800;
  color: var(--sky-deep); background: var(--sky-tint);
  padding: 6px 14px; border-radius: 6px;
  white-space: nowrap;
}
.path-sublabel {
  flex-shrink: 0;
  font-size: 0.75rem; font-weight: 600;
  color: var(--text-muted); background: var(--bg);
  padding: 4px 12px; border-radius: 4px;
  white-space: nowrap; border: 1px solid var(--gray-light);
}
.path-flow {
  display: flex; align-items: center; flex-wrap: wrap; gap: 5px; flex: 1;
}
.path-step {
  background: white; padding: 4px 12px;
  border-radius: 18px; font-size: 0.8rem;
  font-weight: 400; color: var(--text-body);
  border: 1px solid var(--gray-light);
}
.path-arrow { color: var(--gray); font-size: 14px; }

/* ===== 참고사항 ===== */
.note-box {
  padding: 9px 16px; margin: 0;
  font-size: 0.8rem; line-height: 1.5;
  display: flex; align-items: center; gap: 8px;
  background: var(--yellow-tint);
  border-top: 1px solid rgba(232,224,192,0.3);
  color: var(--yellow-deep);
}
.note-box .material-symbols-outlined { font-size: 15px; flex-shrink: 0; }

/* ===== 매출금액 입력 ===== */
.sales-input-row {
  display: flex; align-items: center; padding: 0;
  border-bottom: 1px solid rgba(0,0,0,0.04);
}
.sales-input-row:last-child { border-bottom: none; }
.sales-input-row .label {
  width: 90px; flex-shrink: 0;
  padding: 12px 16px;
  font-weight: 800; color: var(--text-muted);
  font-size: 0.76rem;
  background: rgba(0,0,0,0.015);
}
.sales-input {
  flex: 1; border: none; outline: none;
  padding: 12px 14px;
  font-size: 0.92rem; font-weight: 400;
  font-family: inherit; color: var(--text);
  background: transparent;
}
.sales-input::placeholder { color: var(--gray); font-weight: 400; }
.sales-display {
  flex: 1; padding: 12px 14px;
  font-size: 0.92rem; font-weight: 800;
  color: var(--sky-deep);
}
.sales-actions { display: flex; gap: 4px; padding-right: 14px; flex-shrink: 0; }
/* 연간 매출 테이블 */
.sales-yearly { border-top: 1px solid rgba(0,0,0,0.06); }
.sales-yearly-title {
  padding: 10px 16px;
  font-size: 0.72rem; font-weight: 800;
  color: var(--text-muted); letter-spacing: 0.5px;
  background: rgba(0,0,0,0.015);
  border-bottom: 1px solid rgba(0,0,0,0.04);
}
.sales-month-row {
  display: flex; align-items: center;
  padding: 0;
  border-bottom: 1px solid rgba(0,0,0,0.03);
}
.sales-month-row:last-child { border-bottom: none; }
.sales-month-row .m-label {
  width: 60px; flex-shrink: 0;
  padding: 8px 16px;
  font-size: 0.75rem; font-weight: 800;
  color: var(--text-muted);
  background: rgba(0,0,0,0.015);
  text-align: center;
}
.sales-month-row .m-value {
  flex: 1; padding: 8px 14px;
  font-size: 0.82rem; font-weight: 700;
  color: var(--text-body); text-align: right;
}
.sales-month-row .m-value.empty { color: var(--gray-light); }
.sales-month-row .m-value.current { color: var(--sky-deep); font-weight: 800; }
.sales-total-row {
  display: flex; align-items: center;
  padding: 0;
  background: var(--sky-tint);
  border-top: 2px solid var(--sky);
}
.sales-total-row .m-label {
  width: 60px; flex-shrink: 0;
  padding: 10px 16px;
  font-size: 0.78rem; font-weight: 800;
  color: var(--sky-deep);
  text-align: center;
}
.sales-total-row .m-value {
  flex: 1; padding: 10px 14px;
  font-size: 0.88rem; font-weight: 800;
  color: var(--sky-deep); text-align: right;
}
/* 다운로드 버튼 */
.btn-download {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 6px 14px; border-radius: 8px;
  border: 1px solid var(--sky);
  background: var(--sky-tint); color: var(--sky-deep);
  font-size: 0.75rem; font-weight: 800;
  font-family: inherit; cursor: pointer;
  transition: all 0.15s;
}
.btn-download:hover { background: var(--sky); color: white; }
.btn-download .material-symbols-outlined { font-size: 14px; }
.btn-data-sm {
  display: inline-flex; align-items: center; gap: 2px;
  padding: 4px 10px; border-radius: 4px;
  border: none;
  background: rgba(0,0,0,0.04); color: #aaa;
  font-size: 0.68rem; font-weight: 400;
  cursor: pointer;
}
.btn-data-sm:hover { background: rgba(0,0,0,0.08); color: #666; }
.btn-data-sm .material-symbols-outlined { font-size: 13px; }

/* ===== 사이드바 검색 ===== */
.nav-search {
  padding: 8px 12px;
}
.nav-search input {
  width: 100%; padding: 7px 12px;
  border: 1px solid var(--gray-light); border-radius: 8px;
  font-size: 0.78rem; font-weight: 700;
  font-family: inherit; outline: none;
  background: white; color: var(--text);
}
.nav-search input::placeholder { color: var(--gray); font-weight: 500; }
.nav-search input:focus { border-color: var(--sky-deep); box-shadow: 0 0 0 2px rgba(74,122,142,0.1); }
.nav-item.hidden { display: none; }

/* ===== 서브 섹션 라벨 ===== */
.sub-section-label {
  font-size: 0.82rem; font-weight: 700; padding: 12px 4px 6px;
  margin-top: 8px; color: var(--pink-deep);
  border-bottom: 2px solid var(--pink);
}
.sub-section-label.pour { color: var(--sky-deep); border-bottom-color: var(--sky); }
.sub-section-label.grohome { color: var(--lavender-deep); border-bottom-color: var(--lavender); }

/* ===== 매출 현황 탭 버튼 ===== */
.nav-tab-bar {
  display: flex; padding: 8px 12px; gap: 4px;
}
.nav-tab {
  flex: 1; padding: 7px 0; border: none; border-radius: 8px;
  font-size: 0.75rem; font-weight: 800;
  font-family: inherit; cursor: pointer;
  background: transparent; color: var(--text-muted);
  transition: all 0.15s;
}
.nav-tab.active { background: var(--sky-deep); color: white; }
.nav-tab:not(.active):hover { background: rgba(0,0,0,0.04); }

/* ===== 매출 현황 전체 테이블 ===== */
.sales-overview { padding: 16px; }
.sales-table-wrap {
  overflow-x: auto; border-radius: var(--radius-sm);
  border: 1px solid rgba(0,0,0,0.06);
}
.sales-table {
  width: 100%; border-collapse: collapse;
  font-size: 0.75rem; white-space: nowrap;
  font-variant-numeric: tabular-nums;
}
.sales-table th {
  padding: 8px 10px;
  background: var(--sky-tint); color: var(--sky-deep);
  font-weight: 600; text-align: center;
  border-bottom: 2px solid var(--sky);
  position: sticky; top: 0;
}
.sales-table th.sortable { cursor: pointer; user-select: none; }
.sales-table th.sortable:hover { background: var(--sky); color: white; }
.sales-table th.vat-toggle { background: rgba(74,122,142,0.1); }
.sales-table th.vat-toggle:hover { background: var(--sky); color: white; }
.sort-icon { font-size: 0.65rem; margin-left: 3px; opacity: 0.4; }
.sort-icon.active { opacity: 1; color: var(--sky-deep); }
.sales-table th:first-child { text-align: left; min-width: 130px; }
.sales-table td {
  padding: 7px 10px;
  text-align: right; font-weight: 400;
  color: var(--text-body);
  border-bottom: 1px solid rgba(0,0,0,0.04);
}
.sales-table td:first-child {
  text-align: left; font-weight: 500;
  color: var(--text); background: rgba(0,0,0,0.01);
}
.sales-table td.shop-link {
  cursor: pointer; color: var(--sky-deep);
}
.sales-table td.shop-link:hover { color: var(--sky-darker); background: var(--sky-tint); }
.sales-table td.empty { color: #ddd; }
.sales-table tr:hover td { background: rgba(184,216,232,0.08); }
.sales-table tr.group-header td {
  background: var(--sky-tint); font-weight: 600;
  color: var(--sky-deep); border-bottom: 1px solid var(--sky);
  padding: 6px 10px;
}
.sales-table tfoot td {
  font-weight: 600; color: var(--sky-deep);
  background: var(--sky-tint);
  border-top: 2px solid var(--sky);
}
/* 자사몰 그룹 행 - 일반 쇼핑몰과 동일 스타일 */
.sales-table tr.jasang-group td {
  background: transparent;
}
.sales-table tr.jasang-group:hover td { background: rgba(184,216,232,0.08); }
/* 자사몰 하위 행 */
.sales-table tr.jasang-child td {
  background: rgba(0,0,0,0.02);
  border-bottom: 1px dashed rgba(0,0,0,0.06);
  color: #888;
}
.sales-table tr.jasang-child td:first-child {
  padding-left: 24px;
}
.sales-table tr.jasang-child:hover td { background: rgba(184,216,232,0.08); }

/* ===== VAT 탭 ===== */
.vat-tab-bar {
  display: inline-flex; gap: 2px;
  background: rgba(0,0,0,0.04); border-radius: 8px;
  padding: 2px;
}
.vat-tab {
  padding: 5px 14px; border: none; border-radius: 6px;
  font-size: 0.75rem; font-weight: 800;
  font-family: inherit; cursor: pointer;
  background: transparent; color: var(--text-muted);
  transition: all 0.15s;
}
.vat-tab.active { background: var(--sky-deep); color: white; }
.vat-tab:not(.active):hover { background: rgba(0,0,0,0.06); }
/* 매출현황 상위 탭 (쇼핑몰별 / 브랜드별 / 대시보드) */
.sales-view-tabs {
  display: flex; gap: 0; margin-bottom: 16px;
  border-bottom: 2px solid var(--gray-light);
}
.sales-view-tab {
  padding: 10px 24px; cursor: pointer;
  font-size: 0.88rem; font-weight: 600;
  color: var(--text-muted); border: none; background: none;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px; transition: all 0.15s;
}
.sales-view-tab:hover { color: var(--sky-deep); }
.sales-view-tab.active { color: var(--sky-deep); border-bottom-color: var(--sky-deep); }
/* 상세내역 하위 탭 (쇼핑몰별 / 브랜드별) */
.sales-view-subtabs {
  display: flex; gap: 4px; margin-bottom: 16px; padding-left: 8px;
}
.sales-view-subtab {
  padding: 6px 18px; cursor: pointer;
  font-size: 0.82rem; font-weight: 500;
  color: var(--text-muted); border: 1px solid var(--gray-light);
  background: #f9fafb; border-radius: 6px;
  transition: all 0.15s;
}
.sales-view-subtab:hover { background: #e5e7eb; color: var(--sky-deep); }
.sales-view-subtab.active {
  background: var(--sky-deep); color: white;
  border-color: var(--sky-deep);
}
/* 브랜드 선택 탭 (그로홈/포어스토어/모여라딜) - 탭바 스타일 */
.brand-select-tabs {
  display: flex; gap: 0; background: #f3f4f6;
  padding: 8px 8px 0 8px; border-radius: 10px 10px 0 0;
  border-bottom: 2px solid #d1d5db; margin-bottom: 16px;
}
.brand-select-tab {
  padding: 10px 20px; background: none; border: none;
  border-radius: 8px 8px 0 0; cursor: pointer;
  font-weight: 500; font-size: 0.8rem; color: #9ca3af;
  position: relative; margin-bottom: -2px; transition: all 0.15s;
}
.brand-select-tab:hover { color: #374151; background: rgba(255,255,255,0.7); }
.brand-select-tab.active { background: white; font-weight: 700; border: 2px solid #e2e8f0; border-bottom: 3px solid white; box-shadow: 0 -3px 10px rgba(0,0,0,0.08); }
.brand-select-tab.active::after { content: ''; position: absolute; bottom: -3px; left: 10%; width: 80%; height: 3px; border-radius: 3px 3px 0 0; }
.brand-select-tab.active.grohome { color: #f97316; }
.brand-select-tab.active.grohome::after { background: #f97316; }
.brand-select-tab.active.pourstore { color: #10b981; }
.brand-select-tab.active.pourstore::after { background: #10b981; }
.brand-select-tab.active.moyeora { color: #06b6d4; }
.brand-select-tab.active.moyeora::after { background: #06b6d4; }
.sales-toolbar {
  display: flex; align-items: center; gap: 12px;
  padding-bottom: 12px;
}
.sales-toolbar .nav-search { flex: 1; padding: 0; }
/* 순서 편집 버튼 (작게) */
.btn-order-edit {
  font-family: 'Material Symbols Outlined';
  font-size: 14px; color: #ccc;
  background: none; border: none;
  cursor: pointer; padding: 4px;
  opacity: 0.5; transition: all 0.15s;
}
.btn-order-edit:hover { opacity: 1; color: var(--sky-deep); }
.btn-order-edit.active { opacity: 1; color: #f57c00; }
/* 드래그 스타일 */
.sales-table tr.order-edit-mode { cursor: grab; }
.sales-table tr.order-edit-mode:active { cursor: grabbing; }
.sales-table tr.dragging { opacity: 0.5; background: #fffde7 !important; }
.sales-table tr.drag-over td { border-top: 2px solid #f57c00 !important; }

/* ===== 완료 버튼 ===== */
.complete-toggle {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 18px; border-radius: 10px;
  border: 1px solid var(--gray-light);
  background: white; cursor: pointer;
  font-family: inherit; font-size: 0.82rem;
  font-weight: 500; color: var(--text-body);
  transition: all 0.2s; margin-top: 14px;
}
.complete-toggle:hover { border-color: #4CAF50; }
.complete-toggle.done {
  background: rgba(76,175,80,0.06);
  border-color: #4CAF50; color: #2E7D32;
}
.complete-toggle .check-box {
  width: 18px; height: 18px;
  border: 2px solid var(--gray-light); border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.complete-toggle.done .check-box { background: #4CAF50; border-color: #4CAF50; }
.complete-toggle .check-box .material-symbols-outlined {
  font-size: 12px; color: white; display: none;
}
.complete-toggle.done .check-box .material-symbols-outlined { display: block; }

/* ===== 토스트 ===== */
.toast {
  position: fixed; bottom: 24px; left: 50%;
  transform: translateX(-50%) translateY(16px);
  background: var(--dark); color: white;
  padding: 10px 20px; border-radius: 8px;
  font-size: 0.8rem; font-weight: 500;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  opacity: 0; transition: all 0.25s ease;
  z-index: 300; pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ===== 데이터 업로드 ===== */
.upload-slots-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 10px 16px; }
.upload-slot { border-bottom: none; }
.upload-slot-label {
  font-size: 0.85rem; font-weight: 700; color: var(--text-body);
  margin-bottom: 6px; display: flex; align-items: center; gap: 6px;
}
.upload-slot-label .badge-ok {
  font-size: 0.65rem; background: var(--sky-deep); color: white;
  padding: 1px 8px; border-radius: 10px; font-weight: 500;
}
.upload-dropzone {
  border: 2px dashed var(--gray-light); border-radius: 8px;
  padding: 14px; text-align: center; cursor: pointer;
  transition: all 0.15s; background: var(--bg);
  font-size: 0.78rem; font-weight: 400; color: var(--text-muted);
}
.upload-dropzone:hover { border-color: var(--sky); background: var(--sky-tint); }
.upload-dropzone.dragover { border-color: var(--sky-deep); background: rgba(184,216,232,0.15); }
.upload-dropzone.has-file {
  border-style: solid; border-color: var(--sky-deep); background: rgba(184,216,232,0.08);
  color: var(--text); display: flex; align-items: center; gap: 10px; text-align: left;
}
.upload-dropzone .material-symbols-outlined { font-size: 20px; color: var(--gray); }
.upload-dropzone.has-file .material-symbols-outlined { color: var(--sky-deep); }
.upload-file-info { flex: 1; }
.upload-file-name { font-size: 0.8rem; font-weight: 600; }
.upload-file-meta { font-size: 0.68rem; color: var(--text-muted); }
.upload-remove {
  background: none; border: none; cursor: pointer; color: var(--gray);
  font-size: 16px; padding: 2px; transition: color 0.15s;
}
.upload-remove:hover { color: var(--danger); }
.upload-actions {
  display: flex; gap: 6px; padding: 12px 16px; justify-content: flex-end;
  border-top: 1px solid rgba(0,0,0,0.04);
}
.btn-merge {
  padding: 8px 20px; border-radius: 8px; border: none;
  background: var(--sky-deep); color: white;
  font-size: 0.8rem; font-weight: 600; cursor: pointer;
  font-family: inherit; display: flex; align-items: center; gap: 6px;
  transition: all 0.15s;
}
.btn-merge:hover { background: var(--sky-darker); }
.btn-merge:disabled { background: var(--gray-light); cursor: not-allowed; color: var(--gray); }
.btn-merge .material-symbols-outlined { font-size: 16px; }

/* 검증 결과 */
.verify-box {
  margin: 10px 16px; padding: 10px 14px; border-radius: 8px;
  font-size: 0.78rem; line-height: 1.6; display: none;
}
.verify-box.show { display: block; }
.verify-box.match {
  background: rgba(184,216,232,0.15); border: 1px solid rgba(74,122,142,0.3); color: var(--sky-deep);
}
.verify-box.mismatch {
  background: rgba(211,47,47,0.08); border: 1px solid rgba(211,47,47,0.25); color: #c62828;
}
.verify-box .verify-title { font-weight: 700; margin-bottom: 2px; }
.verify-box .verify-row { display: flex; justify-content: space-between; }

/* 매핑 설정 */
.mapping-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 8px; }
.mapping-table th {
  padding: 6px 10px; background: var(--bg); color: var(--text-muted);
  font-weight: 600; text-align: left; border-bottom: 1px solid var(--gray-light);
}
.mapping-table td { padding: 5px 10px; border-bottom: 1px solid rgba(0,0,0,0.04); }
.mapping-table select {
  width: 100%; padding: 4px 8px; border: 1px solid var(--gray-light);
  border-radius: 4px; font-size: 0.75rem; font-family: inherit;
}
.mapping-toggle {
  font-size: 0.72rem; color: var(--sky-deep); cursor: pointer;
  padding: 6px 16px; display: flex; align-items: center; gap: 4px;
  border-top: 1px solid rgba(0,0,0,0.04);
}
.mapping-toggle:hover { background: var(--sky-tint); }
.mapping-toggle .material-symbols-outlined { font-size: 14px; }
.mapping-body { padding: 0 16px 12px; display: none; }
.mapping-body.open { display: block; }
</style>
</head>
<body>

<div class="top-header">
  <h1 id="headerTitle">온라인 확정매출·집계 — 1월</h1>
  <div class="header-right">
    <div class="month-sel">
      <select id="monthSelect" onchange="changeMonth(this.value)"></select>
    </div>
    <span class="date" id="headerDate"></span>
    <button class="btn-data-sm" onclick="exportData()" title="데이터를 JSON 파일로 저장"><span class="material-symbols-outlined">save</span>저장</button>
    <label class="btn-data-sm" title="JSON 파일에서 데이터 불러오기"><span class="material-symbols-outlined">folder_open</span>불러오기<input type="file" accept=".json" onchange="importData(event)" style="display:none;"></label>
    <button class="btn-data-sm" onclick="openKeywordModal()" title="그로홈 제품 키워드 관리"><span class="material-symbols-outlined">label</span>관리</button>
    <span class="badge">넷폼알앤디</span>
  </div>
</div>

<div class="layout">
  <nav class="side-nav" id="sideNav">
    <div class="nav-sticky-header">
      <div class="nav-search"><input type="text" id="shopSearch" placeholder="쇼핑몰 검색..." oninput="filterShops(this.value)"></div>
      <div class="nav-tab-bar">
        <button class="nav-tab" id="tabShops" onclick="switchTab('shops')">쇼핑몰</button>
        <button class="nav-tab active" id="tabSales" onclick="switchTab('sales')">매출 현황</button>
      </div>
    </div>
    <div id="navList"></div>
  </nav>
  <div class="main-content" id="mainContent">
    <div id="viewShops" style="display:none;">
    <div id="shopContents"></div>
    </div>
    <div id="viewSales">
      <div class="sales-overview" id="salesOverview"></div>
    </div>
    <div id="viewMergeOnly" style="display:none;">
      <div style="margin-bottom:24px;">
        <h2 style="font-size:1.1rem;font-weight:700;margin-bottom:4px;">데이터 취합</h2>
        <p style="font-size:0.78rem;color:var(--text-muted);">각 쇼핑몰에서 업로드한 데이터를 하나의 엑셀로 통합</p>
      </div>
      <div class="content-card pour" style="border-left-color:var(--sky);">
        <div class="card-header">
          <div class="card-header-icon sky"><span class="material-symbols-outlined" style="font-size:16px;">merge_type</span></div>
          <div><div class="card-header-title">전체 쇼핑몰 데이터 취합</div><div class="card-header-sub">각 쇼핑몰에서 업로드한 데이터를 하나의 엑셀로 통합</div></div>
        </div>
        <div class="card-body">
          <div class="checkpoint-box sky-box" style="padding:16px;">
            <div id="mergeAllStatus" style="font-size:0.78rem;color:var(--text-muted);margin-bottom:10px;"></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button class="btn-merge" onclick="executeMergeAll()">
                <span class="material-symbols-outlined">download</span> 로우데이터 다운로드
              </button>
              <button class="btn-merge" onclick="downloadMaeibMaechulFormat()" style="background:#10b981;">
                <span class="material-symbols-outlined">description</span> 위하고 업로드 양식
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
function _d(s) { return decodeURIComponent(escape(atob(s))); }
const SHOPS = [
  {id:'pour_kg', name:'포어_자사몰_KG', group:'pour', url:'https://iniweb.inicis.com/j_spring_security_check', userId:'COCnetform', userPw:_d('enB6ZzEzNTQ2QEA='), note:'이메일인증: netform', path:'정산/세금계산서 > 정산내역 > 통합정산내역조회 > 승인일', dataPaths:[{label:'KG이니시스', path:'통합조회 > NEW 통합승인내역조회'},{label:'아임웹', path:'아임웹 관리자 > 주문관리 > 주문목록 > 엑셀다운로드'}]},
  {id:'pour_bucket', name:'오늘의집', group:'both', url:'https://orora.ohou.se/signin?redirectUrl=%2F', userId:'netform@naver.com', userPw:_d('enB6ZzEzNTQ2QEAh'), note:'이메일인증: netform', path:'정산관리 > 부가세신고', dataPaths:[{label:'정산내역', path:'정산관리 > 정산내역 > 건별정산내역 > 세금신고기준일'}]},
  {id:'pour_navimro', name:'나비엠알오', group:'pour', url:'https://scm.navimro.com/main/', userId:'NM2570', userPw:_d('enB6ZzEzNTQ2QEA='), path:'원장조회 > 매입일자 > 엑셀출력 (역발행)', dataPaths:[{label:'매입원장', path:'원장조회 > 매입일자 > 엑셀출력'}]},
  {id:'pour_11st', name:'11번가', group:'pour', url:'https://login.11st.co.kr/auth/front/selleroffice/login.tmall?returnURL=http%3A%2F%2Fsoffice.11st.co.kr%2FIndex.tmall', userId:'netform', userPw:_d('enB6ZzEzNTQ2QEAh'), note:'이메일인증: pourstore / zpzg13546@', path:'정산관리 > 부가세신고내역'},
  {id:'pour_gmarket', name:'지마켓', group:'pour', url:'https://signin.esmplus.com/login', userId:'netform', userPw:_d('WnB6ZzEzNTQ2IUAj'), path:'정산관리 > G마켓 판매진행내역 > 매출기준일', dataPaths:[{label:'판매내역', path:'정산관리 > G마켓 판매진행내역 > 판매내역 다운로드'},{label:'배송비내역', path:'정산관리 > G마켓 판매진행내역 > 배송비내역 다운로드'}]},
  {id:'pour_auction', name:'옥션', group:'pour', url:'https://signin.esmplus.com/login', userId:'netform', userPw:_d('WnB6ZzEzNTQ2IUAj'), note:'판매자 예치금 비밀번호: zpzg13546@@', path:'정산관리 > 부가세신고내역'},
  {id:'pour_offline', name:'계좌입금 매출', group:'both', url:'', userId:'', userPw:'', note:'더존 자료 기반 금액 산출', path:'', dataPaths:[{label:'계좌입금내역', path:''}]},
  {id:'both_smart_pour', name:'스마트스토어_포어', group:'both', url:'https://sell.smartstore.naver.com/#/home/dashboard', userId:'netform', userPw:_d('enB6ZzEzNTQ2QA=='), path:'정산관리 > 부가세신고', dataPaths:[{label:'매출내역', path:'정산관리 > 정산내역 > 건별정산내역 > 세금신고기준일'},{label:'구매확정내역', path:'정산관리 > 정산내역 > 건별정산내역 > 구매확정기준일'}]},
  {id:'both_smart_gro', name:'스마트스토어_그로홈', group:'both', url:'https://sell.smartstore.naver.com/#/home/dashboard', userId:'netform', userPw:_d('enB6ZzEzNTQ2QA=='), path:'정산관리 > 부가세신고', dataPaths:[{label:'매출내역', path:'정산관리 > 정산내역 > 건별정산내역 > 세금신고기준일'},{label:'구매확정내역', path:'정산관리 > 정산내역 > 건별정산내역 > 구매확정기준일'}]},
  {id:'pour_domegook', name:'도매꾹', group:'both', url:'https://domeggook.com/sc/calculate/sellerView', userId:'pourstore0', userPw:_d('enB6ZzEzNTQ2QA=='), path:'구매확정 > 구매확정기준일 셋팅 후 > 엑셀다운로드 > 엑셀다운로드관리', dataPaths:[{label:'구매확정내역', path:'구매확정 > 엑셀다운로드 > 엑셀다운로드관리'}]},
  {id:'pour_coupang', name:'쿠팡', group:'both', url:'https://wing.coupang.com/', userId:'pourstore', userPw:_d('enB6ZzEzNTQ2QEBA'), paths:[{label:'중개(위탁)', path:'정산 > 부가세신고내역'},{label:'로켓그로스', path:'정산 > 로켓그로스 현황'}], dataPaths:[{label:'중개(위탁)', path:'정산 > 부가세신고내역'},{label:'로켓그로스', path:'정산 > 로켓그로스 현황'}]},
  {id:'both_naver_pour', name:'자사몰_네이버페이_포어', group:'both', url:'https://admin.pay.naver.com/front/e/v1/settle_pay/page/settlemgt/taxinvoice', userId:'netform', userPw:_d('enB6ZzEzNTQ2QA=='), path:'정산관리 > 부가세신고', dataPaths:[{label:'매출내역', path:'정산관리 > 정산내역 > 건별정산내역 > 세금신고기준일'},{label:'구매확정내역', path:'정산관리 > 정산내역 > 건별정산내역 > 구매확정기준일'}]},
  {id:'both_naver_gro', name:'자사몰_네이버페이_그로홈', group:'both', url:'https://admin.pay.naver.com/front/e/v1/settle_pay/page/settlemgt/taxinvoice', userId:'netform', userPw:_d('enB6ZzEzNTQ2QA=='), path:'정산관리 > 부가세신고', dataPaths:[{label:'매출내역', path:'정산관리 > 정산내역 > 건별정산내역 > 세금신고기준일'},{label:'구매확정내역', path:'정산관리 > 정산내역 > 건별정산내역 > 구매확정기준일'}]},
  {id:'gro_toss_pay', name:'자사몰_토스', group:'grohome', url:'https://www.tosspayments.com/', userId:'netform@naver.com', userPw:_d('enB6ZzEzNTQ2QEA='), path:'부가세신고자료 > 매출', uploadPaths:[{label:'가상계좌', path:''},{label:'계좌이체', path:''},{label:'카페24 상세내역', path:'카페24 > 주문 > 전체주문조회'}]},
  {id:'gro_kakao', name:'카카오 톡체크아웃', group:'grohome', url:'https://business.kakao.com/dashboard/', userId:'netform@naver.com', userPw:_d('enB6ZzEzNTQ2QEA='), note:'네이버메일 인증: netformrnd / zpzg13546@', path:'판매 > 톡체크아웃 > 그로홈 > 부가세신고자료', dataPaths:[{label:'톡체크아웃', path:''}]},
  {id:'gro_kakaotalk', name:'카카오 톡스토어', group:'grohome', url:'https://shopping-seller.kakao.com/display/store-seller/dashboard', userId:'netform@naver.com', userPw:_d('enB6ZzEzNTQ2QEA='), note:'이메일인증: pourstore / zpzg13546@', path:'정산관리 > 부가세신고금액', dataPaths:[{label:'톡스토어', path:''}]},
  {id:'gro_toss_shop', name:'그로홈_토스쇼핑', group:'grohome', url:'https://business.toss.im/account/sign-in', userId:'grohome@naver.com', userPw:_d('enB6ZzEzNTQ2QEA='), note:'이메일인증: pourstore / zpzg13546@', path:'정산관리 > 부가세신고금액'},
  {id:'gro_cafe24', name:'자사몰_카페24', group:'grohome', url:'https://eclogin.cafe24.com/Shop/', userId:'growhome', userPw:_d('6re466Gc7Zi466y07Zi466y0MTIhQA=='), note:'이메일인증:', path:'주문 > 전체주문조회', dataPaths:[{label:'매출금액', path:'부가서비스 > 카페24페이먼츠(pg) > 실시간거래내역 > 날짜설정 > 검색하기 > 엑셀다운로드'},{label:'상세내역', path:'주문 > 전체주문조회'}]},
  {id:'moyeora_cafe24', name:'모여라딜', group:'moyeora', url:'https://eclogin.cafe24.com/Shop/', userId:'moyeora02', userPw:_d('6re466Gc7Zi466y07Zi466y0MTIhQA=='), note:'참고사항: moyeoradeal /', path:'주문 > 전체주문조회', dataPaths:[{label:'매출금액', path:'부가서비스 > 카페24페이먼츠(pg) > 실시간거래내역 > 날짜설정 > 검색하기 > 엑셀다운로드'},{label:'상세내역', path:'주문 > 전체주문조회'}]},
];

let currentMonth = new Date().getMonth() || 12;
let currentYear = new Date().getFullYear();
let currentShop = null;
let DATA = loadData();

function loadData() {
  try {
    const d = JSON.parse(localStorage.getItem('salesManualData')) || {settings:{}, completed:{}, sales:{}};
    /* pour_bucket note 보정: 이전 저장값이 이메일인증 형식이 아니면 기본값으로 리셋 */
    if (d.settings && d.settings['pour_bucket'] && d.settings['pour_bucket'].note !== undefined && !d.settings['pour_bucket'].note.startsWith('이메일인증')) {
      d.settings['pour_bucket'].note = '이메일인증: netform';
    }
    return d;
  }
  catch { return {settings:{}, completed:{}, sales:{}}; }
}
function saveData() { localStorage.setItem('salesManualData', JSON.stringify(DATA)); }

/* JSON 파일에서 데이터 불러오기 (페이지 로드 시 자동 실행) */
async function loadDataFromFile() {
  try {
    const response = await fetch('salesData.json?t=' + Date.now());
    if (response.ok) {
      const fileData = await response.json();
      DATA = fileData;
      localStorage.setItem('salesManualData', JSON.stringify(DATA));
      return true;
    }
  } catch(e) {
    console.log('salesData.json 파일 없음, localStorage 사용');
  }
  return false;
}

/* JSON 파일로 데이터 내보내기 (다운로드) - 월별 업로드 데이터 포함 */
function exportData() {
  /* 현재 월의 업로드 데이터를 DATA에 저장 */
  const monthKey = currentYear + '-' + String(currentMonth).padStart(2,'0');
  if (!DATA.uploadFiles) DATA.uploadFiles = {};
  DATA.uploadFiles[monthKey] = JSON.parse(JSON.stringify(UPLOAD_FILES));

  const blob = new Blob([JSON.stringify(DATA, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `salesData_${monthKey}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  saveData(); /* localStorage에도 업로드 데이터 포함하여 저장 */
  showToast(`salesData_${monthKey}.json 파일이 다운로드되었습니다. (${currentMonth}월 업로드 데이터 포함)`);
}

/* JSON 파일에서 데이터 가져오기 - 업로드 데이터 복원 포함 */
function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const importedData = JSON.parse(e.target.result);

      /* 업로드 파일 데이터 복원 */
      if (importedData.uploadFiles) {
        const monthKey = currentYear + '-' + String(currentMonth).padStart(2,'0');
        if (importedData.uploadFiles[monthKey]) {
          /* 현재 월의 업로드 데이터가 있으면 UPLOAD_FILES에 복원 */
          Object.assign(UPLOAD_FILES, importedData.uploadFiles[monthKey]);
        }
        /* 모든 월의 업로드 데이터도 병합 */
        Object.keys(importedData.uploadFiles).forEach(mk => {
          if (!DATA.uploadFiles) DATA.uploadFiles = {};
          DATA.uploadFiles[mk] = importedData.uploadFiles[mk];
        });
      }

      DATA = importedData;
      saveData();

      const uploadCount = Object.keys(UPLOAD_FILES).length;
      showToast(`데이터를 불러왔습니다. (업로드 파일 ${uploadCount}개 복원됨)`);
      location.reload();
    } catch(err) {
      showToast('파일 형식이 올바르지 않습니다.');
    }
  };
  reader.readAsText(file);
}

function getShopSetting(shopId, field) {
  /* dataPaths는 항상 SHOPS 배열에서 가져옴 (localStorage 무시) */
  const shop = SHOPS.find(s => s.id === shopId);
  if (field === 'dataPaths') {
    return shop ? shop.dataPaths : null;
  }
  /* 그 외 필드는 localStorage에서 먼저 확인 */
  if (DATA.settings[shopId] && DATA.settings[shopId][field] !== undefined) return DATA.settings[shopId][field];
  return shop ? (shop[field] || '') : '';
}
function setShopSetting(shopId, field, value) {
  if (!DATA.settings[shopId]) DATA.settings[shopId] = {};
  DATA.settings[shopId][field] = value;
  saveData();
}
function getMultiLoginSetting(shopId, idx, field) {
  const key = `multiLogin_${idx}_${field}`;
  if (DATA.settings[shopId] && DATA.settings[shopId][key] !== undefined) return DATA.settings[shopId][key];
  return null;
}
function setMultiLoginSetting(shopId, idx, field, value) {
  if (!DATA.settings[shopId]) DATA.settings[shopId] = {};
  DATA.settings[shopId][`multiLogin_${idx}_${field}`] = value;
  saveData();
}
function togglePwMulti(shopId, idx, pw) {
  const el = document.getElementById(`pw_${shopId}_${idx}`);
  const icon = document.getElementById(`pwIcon_${shopId}_${idx}`);
  if (el.classList.contains('masked')) {
    el.textContent = pw;
    el.classList.remove('masked');
    icon.textContent = 'visibility_off';
  } else {
    el.textContent = '••••••••';
    el.classList.add('masked');
    icon.textContent = 'visibility';
  }
}
function isCompleted(month, shopId) {
  return DATA.completed[month] && DATA.completed[month].includes(shopId);
}
function toggleCompleted(month, shopId) {
  if (!DATA.completed[month]) DATA.completed[month] = [];
  const idx = DATA.completed[month].indexOf(shopId);
  if (idx >= 0) DATA.completed[month].splice(idx, 1);
  else DATA.completed[month].push(shopId);
  saveData();
}

async function init() {
  /* URL 파라미터 확인 (?view=dashboard) */
  const urlParams = new URLSearchParams(window.location.search);
  const viewMode = urlParams.get('view');
  const isDashboardOnly = viewMode === 'dashboard';

  /* JSON 파일에서 데이터 자동 로드 시도 */
  await loadDataFromFile();

  /* 저장된 업로드 파일 데이터 복원 */
  restoreUploadFiles();

  const now = new Date();
  document.getElementById('headerDate').textContent = now.getFullYear() + '.' + String(now.getMonth()+1).padStart(2,'0') + '.' + String(now.getDate()).padStart(2,'0');
  const sel = document.getElementById('monthSelect');
  for (let m = 1; m <= 12; m++) {
    const opt = document.createElement('option');
    opt.value = m; opt.textContent = m + '월';
    sel.appendChild(opt);
  }
  sel.value = currentMonth;

  /* 대시보드 전용 모드 */
  if (isDashboardOnly) {
    document.getElementById('headerTitle').textContent = `온라인 매출 대시보드 — ${currentMonth}월`;
    document.querySelector('.side-nav').style.display = 'none';
    document.querySelector('.nav-tabs').style.display = 'none';
    document.querySelector('.main-content').style.padding = '22px 40px 70px';
    switchTab('sales');
  } else {
    document.getElementById('headerTitle').textContent = `온라인 확정매출·집계 — ${currentMonth}월`;
    loadShopOrder(); /* 저장된 쇼핑몰 순서 불러오기 */
    renderSidebar();
    renderShopContents();
    /* 매출현황 탭을 기본으로 표시 */
    switchTab('sales');
  }
  updateDashboard();
}

/* 저장된 업로드 파일 복원 */
function restoreUploadFiles() {
  const monthKey = currentYear + '-' + String(currentMonth).padStart(2,'0');
  if (DATA.uploadFiles && DATA.uploadFiles[monthKey]) {
    Object.assign(UPLOAD_FILES, DATA.uploadFiles[monthKey]);
    console.log(`[${monthKey}] 업로드 데이터 복원됨:`, Object.keys(UPLOAD_FILES).length + '개 파일');
  }
}

function changeMonth(m) {
  /* 현재 월의 업로드 데이터를 저장 */
  const oldMonthKey = currentYear + '-' + String(currentMonth).padStart(2,'0');
  if (Object.keys(UPLOAD_FILES).length > 0) {
    if (!DATA.uploadFiles) DATA.uploadFiles = {};
    DATA.uploadFiles[oldMonthKey] = JSON.parse(JSON.stringify(UPLOAD_FILES));
    saveData();
  }

  /* 월 변경 */
  currentMonth = parseInt(m);
  document.getElementById('headerTitle').textContent = `온라인 확정매출·집계 — ${currentMonth}월`;

  /* 새 월의 업로드 데이터 복원 */
  Object.keys(UPLOAD_FILES).forEach(k => delete UPLOAD_FILES[k]); /* 기존 데이터 클리어 */
  restoreUploadFiles();

  renderSidebar();
  renderShopContents(); /* 업로드 상태 반영을 위해 다시 렌더링 */
  updateDashboard();
  if (currentShop) selectShop(currentShop);
}

function renderSidebar() {
  const nav = document.getElementById('navList');
  nav.innerHTML = '';
  const pourTitle = document.createElement('div');
  pourTitle.className = 'nav-section-title pour-title';
  pourTitle.innerHTML = '<span class="dot sky"></span> 포어';
  nav.appendChild(pourTitle);
  SHOPS.filter(s => s.group === 'pour').forEach(s => nav.appendChild(createNavItem(s, 'pour')));
  const bothTitle = document.createElement('div');
  bothTitle.className = 'nav-section-title both-title';
  bothTitle.innerHTML = '<span class="dot pink"></span> 포어 + 그로홈';
  nav.appendChild(bothTitle);
  SHOPS.filter(s => s.group === 'both').forEach(s => nav.appendChild(createNavItem(s, 'both')));
  const groTitle = document.createElement('div');
  groTitle.className = 'nav-section-title gro-title';
  groTitle.innerHTML = '<span class="dot lavender"></span> 그로홈';
  nav.appendChild(groTitle);
  SHOPS.filter(s => s.group === 'grohome').forEach(s => nav.appendChild(createNavItem(s, 'grohome')));
  const moyeoraTitle = document.createElement('div');
  moyeoraTitle.className = 'nav-section-title moyeora-title';
  moyeoraTitle.innerHTML = '<span class="dot teal"></span> 모여라딜';
  nav.appendChild(moyeoraTitle);
  SHOPS.filter(s => s.group === 'moyeora').forEach(s => nav.appendChild(createNavItem(s, 'moyeora')));
  /* 데이터 취합 항목 */
  const mergeItem = document.createElement('div');
  mergeItem.className = 'nav-item merge-nav';
  mergeItem.dataset.view = 'merge';
  mergeItem.style.cssText = 'margin-top:12px;background:rgba(0,0,0,0.02);border-top:1px solid var(--gray-light);color:var(--text-muted);';
  mergeItem.innerHTML = '<span class="material-symbols-outlined" style="font-size:14px;opacity:0.6;">merge_type</span> 데이터 취합<span class="nav-dot"></span>';
  mergeItem.onclick = function() {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    mergeItem.classList.add('active');
    document.querySelectorAll('.shop-content').forEach(el => el.classList.remove('active'));
    showMergeOnlyView();
  };
  nav.appendChild(mergeItem);
  /* 하단 안내 문구 */
  const hint = document.createElement('div');
  hint.className = 'nav-drag-hint';
  hint.textContent = '드래그앤드롭으로 순서 변경 가능';
  nav.appendChild(hint);
}

function filterShops(query) {
  const q = query.trim().toLowerCase();
  document.querySelectorAll('.nav-item').forEach(el => {
    const name = el.textContent.toLowerCase();
    const shop = SHOPS.find(s => s.id === el.dataset.shopId);
    const fullName = shop ? shop.name.toLowerCase() : '';
    el.classList.toggle('hidden', q !== '' && !name.includes(q) && !fullName.includes(q));
  });
}

let currentTab = 'sales';
let vatMode = 'minus'; /* 기본값 V- */
let salesViewMode = 'dashboard'; /* 'byShop', 'byBrand', 'dashboard' */
let selectedBrand = 'grohome'; /* 'grohome', 'pourstore', 'moyeora' */
let dashboardBrand = 'all'; /* 'all', 'grohome', 'pourstore', 'moyeora' */
let dashboardViewMonth = 0; /* 0 = TOTAL, 1~12 = 월별 */
let dashboardNetMode = 'net'; /* 'net' = 순매출(기본), 'gross' = 총매출 */
/* 기본값: 전월 (1월이면 12월) */
(function() { const d = new Date(); const m = d.getMonth(); dashboardViewMonth = m === 0 ? 12 : m; })();
function setVatMode(mode) {
  vatMode = mode;
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
}
function toggleVatMode() {
  vatMode = vatMode === 'plus' ? 'minus' : 'plus';
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
}
function switchDashboardViewMonth(dir) {
  if (dir === 'total') { dashboardViewMonth = 0; }
  else if (dir === 'prev') { dashboardViewMonth = dashboardViewMonth <= 1 ? 12 : dashboardViewMonth - 1; }
  else if (dir === 'next') { dashboardViewMonth = dashboardViewMonth >= 12 ? 1 : dashboardViewMonth + 1; }
  else if (typeof dir === 'number') { dashboardViewMonth = dir; }
  renderSalesOverview();
}
function switchTab(tab) {
  currentTab = tab;
  document.getElementById('tabShops').classList.toggle('active', tab === 'shops');
  document.getElementById('tabSales').classList.toggle('active', tab === 'sales');
  document.getElementById('viewShops').style.display = tab === 'shops' ? '' : 'none';
  document.getElementById('viewSales').style.display = tab === 'sales' ? '' : 'none';
  /* 데이터 취합 전용 뷰 숨김 */
  const mergeOnly = document.getElementById('viewMergeOnly');
  if (mergeOnly) mergeOnly.style.display = 'none';
  if (tab === 'sales') { renderSalesOverview(); updateMergeAllStatus(); renderKeywordTable(); }
}
/* 데이터 취합 전용 뷰 */
function showMergeOnlyView() {
  currentTab = 'merge';
  document.getElementById('tabShops').classList.remove('active');
  document.getElementById('tabSales').classList.remove('active');
  document.getElementById('viewShops').style.display = 'none';
  document.getElementById('viewSales').style.display = 'none';
  document.getElementById('viewMergeOnly').style.display = 'block';
  updateMergeAllStatus();
}

/* 정렬 상태 변수 */
let salesSortCol = null; /* null, 1~12(월), 'total'(합계) */
let salesSortAsc = false; /* false: 내림차순, true: 오름차순 */

/* 쇼핑몰 표시명 (사이드바와 동일) */
function getShopDisplayName(shop) {
  return shop.group === 'both' ? shop.name : shop.name.replace('포어_', '').replace('그로홈_', '');
}

/* 자사몰 그룹 정의 */
const JASANG_GROUPS = {
  'pourstore': { label: '포어스토어몰', shopIds: ['pour_kg', 'both_naver_pour'] },
  'grohome': { label: '그로홈몰', shopIds: ['gro_cafe24', 'both_naver_gro', 'gro_toss_pay'] }
};
/* 자사몰 결제수단별 라벨 */
const JASANG_LABELS = {
  'pour_kg': 'KG',
  'both_naver_pour': '네이버페이',
  'gro_cafe24': '카페24',
  'both_naver_gro': '네이버페이',
  'gro_toss_pay': '토스'
};
/* 쿠팡 그룹 (자사몰처럼 합계 + 하위 표시) */
const COUPANG_GROUP = {
  id: 'coupang_group',
  label: '쿠팡',
  children: [
    { slotId: 'pour_coupang_0', label: '중개(위탁)' },
    { slotId: 'pour_coupang_1', label: '로켓그로스' }
  ]
};
/* 모여라딜 그룹 (그로홈/모여라딜 분류별 표시) */
const MOYEORA_GROUP = {
  id: 'moyeora_group',
  label: '모여라딜',
  children: [
    { slotId: 'moyeora_grohome', label: '모여라딜_그로홈', category: 'grohome' },
    { slotId: 'pour_offline_moyeora_grohome', label: '계좌입금_그로홈', category: 'grohome' },
    { slotId: 'moyeora_moyeora', label: '모여라딜_중개', category: 'jungae' },
    { slotId: 'pour_offline_moyeora_jungae', label: '계좌입금_중개', category: 'jungae' }
  ]
};
/* 계좌입금 그룹 (브랜드별 하위 표시 - 모여라딜 제외) */
const OFFLINE_GROUP = {
  id: 'offline_group',
  label: '계좌입금 매출',
  children: [
    { slotId: 'pour_offline_grohome', label: '그로홈' },
    { slotId: 'pour_offline_pourstore', label: '포어스토어' }
  ]
};
/* 자사몰 확장 상태 (기본: 펼침 true, 모여라딜은 접힘 false) */
let jasangExpanded = { pourstore: true, grohome: true, coupang_group: true, moyeora_group: false, offline_group: false, brand_moyeora_group: false, brand_moyeora_grohome: true, brand_moyeora_jungae: true, brand_coupang_group: true };
/* 모여라딜 금액 조정 모드 */
let moyeoraEditMode = false;

/* 기본 정렬 순서 */
const DEFAULT_SHOP_DISPLAY_ORDER = [
  'grohome',      /* 그로홈 (자사몰) */
  'pourstore',    /* 포어스토어 (자사몰) */
  'coupang_group', /* 쿠팡 (합계 + 중개/로켓그로스) */
  'pour_domegook',/* 도매꾹 */
  'both_smart_gro',/* 스마트스토어_그로홈 */
  'both_smart_pour',/* 스마트스토어_포어 */
  'pour_gmarket', /* 지마켓 */
  'gro_kakao',    /* 카카오 톡체크아웃 */
  'moyeora_group', /* 모여라딜 (그로홈/모여라딜) */
  'pour_bucket',  /* 오늘의집 */
  'gro_kakaotalk',/* 카카오 톡스토어 */
  'pour_navimro', /* 나비엠알오 */
  'pour_11st',    /* 11번가 */
  'pour_auction', /* 옥션 */
  'gro_toss_shop',/* 토스쇼핑 */
  'offline_group'  /* 계좌입금 (맨 아래) */
];
/* 사용자 정의 순서 (localStorage에서 불러오기) */
let SHOP_DISPLAY_ORDER = (function() {
  try {
    const saved = localStorage.getItem('salesShopOrder');
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return [...DEFAULT_SHOP_DISPLAY_ORDER];
})();
/* 순서 편집 모드 */
let salesOrderEditMode = false;
let salesDraggedShopId = null;

/* 검색 debounce */
let salesSearchTimeout = null;
function debouncedSalesSearch(value) {
  clearTimeout(salesSearchTimeout);
  salesSearchTimeout = setTimeout(() => {
    const input = document.getElementById('salesSearch');
    const cursorPos = input ? input.selectionStart : 0;
    renderSalesOverview(value);
    const newInput = document.getElementById('salesSearch');
    if (newInput) {
      newInput.focus();
      newInput.setSelectionRange(cursorPos, cursorPos);
    }
  }, 150);
}

function renderSalesOverview(filterQuery, skipToolbar) {
  const container = document.getElementById('salesOverview');
  const q = (filterQuery || '').trim().toLowerCase();
  const isVatMinus = vatMode === 'minus';
  const fmt = v => isVatMinus ? Math.round(v / 1.1) : v;

  /* 상위 탭 UI (대시보드 / 상세내역) + 하위 탭 (쇼핑몰별/브랜드별) */
  const isDetail = (salesViewMode === 'byShop' || salesViewMode === 'byBrand');
  let html = `<div class="sales-view-tabs">
    <button class="sales-view-tab ${salesViewMode === 'dashboard' ? 'active' : ''}" onclick="switchSalesViewMode('dashboard')">대시보드</button>
    <button class="sales-view-tab ${isDetail ? 'active' : ''}" onclick="switchSalesViewMode('${isDetail ? salesViewMode : 'byShop'}')">상세내역</button>
  </div>`;
  if (isDetail) {
    html += `<div class="sales-view-subtabs">
      <button class="sales-view-subtab ${salesViewMode === 'byShop' ? 'active' : ''}" onclick="switchSalesViewMode('byShop')">쇼핑몰별</button>
      <button class="sales-view-subtab ${salesViewMode === 'byBrand' ? 'active' : ''}" onclick="switchSalesViewMode('byBrand')">브랜드별</button>
    </div>`;
  }

  if (salesViewMode === 'dashboard') {
    /* 대시보드 보기 */
    html += renderDashboardContent(fmt);
    container.innerHTML = html;
    /* 브랜드 탭에서 첫 번째 쇼핑몰 차트 자동 로드 */
    setTimeout(function() {
      const chartEl = document.getElementById('inlineShopChart');
      if (chartEl && chartEl.dataset.firstShop) {
        selectShopForChart(chartEl.dataset.firstShop, chartEl.dataset.firstName || '');
      }
    }, 50);
    return;
  }

  if (salesViewMode === 'byBrand') {
    /* 브랜드별 보기 */
    html += renderBrandView(q, fmt);
    container.innerHTML = html;
    return;
  }

  /* 쇼핑몰별 보기 (기존 로직) */
  /* 자사몰에 속한 shopId 목록 */
  const jasangShopIds = new Set([...JASANG_GROUPS.pourstore.shopIds, ...JASANG_GROUPS.grohome.shopIds]);

  /* 일반 쇼핑몰 (자사몰, 쿠팡, 모여라딜 제외) */
  const normalShops = SHOPS.filter(s => !jasangShopIds.has(s.id) && s.id !== 'pour_coupang' && s.id !== 'moyeora_cafe24' && s.id !== 'pour_offline');
  const filtered = q ? normalShops.filter(s => s.name.toLowerCase().includes(q) || getShopDisplayName(s).toLowerCase().includes(q)) : normalShops;

  /* 쇼핑몰별 데이터 계산 */
  const shopData = filtered.map(shop => {
    const monthVals = [];
    let total = 0;
    for (let m = 1; m <= 12; m++) {
      const raw = (DATA.sales && DATA.sales[m] && DATA.sales[m][shop.id]) ? Number(DATA.sales[m][shop.id]) : 0;
      const val = fmt(raw);
      monthVals.push(val);
      total += val;
    }
    return { shop, shopId: shop.id, displayName: getShopDisplayName(shop), monthVals, total, isJasang: false };
  });

  /* 쿠팡 그룹 데이터 (자사몰처럼 합계 + 하위) */
  const coupangGroupData = (function() {
    const monthVals = new Array(12).fill(0);
    let total = 0;
    const children = [];
    COUPANG_GROUP.children.forEach(child => {
      const childMonths = [];
      let childTotal = 0;
      for (let m = 1; m <= 12; m++) {
        const raw = (DATA.sales && DATA.sales[m] && DATA.sales[m][child.slotId]) ? Number(DATA.sales[m][child.slotId]) : 0;
        const val = fmt(raw);
        childMonths.push(val);
        monthVals[m - 1] += val;
        childTotal += val;
      }
      total += childTotal;
      children.push({ slotId: child.slotId, label: child.label, monthVals: childMonths, total: childTotal });
    });
    return { groupId: COUPANG_GROUP.id, shopId: COUPANG_GROUP.id, displayName: COUPANG_GROUP.label, monthVals, total, isCoupangGroup: true, children };
  })();
  /* 쿠팡 검색 필터 */
  const filteredCoupang = (!q || COUPANG_GROUP.label.toLowerCase().includes(q)) ? [coupangGroupData] : [];

  /* 모여라딜 그룹 데이터 (그로홈/모여라딜 분류별) */
  const moyeoraGroupData = (function() {
    const monthVals = new Array(12).fill(0);
    let total = 0;
    const children = [];
    /* 쇼핑몰별에서는 moyeora_grohome 제외 (브랜드별 모여라 탭에서만 표시) */
    const shopViewChildren = MOYEORA_GROUP.children.filter(c => c.slotId !== 'moyeora_grohome');
    shopViewChildren.forEach(child => {
      const childMonths = [];
      let childTotal = 0;
      for (let m = 1; m <= 12; m++) {
        let raw = (DATA.sales && DATA.sales[m] && DATA.sales[m][child.slotId]) ? Number(DATA.sales[m][child.slotId]) : 0;
        /* 분류별 데이터 없으면 기존 moyeora_cafe24 금액을 모여라딜로 사용 */
        if (raw === 0 && child.slotId === 'moyeora_moyeora') {
          const legacyVal = (DATA.sales && DATA.sales[m] && DATA.sales[m]['moyeora_cafe24']) ? Number(DATA.sales[m]['moyeora_cafe24']) : 0;
          const grohomeVal = (DATA.sales && DATA.sales[m] && DATA.sales[m]['moyeora_grohome']) ? Number(DATA.sales[m]['moyeora_grohome']) : 0;
          if (legacyVal > 0 && grohomeVal === 0) raw = legacyVal;
        }
        const val = fmt(raw);
        childMonths.push(val);
        monthVals[m - 1] += val;
        childTotal += val;
      }
      total += childTotal;
      children.push({ slotId: child.slotId, label: child.label, category: child.category, monthVals: childMonths, total: childTotal });
    });
    return { groupId: MOYEORA_GROUP.id, shopId: MOYEORA_GROUP.id, displayName: MOYEORA_GROUP.label, monthVals, total, isMoyeoraGroup: true, children };
  })();
  /* 모여라딜 검색 필터 */
  const filteredMoyeora = (!q || MOYEORA_GROUP.label.toLowerCase().includes(q)) ? [moyeoraGroupData] : [];

  /* 계좌입금 그룹 데이터 (브랜드별 하위) */
  const offlineGroupData = (function() {
    const monthVals = new Array(12).fill(0);
    let total = 0;
    const children = [];
    OFFLINE_GROUP.children.forEach(child => {
      const childMonths = [];
      let childTotal = 0;
      for (let m = 1; m <= 12; m++) {
        const raw = (DATA.sales && DATA.sales[m] && DATA.sales[m][child.slotId]) ? Number(DATA.sales[m][child.slotId]) : 0;
        const val = fmt(raw);
        childMonths.push(val);
        monthVals[m - 1] += val;
        childTotal += val;
      }
      total += childTotal;
      children.push({ slotId: child.slotId, label: child.label, monthVals: childMonths, total: childTotal });
    });
    return { groupId: OFFLINE_GROUP.id, shopId: OFFLINE_GROUP.id, displayName: OFFLINE_GROUP.label, monthVals, total, isOfflineGroup: true, children };
  })();
  const filteredOffline = (!q || OFFLINE_GROUP.label.toLowerCase().includes(q)) ? [offlineGroupData] : [];

  /* 자사몰 그룹 데이터 계산 */
  const jasangData = Object.entries(JASANG_GROUPS).map(([groupId, group]) => {
    const monthVals = new Array(12).fill(0);
    let total = 0;
    const children = [];
    group.shopIds.forEach(shopId => {
      const childMonths = [];
      let childTotal = 0;
      for (let m = 1; m <= 12; m++) {
        const raw = (DATA.sales && DATA.sales[m] && DATA.sales[m][shopId]) ? Number(DATA.sales[m][shopId]) : 0;
        const val = fmt(raw);
        childMonths.push(val);
        monthVals[m - 1] += val;
        childTotal += val;
      }
      total += childTotal;
      children.push({ shopId, label: JASANG_LABELS[shopId], monthVals: childMonths, total: childTotal });
    });
    return { groupId, shopId: groupId, displayName: group.label, monthVals, total, isJasang: true, children };
  });

  /* 자사몰도 검색에 포함 */
  const filteredJasang = q ? jasangData.filter(j => j.displayName.toLowerCase().includes(q) || j.children.some(c => c.label.toLowerCase().includes(q))) : jasangData;

  /* 전체 데이터 합치기 (자사몰 + 쿠팡그룹 + 모여라딜그룹 + 계좌입금그룹 + 일반) */
  const allData = [...filteredJasang, ...filteredCoupang, ...filteredMoyeora, ...filteredOffline, ...shopData];

  /* 정렬 적용 */
  if (salesSortCol !== null) {
    allData.sort((a, b) => {
      let valA, valB;
      if (salesSortCol === 'total') {
        valA = a.total; valB = b.total;
      } else {
        valA = a.monthVals[salesSortCol - 1]; valB = b.monthVals[salesSortCol - 1];
      }
      return salesSortAsc ? valA - valB : valB - valA;
    });
  } else {
    /* 기본 정렬 순서 적용 */
    allData.sort((a, b) => {
      const idxA = SHOP_DISPLAY_ORDER.indexOf(a.shopId);
      const idxB = SHOP_DISPLAY_ORDER.indexOf(b.shopId);
      const orderA = idxA >= 0 ? idxA : 999;
      const orderB = idxB >= 0 ? idxB : 999;
      return orderA - orderB;
    });
  }

  html += `<div class="sales-toolbar">
    <div class="nav-search"><input type="text" id="salesSearch" placeholder="쇼핑몰 검색..." oninput="debouncedSalesSearch(this.value)" value="${filterQuery || ''}"></div>
    <button class="btn-download" onclick="downloadSalesOverviewExcel()"><span class="material-symbols-outlined">download</span>엑셀</button>
    <button class="btn-order-edit ${salesOrderEditMode ? 'active' : ''}" onclick="toggleSalesOrderEdit()" title="순서 편집">edit</button>
  </div>`;

  const sortIcon = (col) => {
    if (salesSortCol !== col) return '<span class="sort-icon">⇅</span>';
    return salesSortAsc ? '<span class="sort-icon active">↑</span>' : '<span class="sort-icon active">↓</span>';
  };
  const vatLabel = vatMode === 'plus' ? 'V+' : 'V-';

  html += '<div class="sales-table-wrap"><table class="sales-table"><thead><tr><th>쇼핑몰</th>';
  for (let m = 1; m <= 12; m++) html += `<th class="sortable" onclick="sortSalesTable(${m})">${m}월 ${sortIcon(m)}</th>`;
  html += `<th class="sortable vat-toggle" onclick="toggleVatMode()" title="클릭하여 VAT 전환">합계(${vatLabel}) ${sortIcon('total')}</th></tr></thead><tbody>`;

  const grandTotals = new Array(12).fill(0);
  let grandTotal = 0;

  allData.forEach((item, rowIdx) => {
    const dragAttrs = salesOrderEditMode ? `draggable="true" ondragstart="handleSalesRowDragStart(event,'${item.shopId}')" ondragover="handleSalesRowDragOver(event)" ondrop="handleSalesRowDrop(event,'${item.shopId}')" ondragend="handleSalesRowDragEnd()"` : '';
    if (item.isJasang) {
      /* 자사몰 그룹 행 - 일반 쇼핑몰과 동일 스타일 */
      const expanded = jasangExpanded[item.groupId];
      html += `<tr class="jasang-group ${expanded ? 'expanded' : ''} ${salesOrderEditMode ? 'order-edit-mode' : ''}" ${dragAttrs}>
        <td style="cursor:pointer;" onclick="toggleJasangExpand('${item.groupId}')">
          ${salesOrderEditMode ? '<span class="drag-handle material-symbols-outlined" style="font-size:14px;color:var(--gray);cursor:grab;margin-right:4px;">drag_indicator</span>' : ''}${item.displayName} <span style="font-size:0.6rem;color:#b0b0b0;margin-left:2px;">${expanded ? '▾' : '▸'}</span>
        </td>`;
      item.monthVals.forEach((val, idx) => {
        grandTotals[idx] += val;
        html += `<td class="${val ? '' : 'empty'}">${val ? val.toLocaleString() : '-'}</td>`;
      });
      grandTotal += item.total;
      html += `<td>${item.total ? item.total.toLocaleString() : '-'}</td></tr>`;

      /* 자사몰 하위 결제수단 행 (확장 시에만 표시) */
      if (expanded) {
        item.children.forEach((child, childIdx) => {
          const childDragAttrs = salesOrderEditMode ? `draggable="true" ondragstart="handleJasangChildDragStart(event,'${item.groupId}',${childIdx})" ondragover="handleJasangChildDragOver(event)" ondrop="handleJasangChildDrop(event,'${item.groupId}',${childIdx})" ondragend="handleJasangChildDragEnd()"` : '';
          html += `<tr class="jasang-child ${salesOrderEditMode ? 'order-edit-mode' : ''}" ${childDragAttrs}><td style="font-size:0.72rem;">${salesOrderEditMode ? '<span class="drag-handle material-symbols-outlined" style="font-size:12px;color:#aaa;cursor:grab;margin-right:4px;">drag_indicator</span>' : ''}└ ${child.label}</td>`;
          child.monthVals.forEach(val => {
            html += `<td class="${val ? '' : 'empty'}" style="font-size:0.72rem;">${val ? val.toLocaleString() : '-'}</td>`;
          });
          html += `<td style="font-size:0.72rem;">${child.total ? child.total.toLocaleString() : '-'}</td></tr>`;
        });
      }
    } else if (item.isCoupangGroup) {
      /* 쿠팡 그룹 행 (자사몰처럼 합계 + 하위) */
      const expanded = jasangExpanded[item.groupId];
      html += `<tr class="jasang-group ${expanded ? 'expanded' : ''} ${salesOrderEditMode ? 'order-edit-mode' : ''}" ${dragAttrs}>
        <td style="cursor:pointer;" onclick="toggleJasangExpand('${item.groupId}')">
          ${salesOrderEditMode ? '<span class="drag-handle material-symbols-outlined" style="font-size:14px;color:var(--gray);cursor:grab;margin-right:4px;">drag_indicator</span>' : ''}${item.displayName} <span style="font-size:0.6rem;color:#b0b0b0;margin-left:2px;">${expanded ? '▾' : '▸'}</span>
        </td>`;
      item.monthVals.forEach((val, idx) => {
        grandTotals[idx] += val;
        html += `<td class="${val ? '' : 'empty'}">${val ? val.toLocaleString() : '-'}</td>`;
      });
      grandTotal += item.total;
      html += `<td>${item.total ? item.total.toLocaleString() : '-'}</td></tr>`;

      /* 쿠팡 하위 행 (확장 시에만 표시) */
      if (expanded) {
        item.children.forEach((child, childIdx) => {
          const coupangChildDragAttrs = salesOrderEditMode ? `draggable="true" ondragstart="handleCoupangChildDragStart(event,${childIdx})" ondragover="handleCoupangChildDragOver(event)" ondrop="handleCoupangChildDrop(event,${childIdx})" ondragend="handleCoupangChildDragEnd()"` : '';
          html += `<tr class="jasang-child ${salesOrderEditMode ? 'order-edit-mode' : ''}" ${coupangChildDragAttrs}><td style="font-size:0.72rem;">${salesOrderEditMode ? '<span class="drag-handle material-symbols-outlined" style="font-size:14px;color:var(--gray);cursor:grab;margin-right:4px;">drag_indicator</span>' : ''}└ ${child.label}</td>`;
          child.monthVals.forEach(val => {
            html += `<td class="${val ? '' : 'empty'}" style="font-size:0.72rem;">${val ? val.toLocaleString() : '-'}</td>`;
          });
          html += `<td style="font-size:0.72rem;">${child.total ? child.total.toLocaleString() : '-'}</td></tr>`;
        });
      }
    } else if (item.isMoyeoraGroup) {
      /* 모여라딜 행 - 총액만 표시 (상세내역은 브랜드별 모여라 탭에서 확인) */
      /* 순액조정값 */
      const deductVals = [];
      let deductSum = 0;
      for (let dm = 0; dm < 12; dm++) { const d = getMoyeoraDeduct(dm + 1); deductVals.push(d); deductSum += d; }
      /* 모여라딜 합계 = 총매출 - 순액조정 */
      const adjMonths = item.monthVals.map((v, i) => v - deductVals[i]);
      const adjTotal = item.total - deductSum;

      html += `<tr class="${salesOrderEditMode ? 'order-edit-mode' : ''}" ${dragAttrs}>
        <td>
          ${salesOrderEditMode ? '<span class="drag-handle material-symbols-outlined" style="font-size:14px;color:var(--gray);cursor:grab;margin-right:4px;">drag_indicator</span>' : ''}${item.displayName}${deductSum ? ' <span style="font-size:0.62rem;color:#94a3b8;font-weight:400;">(순액조정 반영)</span>' : ''}
        </td>`;
      adjMonths.forEach((val, idx) => {
        grandTotals[idx] += val;
        html += `<td class="${val ? '' : 'empty'}">${val ? val.toLocaleString() : '-'}</td>`;
      });
      grandTotal += adjTotal;
      html += `<td>${adjTotal ? adjTotal.toLocaleString() : '-'}</td></tr>`;
    } else if (item.isOfflineGroup) {
      /* 계좌입금 그룹 행 (브랜드별 하위) */
      const expanded = jasangExpanded[item.groupId];
      html += `<tr class="jasang-group ${expanded ? 'expanded' : ''} ${salesOrderEditMode ? 'order-edit-mode' : ''}" ${dragAttrs}>
        <td style="cursor:pointer;" onclick="toggleJasangExpand('${item.groupId}')">
          ${salesOrderEditMode ? '<span class="drag-handle material-symbols-outlined" style="font-size:14px;color:var(--gray);cursor:grab;margin-right:4px;">drag_indicator</span>' : ''}${item.displayName} <span style="font-size:0.6rem;color:#b0b0b0;margin-left:2px;">${expanded ? '▾' : '▸'}</span>
        </td>`;
      item.monthVals.forEach((val, idx) => {
        grandTotals[idx] += val;
        html += `<td class="${val ? '' : 'empty'}">${val ? val.toLocaleString() : '-'}</td>`;
      });
      grandTotal += item.total;
      html += `<td>${item.total ? item.total.toLocaleString() : '-'}</td></tr>`;

      if (expanded) {
        item.children.forEach(child => {
          html += `<tr class="jasang-child"><td style="font-size:0.72rem;">└ ${child.label}</td>`;
          child.monthVals.forEach(val => {
            html += `<td class="${val ? '' : 'empty'}" style="font-size:0.72rem;">${val ? val.toLocaleString() : '-'}</td>`;
          });
          html += `<td style="font-size:0.72rem;">${child.total ? child.total.toLocaleString() : '-'}</td></tr>`;
        });
      }
    } else {
      /* 일반 쇼핑몰 행 */
      html += `<tr class="${salesOrderEditMode ? 'order-edit-mode' : ''}" ${dragAttrs}><td>${salesOrderEditMode ? '<span class="drag-handle material-symbols-outlined" style="font-size:14px;color:var(--gray);cursor:grab;margin-right:4px;">drag_indicator</span>' : ''}${item.displayName}</td>`;
      item.monthVals.forEach((val, idx) => {
        grandTotals[idx] += val;
        html += `<td class="${val ? '' : 'empty'}">${val ? val.toLocaleString() : '-'}</td>`;
      });
      grandTotal += item.total;
      html += `<td>${item.total ? item.total.toLocaleString() : '-'}</td></tr>`;
    }
  });

  html += '</tbody><tfoot><tr><td>합계</td>';
  for (let m = 0; m < 12; m++) html += `<td>${grandTotals[m] ? grandTotals[m].toLocaleString() : '-'}</td>`;
  html += `<td>${grandTotal ? grandTotal.toLocaleString() : '-'}</td></tr></tfoot></table></div>`;

  /* 브랜드별 합계 검증 (개발용) */
  const verifyData = getBrandVerifyData(fmt);
  const verifyTotal = verifyData.grohome + verifyData.pourstore + verifyData.moyeora;
  const isMatch = Math.abs(grandTotal - verifyTotal) < 10;
  html += `<div style="margin-top:20px;padding:12px;background:rgba(0,0,0,0.02);border-radius:8px;font-size:0.65rem;color:#888;opacity:0.6;">
    <div style="margin-bottom:4px;">🔍 브랜드별 검증 (${vatMode === 'minus' ? 'V-' : 'V+'})</div>
    <div>그로홈: ${verifyData.grohome.toLocaleString()} | 포어: ${verifyData.pourstore.toLocaleString()} | 모여라딜: ${verifyData.moyeora.toLocaleString()}</div>
    <div>브랜드합: ${verifyTotal.toLocaleString()} | 테이블합: ${grandTotal.toLocaleString()} | ${isMatch ? '✓ 일치' : '✗ 불일치 (' + (grandTotal - verifyTotal).toLocaleString() + ')'}</div>
  </div>`;

  container.innerHTML = html;
}

/* 브랜드별 합계 검증 데이터 */
function getBrandVerifyData(fmt) {
  const grohomeIds = ['gro_cafe24','both_naver_gro','gro_toss_pay','both_smart_gro','gro_kakao','gro_kakaotalk','gro_toss_shop','moyeora_grohome','pour_bucket','pour_offline_grohome'];
  const pourstoreIds = ['pour_kg','both_naver_pour','both_smart_pour','pour_navimro','pour_coupang_0','pour_coupang_1','pour_gmarket','pour_domegook','pour_11st','pour_auction','pour_offline_pourstore'];

  let grohome = 0, pourstore = 0, moyeora = 0;

  for (let m = 1; m <= 12; m++) {
    if (!DATA.sales || !DATA.sales[m]) continue;
    const sales = DATA.sales[m];

    grohomeIds.forEach(id => { grohome += fmt(Number(sales[id]) || 0); });
    pourstoreIds.forEach(id => { pourstore += fmt(Number(sales[id]) || 0); });

    const moyeoraVal = fmt(Number(sales['moyeora_moyeora']) || Number(sales['moyeora_cafe24']) || 0);
    moyeora += moyeoraVal;
    /* 계좌입금 모여라딜 분 (분리 슬롯 → fallback 합계 슬롯) */
    const offMoyGh = Number(sales['pour_offline_moyeora_grohome']) || 0;
    const offMoyJg = Number(sales['pour_offline_moyeora_jungae']) || 0;
    const offMoyTotal = offMoyGh + offMoyJg > 0 ? offMoyGh + offMoyJg : (Number(sales['pour_offline_moyeora']) || 0);
    moyeora += fmt(offMoyTotal);
    /* 순액조정 차감 */
    moyeora -= getMoyeoraDeduct(m);
  }

  return { grohome, pourstore, moyeora };
}

/* 쇼핑몰별/브랜드별/대시보드 보기 전환 */
function switchSalesViewMode(mode) {
  salesViewMode = mode;
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
}

/* 대시보드 브랜드 탭 전환 */
function switchDashboardBrand(brand) {
  dashboardBrand = brand;
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
}

/* 순매출/총매출 전환 */
function switchDashboardNetMode(mode) {
  dashboardNetMode = mode;
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
}

/* 브랜드 선택 */
function selectBrand(brand) {
  selectedBrand = brand;
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
}

/* 브랜드별 보기 렌더링 */
function renderBrandView(q, fmt) {
  const vatLabel = vatMode === 'plus' ? 'V+' : 'V-';

  let html = `<div class="brand-select-tabs">
    <button class="brand-select-tab grohome ${selectedBrand === 'grohome' ? 'active' : ''}" onclick="selectBrand('grohome')">그로홈</button>
    <button class="brand-select-tab pourstore ${selectedBrand === 'pourstore' ? 'active' : ''}" onclick="selectBrand('pourstore')">포어스토어</button>
    <button class="brand-select-tab moyeora ${selectedBrand === 'moyeora' ? 'active' : ''}" onclick="selectBrand('moyeora')">모여라딜</button>
  </div>`;

  html += `<div class="sales-toolbar">
    <div class="nav-search"><input type="text" id="salesSearch" placeholder="쇼핑몰 검색..." oninput="debouncedSalesSearch(this.value)" value="${q || ''}"></div>
  </div>`;

  /* 브랜드별 쇼핑몰 매출 데이터 계산 (자사몰 하위그룹 포함) */
  const brandSalesData = getBrandSalesDataWithGroups(selectedBrand, fmt);

  /* 검색 필터 */
  let filteredData = q ? brandSalesData.filter(d => d.shopName.toLowerCase().includes(q) || (d.children && d.children.some(c => c.shopName.toLowerCase().includes(q)))) : [...brandSalesData];

  /* 정렬 적용 */
  if (salesSortCol !== null) {
    filteredData.sort((a, b) => {
      let valA, valB;
      if (salesSortCol === 'total') {
        valA = a.total; valB = b.total;
      } else {
        valA = a.monthVals[salesSortCol - 1]; valB = b.monthVals[salesSortCol - 1];
      }
      return salesSortAsc ? valA - valB : valB - valA;
    });
  }

  const sortIcon = (col) => {
    if (salesSortCol !== col) return '<span class="sort-icon">⇅</span>';
    return salesSortAsc ? '<span class="sort-icon active">↑</span>' : '<span class="sort-icon active">↓</span>';
  };

  html += '<div class="sales-table-wrap"><table class="sales-table"><thead><tr><th>쇼핑몰</th>';
  for (let m = 1; m <= 12; m++) html += `<th class="sortable" onclick="sortSalesTable(${m})">${m}월 ${sortIcon(m)}</th>`;
  html += `<th class="sortable vat-toggle" onclick="toggleVatMode()" title="클릭하여 VAT 전환">합계(${vatLabel}) ${sortIcon('total')}</th></tr></thead><tbody>`;

  const grandTotals = new Array(12).fill(0);
  let grandTotal = 0;

  /* 모여라딜 브랜드: 그로홈 / 중개매출 2개 그룹으로 렌더링 */
  if (selectedBrand === 'moyeora') {
    /* MOYEORA_GROUP children에서 매출 데이터 생성 */
    const moyChildren = MOYEORA_GROUP.children.map(child => {
      const monthVals = new Array(12).fill(0);
      let total = 0;
      for (let m = 1; m <= 12; m++) {
        const sales = DATA.sales && DATA.sales[m];
        let raw = sales ? (Number(sales[child.slotId]) || 0) : 0;
        /* legacy fallback: moyeora_moyeora → moyeora_cafe24 - moyeora_grohome */
        if (raw === 0 && child.slotId === 'moyeora_moyeora' && sales) {
          const legacyVal = Number(sales['moyeora_cafe24']) || 0;
          const grohomeVal = Number(sales['moyeora_grohome']) || 0;
          if (legacyVal > 0 && grohomeVal === 0) raw = legacyVal;
          else if (legacyVal > 0) raw = Math.max(legacyVal - grohomeVal, 0);
        }
        /* legacy fallback: pour_offline_moyeora_jungae → pour_offline_moyeora 전체 */
        if (raw === 0 && child.slotId === 'pour_offline_moyeora_jungae' && sales) {
          const legacyTotal = Number(sales['pour_offline_moyeora']) || 0;
          const ghPart = Number(sales['pour_offline_moyeora_grohome']) || 0;
          if (legacyTotal > 0 && ghPart === 0) raw = legacyTotal;
        }
        const val = fmt(raw);
        monthVals[m - 1] = val;
        total += val;
      }
      return { slotId: child.slotId, label: child.label, category: child.category, monthVals, total };
    });

    /* 카테고리별 분류 */
    const grohomeChildren = moyChildren.filter(c => c.category === 'grohome');
    const jungaeChildren = moyChildren.filter(c => c.category === 'jungae');

    /* 순액조정값 (중개매출에만 적용) */
    const deductVals = [];
    let deductSum = 0;
    for (let dm = 0; dm < 12; dm++) { const d = getMoyeoraDeduct(dm + 1); deductVals.push(d); deductSum += d; }

    /* ── 그로홈 그룹 ── */
    const ghExpanded = jasangExpanded['brand_moyeora_grohome'] !== false;
    const ghMonths = new Array(12).fill(0);
    let ghTotal = 0;
    grohomeChildren.forEach(c => { c.monthVals.forEach((v, i) => ghMonths[i] += v); ghTotal += c.total; });

    html += `<tr class="jasang-group ${ghExpanded ? 'expanded' : ''}">
      <td style="cursor:pointer;" onclick="toggleJasangExpand('brand_moyeora_grohome')">
        그로홈 <span style="font-size:0.6rem;color:#b0b0b0;margin-left:2px;">${ghExpanded ? '▾' : '▸'}</span>
      </td>`;
    ghMonths.forEach((val, i) => {
      html += `<td class="${val ? '' : 'empty'}">${val ? val.toLocaleString() : '-'}</td>`;
      grandTotals[i] += val;
    });
    grandTotal += ghTotal;
    html += `<td>${ghTotal ? ghTotal.toLocaleString() : '-'}</td></tr>`;

    if (ghExpanded) {
      grohomeChildren.forEach(child => {
        html += `<tr class="jasang-child"><td style="font-size:0.72rem;">└ ${child.label}</td>`;
        child.monthVals.forEach(val => {
          html += `<td class="${val ? '' : 'empty'}" style="font-size:0.72rem;">${val ? val.toLocaleString() : '-'}</td>`;
        });
        html += `<td style="font-size:0.72rem;">${child.total ? child.total.toLocaleString() : '-'}</td></tr>`;
      });
    }

    /* ── 중개매출 그룹 ── */
    const jgExpanded = jasangExpanded['brand_moyeora_jungae'] !== false;
    const jgMonths = new Array(12).fill(0);
    let jgTotal = 0;
    jungaeChildren.forEach(c => { c.monthVals.forEach((v, i) => jgMonths[i] += v); jgTotal += c.total; });
    /* 순액조정 반영 합계 */
    const adjJgMonths = jgMonths.map((v, i) => v - deductVals[i]);
    const adjJgTotal = jgTotal - deductSum;

    html += `<tr class="jasang-group ${jgExpanded ? 'expanded' : ''}">
      <td style="cursor:pointer;">
        <span onclick="toggleJasangExpand('brand_moyeora_jungae')">중개매출 <span style="font-size:0.6rem;color:#b0b0b0;margin-left:2px;">${jgExpanded ? '▾' : '▸'}</span></span>${deductSum ? ' <span style="font-size:0.62rem;color:#94a3b8;font-weight:400;">(순액조정 반영)</span>' : ''}
      </td>`;
    adjJgMonths.forEach((val, i) => {
      html += `<td class="${val ? '' : 'empty'}">${val ? val.toLocaleString() : '-'}</td>`;
      grandTotals[i] += val;
    });
    grandTotal += adjJgTotal;
    html += `<td>${adjJgTotal ? adjJgTotal.toLocaleString() : '-'}</td></tr>`;

    if (jgExpanded) {
      jungaeChildren.forEach(child => {
        html += `<tr class="jasang-child"><td style="font-size:0.72rem;">└ ${child.label}</td>`;
        child.monthVals.forEach(val => {
          html += `<td class="${val ? '' : 'empty'}" style="font-size:0.72rem;">${val ? val.toLocaleString() : '-'}</td>`;
        });
        html += `<td style="font-size:0.72rem;">${child.total ? child.total.toLocaleString() : '-'}</td></tr>`;
      });
      /* 순액조정 행 + EDIT 버튼 */
      html += `<tr class="jasang-child" style="background:#fff5f5;"><td style="font-size:0.72rem;color:#dc2626;font-weight:600;">└ 순액조정 <button onclick="event.stopPropagation();openMoyeoraDeductPopup()" style="font-size:0.55rem;padding:1px 4px;border:1px solid #fca5a5;border-radius:3px;background:#fef2f2;color:#dc2626;cursor:pointer;margin-left:4px;vertical-align:middle;">EDIT</button></td>`;
      deductVals.forEach(dv => {
        html += `<td style="color:#dc2626;font-size:0.72rem;">${dv ? '-' + dv.toLocaleString() : '-'}</td>`;
      });
      html += `<td style="color:#dc2626;font-size:0.72rem;font-weight:600;">${deductSum ? '-' + deductSum.toLocaleString() : '-'}</td></tr>`;
    }
  }

  filteredData.forEach(item => {
    if (item.isGroup) {
      /* 자사몰 그룹 행 - 쇼핑몰별과 동일한 스타일 */
      const expanded = jasangExpanded[item.groupId] !== false;
      html += `<tr class="jasang-group ${expanded ? 'expanded' : ''}">
        <td style="cursor:pointer;" onclick="toggleJasangExpand('${item.groupId}')">
          ${item.shopName} <span style="font-size:0.6rem;color:#b0b0b0;margin-left:2px;">${expanded ? '▾' : '▸'}</span>
        </td>`;
      item.monthVals.forEach((val, i) => {
        html += `<td class="${val ? '' : 'empty'}">${val ? val.toLocaleString() : '-'}</td>`;
        grandTotals[i] += val;
      });
      grandTotal += item.total;
      html += `<td>${item.total ? item.total.toLocaleString() : '-'}</td></tr>`;

      /* 하위 항목 - 쇼핑몰별과 동일한 스타일 */
      if (expanded && item.children) {
        item.children.forEach(child => {
          html += `<tr class="jasang-child"><td style="font-size:0.72rem;">└ ${child.shopName}</td>`;
          child.monthVals.forEach(val => {
            html += `<td class="${val ? '' : 'empty'}" style="font-size:0.72rem;">${val ? val.toLocaleString() : '-'}</td>`;
          });
          html += `<td style="font-size:0.72rem;">${child.total ? child.total.toLocaleString() : '-'}</td></tr>`;
        });
      }
    } else {
      /* 일반 쇼핑몰 */
      html += `<tr><td>${item.shopName}</td>`;
      item.monthVals.forEach((val, i) => {
        html += `<td class="${val ? '' : 'empty'}">${val ? val.toLocaleString() : '-'}</td>`;
        grandTotals[i] += val;
      });
      grandTotal += item.total;
      html += `<td>${item.total ? item.total.toLocaleString() : '-'}</td></tr>`;
    }
  });

  html += '</tbody><tfoot><tr><td>합계</td>';
  for (let m = 0; m < 12; m++) html += `<td>${grandTotals[m] ? grandTotals[m].toLocaleString() : '-'}</td>`;
  html += `<td>${grandTotal ? grandTotal.toLocaleString() : '-'}</td></tr>`;

  html += '</tfoot></table></div>';

  return html;
}

/* 브랜드별 쇼핑몰 매출 데이터 (자사몰 하위그룹 포함) */
function getBrandSalesDataWithGroups(brand, fmt) {
  const results = [];
  /* 모여라딜 브랜드: 상세내역은 renderBrandView에서 MOYEORA_GROUP 기반으로 직접 렌더링하므로 빈 결과 반환 */
  if (brand === 'moyeora') return results;

  const shopSalesMap = {}; /* shopName → {monthVals, total, groupId, isChild} */

  /* 자사몰 그룹 정의 (브랜드별 보기용) */
  const jasangGroups = {
    grohome: { id: 'brand_grohome_jasang', label: '그로홈몰', shopIds: JASANG_GROUPS.grohome.shopIds },
    pourstore: { id: 'brand_pourstore_jasang', label: '포어스토어몰', shopIds: JASANG_GROUPS.pourstore.shopIds }
  };

  /* 모든 쇼핑몰의 로우데이터를 조회하여 브랜드별 매출 계산 */
  SHOPS.forEach(shop => {
    if (!SHOP_MAPPINGS[shop.id]) return;
    const dataPaths = getShopSetting(shop.id, 'dataPaths');
    if (!dataPaths || !Array.isArray(dataPaths)) return;

    /* subTabs 처리 */
    if (shop.subTabs && shop.subTabs.length > 0) {
      shop.subTabs.forEach(t => {
        const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shop.id, i, t.id)]);
        if (!allUploaded) return;
        const result = executeMerge(shop.id, true, t.id);
        if (result && result.rows.length > 0) {
          aggregateBrandSalesWithGroup(result, t.label || shop.name, shop.id, brand, fmt, shopSalesMap, jasangGroups);
        }
      });
    } else {
      const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shop.id, i)]);
      if (!allUploaded) return;
      const result = executeMerge(shop.id, true);
      if (result && result.rows.length > 0) {
        /* 쿠팡: 쇼핑몰 컬럼 기반으로 중개/로켓그로스 분리 집계 */
        if (shop.id === 'pour_coupang') {
          aggregateCoupangBrandSales(result, brand, fmt, shopSalesMap);
        } else {
          aggregateBrandSalesWithGroup(result, shop.name, shop.id, brand, fmt, shopSalesMap, jasangGroups);
        }
      }
    }
  });

  /* 계좌입금 슬롯 데이터 기반 브랜드별 반영 (로우데이터 없어도 DATA.sales에서 가져옴) */
  if (brand === 'moyeora') {
    /* 모여라딜: MOYEORA_GROUP children에서 계좌입금 슬롯 데이터를 가져와 isMoyeoraGroup으로 전달 */
    /* (별도 그룹 구성은 renderBrandView에서 처리) */
  } else {
    const offlineSlotMap = {
      grohome: 'pour_offline_grohome',
      pourstore: 'pour_offline_pourstore'
    };
    const offlineSlotId = offlineSlotMap[brand];
    if (offlineSlotId) {
      const offLabel = '계좌입금 매출';
      let hasData = false;
      const offMonths = new Array(12).fill(0);
      let offTotal = 0;
      for (let m = 1; m <= 12; m++) {
        const raw = (DATA.sales && DATA.sales[m] && DATA.sales[m][offlineSlotId]) ? Number(DATA.sales[m][offlineSlotId]) : 0;
        if (raw > 0) hasData = true;
        const val = fmt(raw);
        offMonths[m - 1] = val;
        offTotal += val;
      }
      if (hasData && !shopSalesMap[offLabel]) {
        shopSalesMap[offLabel] = { monthVals: offMonths, total: offTotal, groupId: null };
      }
    }
  }

  /* 그룹 라벨 매핑 (자사몰 + 쿠팡) */
  const groupLabelMap = {};
  Object.values(jasangGroups).forEach(g => { groupLabelMap[g.id] = g.label; });
  groupLabelMap['brand_coupang_group'] = '쿠팡';

  /* 자사몰/쿠팡 그룹 생성 */
  const groupData = {};
  Object.entries(shopSalesMap).forEach(([shopName, data]) => {
    if (data.groupId) {
      if (!groupData[data.groupId]) {
        groupData[data.groupId] = {
          shopName: groupLabelMap[data.groupId] || data.groupId,
          groupId: data.groupId,
          isGroup: true,
          monthVals: new Array(12).fill(0),
          total: 0,
          children: []
        };
      }
      groupData[data.groupId].children.push({ shopName, monthVals: data.monthVals, total: data.total });
      data.monthVals.forEach((v, i) => groupData[data.groupId].monthVals[i] += v);
      groupData[data.groupId].total += data.total;
    } else {
      results.push({ shopName, monthVals: data.monthVals, total: data.total, isGroup: false });
    }
  });

  /* 그룹 데이터 추가 */
  Object.values(groupData).forEach(g => {
    g.children.sort((a, b) => b.total - a.total);
    results.unshift(g); /* 상단에 추가 */
  });

  /* 일반 쇼핑몰 합계 내림차순 정렬 */
  const groups = results.filter(r => r.isGroup);
  const normals = results.filter(r => !r.isGroup).sort((a, b) => b.total - a.total);
  return [...groups, ...normals];
}

/* 로우데이터에서 브랜드별 매출 집계 (자사몰 그룹 구분) */
function aggregateBrandSalesWithGroup(result, shopName, shopId, targetBrand, fmt, shopSalesMap, jasangGroups) {
  const brandIdx = result.headers.indexOf('브랜드');
  const amtIdx = result.headers.indexOf('매출금액(v+)');
  const monthIdx = result.headers.indexOf('매출월');

  if (brandIdx < 0 || amtIdx < 0) return;

  const brandMatch = targetBrand === 'grohome' ? '그로홈' :
                     targetBrand === 'pourstore' ? '포어스토어' : '모여라딜';

  /* 자사몰 그룹 ID 확인 */
  let groupId = null;
  Object.entries(jasangGroups).forEach(([key, group]) => {
    if (group.shopIds.includes(shopId)) groupId = group.id;
  });

  result.rows.forEach(row => {
    const brand = String(row[brandIdx] || '').trim();
    if (brand !== brandMatch) return;

    const amt = Number(String(row[amtIdx] || 0).replace(/,/g, '')) || 0;
    if (amt === 0) return;

    let month = currentMonth;
    if (monthIdx >= 0) {
      const monthVal = String(row[monthIdx] || '');
      const m = monthVal.match(/(\d{4})-(\d{2})/);
      if (m) month = parseInt(m[2]);
    }

    if (!shopSalesMap[shopName]) {
      shopSalesMap[shopName] = { monthVals: new Array(12).fill(0), total: 0, groupId };
    }
    const val = fmt(amt);
    shopSalesMap[shopName].monthVals[month - 1] += val;
    shopSalesMap[shopName].total += val;
  });
}

/* 쿠팡: 브랜드별 보기에서 쇼핑몰 컬럼 기반으로 중개/로켓그로스 분리 집계 */
function aggregateCoupangBrandSales(result, targetBrand, fmt, shopSalesMap) {
  const brandIdx = result.headers.indexOf('브랜드');
  const amtIdx = result.headers.indexOf('매출금액(v+)');
  const monthIdx = result.headers.indexOf('매출월');
  const shopColIdx = result.headers.indexOf('쇼핑몰');

  if (brandIdx < 0 || amtIdx < 0) return;

  const brandMatch = targetBrand === 'grohome' ? '그로홈' :
                     targetBrand === 'pourstore' ? '포어스토어' : '모여라딜';

  result.rows.forEach(row => {
    const brand = String(row[brandIdx] || '').trim();
    if (brand !== brandMatch) return;

    const amt = Number(String(row[amtIdx] || 0).replace(/,/g, '')) || 0;
    if (amt === 0) return;

    let month = currentMonth;
    if (monthIdx >= 0) {
      const monthVal = String(row[monthIdx] || '');
      const m = monthVal.match(/(\d{4})-(\d{2})/);
      if (m) month = parseInt(m[2]);
    }

    /* 쇼핑몰 컬럼으로 중개/로켓그로스 구분 */
    const shopCol = shopColIdx >= 0 ? String(row[shopColIdx] || '').trim() : '';
    const isRocket = shopCol.includes('로켓그로스');
    const childName = isRocket ? '쿠팡_로켓그로스' : '쿠팡';

    if (!shopSalesMap[childName]) {
      shopSalesMap[childName] = { monthVals: new Array(12).fill(0), total: 0, groupId: 'brand_coupang_group' };
    }
    const val = fmt(amt);
    shopSalesMap[childName].monthVals[month - 1] += val;
    shopSalesMap[childName].total += val;
  });
}

/* 자사몰 확장/축소 토글 */
function toggleJasangExpand(groupId) {
  jasangExpanded[groupId] = !jasangExpanded[groupId];
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
}

/* 모여라딜 금액 조정 토글 */
function toggleMoyeoraEdit() {
  moyeoraEditMode = !moyeoraEditMode;
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
}

/* 모여라딜 금액 차감 저장 (단일 월) */
function saveMoyeoraDeduct() {
  const input = document.getElementById('moyeoraDeductInput');
  const deduct = Math.abs(parseInt(input.value) || 0);
  if (!DATA.moyeoraDeduct) DATA.moyeoraDeduct = {};
  DATA.moyeoraDeduct[currentMonth] = deduct;
  saveData();
  moyeoraEditMode = false;
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
  showToast(`모여라딜 ${currentMonth}월 차감 저장: -${deduct.toLocaleString()}원`);
}

/* 모여라딜 순액조정 저장 (월별 개별) */
function saveMoyeoraNetAdj(month) {
  const input = document.getElementById('moyeoraNetAdj_' + month);
  if (!input) return;
  const val = Math.abs(parseInt(String(input.value).replace(/,/g, '')) || 0);
  if (!DATA.moyeoraDeduct) DATA.moyeoraDeduct = {};
  DATA.moyeoraDeduct[month] = val;
  saveData();
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
  showToast(`모여라딜 ${month}월 순액조정: -${val.toLocaleString()}원`);
}

/* 모여라딜 순액조정 팝업 */
function openMoyeoraDeductPopup() {
  let rows = '';
  for (let m = 1; m <= 12; m++) {
    const val = getMoyeoraDeduct(m);
    rows += `<tr>
      <td style="padding:6px 10px;font-weight:600;font-size:0.82rem;border-bottom:1px solid #f1f5f9;">${m}월</td>
      <td style="padding:6px 4px;border-bottom:1px solid #f1f5f9;">
        <input id="moyeoraPopAdj_${m}" type="text" value="${val || ''}" placeholder="0"
          style="width:100%;text-align:right;border:1px solid #e2e8f0;border-radius:5px;padding:5px 8px;font-size:0.82rem;box-sizing:border-box;">
      </td>
    </tr>`;
  }
  const html = `
    <div id="moyeoraDeductModal" style="display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);z-index:9999;justify-content:center;align-items:center;" onclick="if(event.target===this)closeMoyeoraDeductPopup()">
      <div style="background:white;border-radius:12px;width:320px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.15);">
        <div style="padding:14px 18px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:700;font-size:0.95rem;">모여라딜 순액조정</div>
          <button onclick="closeMoyeoraDeductPopup()" style="background:none;border:none;cursor:pointer;padding:2px;">
            <span class="material-symbols-outlined" style="font-size:22px;color:#94a3b8;">close</span>
          </button>
        </div>
        <div style="padding:12px 18px;overflow-y:auto;flex:1;">
          <div style="font-size:0.72rem;color:#94a3b8;margin-bottom:8px;">중개매출 합계에서 차감됩니다</div>
          <table style="width:100%;border-collapse:collapse;">
            <thead><tr>
              <th style="text-align:left;padding:6px 10px;font-size:0.75rem;color:#64748b;border-bottom:2px solid #e2e8f0;">월</th>
              <th style="text-align:right;padding:6px 10px;font-size:0.75rem;color:#64748b;border-bottom:2px solid #e2e8f0;">순액조정(원)</th>
            </tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
        <div style="padding:12px 18px;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:8px;">
          <button onclick="closeMoyeoraDeductPopup()" style="padding:7px 14px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;font-size:0.8rem;">취소</button>
          <button onclick="saveMoyeoraDeductPopup()" style="padding:7px 14px;border:none;background:var(--sky);color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.8rem;">저장</button>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}
function closeMoyeoraDeductPopup() {
  const modal = document.getElementById('moyeoraDeductModal');
  if (modal) modal.remove();
}
function saveMoyeoraDeductPopup() {
  if (!DATA.moyeoraDeduct) DATA.moyeoraDeduct = {};
  let changed = 0;
  for (let m = 1; m <= 12; m++) {
    const input = document.getElementById('moyeoraPopAdj_' + m);
    if (!input) continue;
    const val = Math.abs(parseInt(String(input.value).replace(/,/g, '')) || 0);
    DATA.moyeoraDeduct[m] = val;
    if (val) changed++;
  }
  saveData();
  closeMoyeoraDeductPopup();
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
  showToast('모여라딜 순액조정 저장완료 (' + changed + '개월)');
}

/* 모여라딜 순액조정값 가져오기 */
function getMoyeoraDeduct(month) {
  if (!DATA.moyeoraDeduct) return 0;
  return Number(DATA.moyeoraDeduct[month]) || 0;
}

/* 모여라딜 순매출 계산 (총매출 - 순액조정) */
function getMoyeoraNetSales(month, fmt) {
  const sales = DATA.sales && DATA.sales[month];
  if (!sales) return 0;
  const moyeoraVal = Number(sales['moyeora_moyeora']) || Number(sales['moyeora_cafe24']) || 0;
  const grohomeVal = Number(sales['moyeora_grohome']) || 0;
  const gross = fmt(moyeoraVal + grohomeVal);
  const deduct = getMoyeoraDeduct(month);
  return gross - deduct;
}

/* 매출현황 표 엑셀 다운로드 (쇼핑몰별 + 브랜드별 통합) */
function downloadSalesOverviewExcel() {
  const jasangShopIds = new Set([...JASANG_GROUPS.pourstore.shopIds, ...JASANG_GROUPS.grohome.shopIds]);
  const headers = ['쇼핑몰'];
  for (let m = 1; m <= 12; m++) headers.push(m + '월');
  headers.push('합계');

  /* 쇼핑몰별 데이터 생성 */
  function buildShopData(isVatMinus) {
    const fmt = v => isVatMinus ? Math.round(v / 1.1) : v;
    const rows = [];
    const grandTotals = new Array(12).fill(0);
    let grandTotal = 0;

    const normalShops = SHOPS.filter(s => !jasangShopIds.has(s.id) && s.id !== 'pour_coupang' && s.id !== 'moyeora_cafe24' && s.id !== 'pour_offline');
    const shopData = normalShops.map(shop => {
      const monthVals = [];
      let total = 0;
      for (let m = 1; m <= 12; m++) {
        const raw = (DATA.sales && DATA.sales[m] && DATA.sales[m][shop.id]) ? Number(DATA.sales[m][shop.id]) : 0;
        const val = fmt(raw);
        monthVals.push(val);
        total += val;
      }
      return { shopId: shop.id, displayName: getShopDisplayName(shop), monthVals, total, isJasang: false };
    });

    const coupangGroupData = (function() {
      const monthVals = new Array(12).fill(0);
      let total = 0;
      const children = [];
      COUPANG_GROUP.children.forEach(child => {
        const childMonths = [];
        let childTotal = 0;
        for (let m = 1; m <= 12; m++) {
          const raw = (DATA.sales && DATA.sales[m] && DATA.sales[m][child.slotId]) ? Number(DATA.sales[m][child.slotId]) : 0;
          const val = fmt(raw);
          childMonths.push(val);
          monthVals[m - 1] += val;
          childTotal += val;
        }
        total += childTotal;
        children.push({ slotId: child.slotId, label: child.label, monthVals: childMonths, total: childTotal });
      });
      return { groupId: COUPANG_GROUP.id, shopId: COUPANG_GROUP.id, displayName: COUPANG_GROUP.label, monthVals, total, isCoupangGroup: true, children };
    })();

    const moyeoraGroupData = (function() {
      const monthVals = new Array(12).fill(0);
      let total = 0;
      const children = [];
      MOYEORA_GROUP.children.forEach(child => {
        const childMonths = [];
        let childTotal = 0;
        for (let m = 1; m <= 12; m++) {
          let raw = (DATA.sales && DATA.sales[m] && DATA.sales[m][child.slotId]) ? Number(DATA.sales[m][child.slotId]) : 0;
          if (raw === 0 && child.slotId === 'moyeora_moyeora') {
            raw = (DATA.sales && DATA.sales[m] && DATA.sales[m]['moyeora_cafe24']) ? Number(DATA.sales[m]['moyeora_cafe24']) : 0;
          }
          const val = fmt(raw);
          childMonths.push(val);
          monthVals[m - 1] += val;
          childTotal += val;
        }
        total += childTotal;
        children.push({ slotId: child.slotId, label: child.label, monthVals: childMonths, total: childTotal });
      });
      return { groupId: MOYEORA_GROUP.id, shopId: MOYEORA_GROUP.id, displayName: MOYEORA_GROUP.label, monthVals, total, isMoyeoraGroup: true, children };
    })();

    const offlineGroupData = (function() {
      const monthVals = new Array(12).fill(0);
      let total = 0;
      const children = [];
      OFFLINE_GROUP.children.forEach(child => {
        const childMonths = [];
        let childTotal = 0;
        for (let m = 1; m <= 12; m++) {
          const raw = (DATA.sales && DATA.sales[m] && DATA.sales[m][child.slotId]) ? Number(DATA.sales[m][child.slotId]) : 0;
          const val = fmt(raw);
          childMonths.push(val);
          monthVals[m - 1] += val;
          childTotal += val;
        }
        total += childTotal;
        children.push({ slotId: child.slotId, label: child.label, monthVals: childMonths, total: childTotal });
      });
      return { groupId: OFFLINE_GROUP.id, shopId: OFFLINE_GROUP.id, displayName: OFFLINE_GROUP.label, monthVals, total, isOfflineGroup: true, children };
    })();

    const jasangData = Object.entries(JASANG_GROUPS).map(([groupId, group]) => {
      const monthVals = new Array(12).fill(0);
      let total = 0;
      const children = [];
      group.shopIds.forEach(shopId => {
        const childMonths = [];
        let childTotal = 0;
        for (let m = 1; m <= 12; m++) {
          const raw = (DATA.sales && DATA.sales[m] && DATA.sales[m][shopId]) ? Number(DATA.sales[m][shopId]) : 0;
          const val = fmt(raw);
          childMonths.push(val);
          monthVals[m - 1] += val;
          childTotal += val;
        }
        total += childTotal;
        children.push({ shopId, label: JASANG_LABELS[shopId], monthVals: childMonths, total: childTotal });
      });
      return { groupId, shopId: groupId, displayName: group.label, monthVals, total, isJasang: true, children };
    });

    const allData = [...jasangData, coupangGroupData, moyeoraGroupData, offlineGroupData, ...shopData];
    allData.sort((a, b) => {
      const idxA = SHOP_DISPLAY_ORDER.indexOf(a.shopId);
      const idxB = SHOP_DISPLAY_ORDER.indexOf(b.shopId);
      return (idxA >= 0 ? idxA : 999) - (idxB >= 0 ? idxB : 999);
    });

    allData.forEach(item => {
      if (item.isJasang || item.isCoupangGroup || item.isMoyeoraGroup || item.isOfflineGroup) {
        item.children.forEach(child => {
          const childName = item.displayName + '_' + child.label;
          rows.push([childName, ...child.monthVals, child.total]);
          child.monthVals.forEach((v, i) => grandTotals[i] += v);
          grandTotal += child.total;
        });
      } else {
        rows.push([item.displayName, ...item.monthVals, item.total]);
        item.monthVals.forEach((v, i) => grandTotals[i] += v);
        grandTotal += item.total;
      }
    });
    rows.push(['합계', ...grandTotals, grandTotal]);
    return rows;
  }

  /* 브랜드별 데이터 생성 */
  function buildBrandData(brand, isVatMinus) {
    const fmt = v => isVatMinus ? Math.round(v / 1.1) : v;
    const rows = [];
    const grandTotals = new Array(12).fill(0);
    let grandTotal = 0;

    /* 모여라딜: MOYEORA_GROUP 기반 그로홈/중개 데이터 직접 생성 */
    if (brand === 'moyeora') {
      MOYEORA_GROUP.children.forEach(child => {
        const mv = new Array(12).fill(0);
        let t = 0;
        for (let m = 1; m <= 12; m++) {
          const sales = DATA.sales && DATA.sales[m];
          let raw = sales ? (Number(sales[child.slotId]) || 0) : 0;
          if (raw === 0 && child.slotId === 'moyeora_moyeora' && sales) {
            const lv = Number(sales['moyeora_cafe24']) || 0;
            const gv = Number(sales['moyeora_grohome']) || 0;
            if (lv > 0 && gv === 0) raw = lv; else if (lv > 0) raw = Math.max(lv - gv, 0);
          }
          if (raw === 0 && child.slotId === 'pour_offline_moyeora_jungae' && sales) {
            const lt = Number(sales['pour_offline_moyeora']) || 0;
            const gp = Number(sales['pour_offline_moyeora_grohome']) || 0;
            if (lt > 0 && gp === 0) raw = lt;
          }
          const val = fmt(raw);
          mv[m - 1] = val; t += val;
        }
        rows.push([child.label, ...mv, t]);
        mv.forEach((v, i) => grandTotals[i] += v);
        grandTotal += t;
      });
      /* 순액조정 행 */
      const deductRow = new Array(12).fill(0);
      let deductTotal = 0;
      for (let dm = 0; dm < 12; dm++) { const d = getMoyeoraDeduct(dm + 1); deductRow[dm] = -d; deductTotal -= d; }
      rows.push(['순액조정', ...deductRow, deductTotal]);
      deductRow.forEach((v, i) => grandTotals[i] += v);
      grandTotal += deductTotal;
    } else {
      const brandData = getBrandSalesDataWithGroups(brand, fmt);
      brandData.forEach(item => {
        if (item.isGroup) {
          item.children.forEach(child => {
            const childName = item.shopName + '_' + child.shopName;
            rows.push([childName, ...child.monthVals, child.total]);
            child.monthVals.forEach((v, i) => grandTotals[i] += v);
            grandTotal += child.total;
          });
        } else {
          rows.push([item.shopName, ...item.monthVals, item.total]);
          item.monthVals.forEach((v, i) => grandTotals[i] += v);
          grandTotal += item.total;
        }
      });
    }
    rows.push(['합계', ...grandTotals, grandTotal]);
    return rows;
  }

  const wb = XLSX.utils.book_new();

  /* 시트1: V+ (쇼핑몰별 + 브랜드별) */
  const wsDataPlus = [];
  wsDataPlus.push(['【 쇼핑몰별 매출 】']);
  wsDataPlus.push(headers);
  buildShopData(false).forEach(r => wsDataPlus.push(r));
  wsDataPlus.push([]);
  wsDataPlus.push(['【 그로홈 브랜드 - 쇼핑몰별 매출 】']);
  wsDataPlus.push(headers);
  buildBrandData('grohome', false).forEach(r => wsDataPlus.push(r));
  wsDataPlus.push([]);
  wsDataPlus.push(['【 포어스토어 브랜드 - 쇼핑몰별 매출 】']);
  wsDataPlus.push(headers);
  buildBrandData('pourstore', false).forEach(r => wsDataPlus.push(r));
  wsDataPlus.push([]);
  wsDataPlus.push(['【 모여라딜 브랜드 - 쇼핑몰별 매출 】']);
  wsDataPlus.push(headers);
  buildBrandData('moyeora', false).forEach(r => wsDataPlus.push(r));

  const wsPlus = XLSX.utils.aoa_to_sheet(wsDataPlus);
  wsPlus['!cols'] = [{ wch: 28 }];
  for (let i = 1; i <= 13; i++) wsPlus['!cols'].push({ wch: 12 });
  XLSX.utils.book_append_sheet(wb, wsPlus, 'VAT포함(V+)');

  /* 시트2: V- (쇼핑몰별 + 브랜드별) */
  const wsDataMinus = [];
  wsDataMinus.push(['【 쇼핑몰별 매출 】']);
  wsDataMinus.push(headers);
  buildShopData(true).forEach(r => wsDataMinus.push(r));
  wsDataMinus.push([]);
  wsDataMinus.push(['【 그로홈 브랜드 - 쇼핑몰별 매출 】']);
  wsDataMinus.push(headers);
  buildBrandData('grohome', true).forEach(r => wsDataMinus.push(r));
  wsDataMinus.push([]);
  wsDataMinus.push(['【 포어스토어 브랜드 - 쇼핑몰별 매출 】']);
  wsDataMinus.push(headers);
  buildBrandData('pourstore', true).forEach(r => wsDataMinus.push(r));
  wsDataMinus.push([]);
  wsDataMinus.push(['【 모여라딜 브랜드 - 쇼핑몰별 매출 】']);
  wsDataMinus.push(headers);
  buildBrandData('moyeora', true).forEach(r => wsDataMinus.push(r));

  const wsMinus = XLSX.utils.aoa_to_sheet(wsDataMinus);
  wsMinus['!cols'] = [{ wch: 28 }];
  for (let i = 1; i <= 13; i++) wsMinus['!cols'].push({ wch: 12 });
  XLSX.utils.book_append_sheet(wb, wsMinus, 'VAT제외(V-)');

  /* 시트3: 통합 (V+ → V- 위아래) */
  const wsDataAll = [];
  wsDataAll.push(['============ VAT 포함 (V+) ============']);
  wsDataAll.push([]);
  wsDataAll.push(['【 쇼핑몰별 매출 】']);
  wsDataAll.push(headers);
  buildShopData(false).forEach(r => wsDataAll.push(r));
  wsDataAll.push([]);
  wsDataAll.push(['【 그로홈 브랜드 】']);
  wsDataAll.push(headers);
  buildBrandData('grohome', false).forEach(r => wsDataAll.push(r));
  wsDataAll.push([]);
  wsDataAll.push(['【 포어스토어 브랜드 】']);
  wsDataAll.push(headers);
  buildBrandData('pourstore', false).forEach(r => wsDataAll.push(r));
  wsDataAll.push([]);
  wsDataAll.push(['【 모여라딜 브랜드 】']);
  wsDataAll.push(headers);
  buildBrandData('moyeora', false).forEach(r => wsDataAll.push(r));
  wsDataAll.push([]);
  wsDataAll.push([]);
  wsDataAll.push(['============ VAT 제외 (V-) ============']);
  wsDataAll.push([]);
  wsDataAll.push(['【 쇼핑몰별 매출 】']);
  wsDataAll.push(headers);
  buildShopData(true).forEach(r => wsDataAll.push(r));
  wsDataAll.push([]);
  wsDataAll.push(['【 그로홈 브랜드 】']);
  wsDataAll.push(headers);
  buildBrandData('grohome', true).forEach(r => wsDataAll.push(r));
  wsDataAll.push([]);
  wsDataAll.push(['【 포어스토어 브랜드 】']);
  wsDataAll.push(headers);
  buildBrandData('pourstore', true).forEach(r => wsDataAll.push(r));
  wsDataAll.push([]);
  wsDataAll.push(['【 모여라딜 브랜드 】']);
  wsDataAll.push(headers);
  buildBrandData('moyeora', true).forEach(r => wsDataAll.push(r));

  const wsAll = XLSX.utils.aoa_to_sheet(wsDataAll);
  wsAll['!cols'] = [{ wch: 28 }];
  for (let i = 1; i <= 13; i++) wsAll['!cols'].push({ wch: 12 });
  XLSX.utils.book_append_sheet(wb, wsAll, '통합');

  const fileName = `매출현황_${currentYear}년.xlsx`;
  XLSX.writeFile(wb, fileName);
  showToast('매출현황 엑셀 다운로드: ' + fileName);
}

/* 순서 편집 모드 토글 */
function toggleSalesOrderEdit() {
  salesOrderEditMode = !salesOrderEditMode;
  salesSortCol = null; /* 정렬 초기화 */
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
  if (salesOrderEditMode) {
    showToast('순서 편집 모드: 행을 드래그해서 순서를 변경하세요');
  }
}

/* 매출현황 테이블 드래그앤드롭 */
function handleSalesRowDragStart(e, shopId) {
  salesDraggedShopId = shopId;
  e.target.closest('tr').classList.add('dragging');
}
function handleSalesRowDragOver(e) {
  e.preventDefault();
  const tr = e.target.closest('tr');
  if (tr) tr.classList.add('drag-over');
}
function handleSalesRowDrop(e, targetShopId) {
  e.preventDefault();
  const tr = e.target.closest('tr');
  if (tr) tr.classList.remove('drag-over');
  if (!salesDraggedShopId || salesDraggedShopId === targetShopId) return;

  /* 순서 배열에서 위치 변경 */
  const fromIdx = SHOP_DISPLAY_ORDER.indexOf(salesDraggedShopId);
  const toIdx = SHOP_DISPLAY_ORDER.indexOf(targetShopId);
  if (fromIdx < 0) {
    /* 새 항목이면 추가 */
    SHOP_DISPLAY_ORDER.splice(toIdx, 0, salesDraggedShopId);
  } else {
    /* 기존 항목이면 이동 */
    SHOP_DISPLAY_ORDER.splice(fromIdx, 1);
    const newToIdx = SHOP_DISPLAY_ORDER.indexOf(targetShopId);
    SHOP_DISPLAY_ORDER.splice(newToIdx, 0, salesDraggedShopId);
  }
  /* 순서 저장 */
  localStorage.setItem('salesShopOrder', JSON.stringify(SHOP_DISPLAY_ORDER));
  salesDraggedShopId = null;
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
  showToast('순서가 저장되었습니다');
}
function handleSalesRowDragEnd() {
  salesDraggedShopId = null;
  document.querySelectorAll('.sales-table tr.dragging').forEach(tr => tr.classList.remove('dragging'));
  document.querySelectorAll('.sales-table tr.drag-over').forEach(tr => tr.classList.remove('drag-over'));
}

/* 자사몰 하위 행 드래그앤드롭 */
let jasangChildDragInfo = null;
function handleJasangChildDragStart(e, groupId, childIdx) {
  jasangChildDragInfo = { groupId, childIdx };
  e.target.closest('tr').classList.add('dragging');
}
function handleJasangChildDragOver(e) {
  e.preventDefault();
  const tr = e.target.closest('tr');
  if (tr) tr.classList.add('drag-over');
}
function handleJasangChildDrop(e, targetGroupId, targetChildIdx) {
  e.preventDefault();
  const tr = e.target.closest('tr');
  if (tr) tr.classList.remove('drag-over');
  if (!jasangChildDragInfo || jasangChildDragInfo.groupId !== targetGroupId) return;
  if (jasangChildDragInfo.childIdx === targetChildIdx) return;

  /* 순서 변경 */
  const group = JASANG_GROUPS[targetGroupId];
  const fromIdx = jasangChildDragInfo.childIdx;
  const toIdx = targetChildIdx;
  const [moved] = group.shopIds.splice(fromIdx, 1);
  group.shopIds.splice(toIdx, 0, moved);

  /* 저장 */
  if (!DATA.jasangChildOrder) DATA.jasangChildOrder = {};
  DATA.jasangChildOrder[targetGroupId] = [...group.shopIds];
  saveData();

  jasangChildDragInfo = null;
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
  showToast('순서가 저장되었습니다');
}
function handleJasangChildDragEnd() {
  jasangChildDragInfo = null;
  document.querySelectorAll('.sales-table tr.dragging').forEach(tr => tr.classList.remove('dragging'));
  document.querySelectorAll('.sales-table tr.drag-over').forEach(tr => tr.classList.remove('drag-over'));
}

/* 쿠팡 하위 행 드래그앤드롭 */
let coupangChildDragInfo = null;
function handleCoupangChildDragStart(e, childIdx) {
  coupangChildDragInfo = { childIdx };
  e.target.closest('tr').classList.add('dragging');
}
function handleCoupangChildDragOver(e) {
  e.preventDefault();
  const tr = e.target.closest('tr');
  if (tr) tr.classList.add('drag-over');
}
function handleCoupangChildDrop(e, targetChildIdx) {
  e.preventDefault();
  const tr = e.target.closest('tr');
  if (tr) tr.classList.remove('drag-over');
  if (!coupangChildDragInfo) return;
  if (coupangChildDragInfo.childIdx === targetChildIdx) return;

  /* 순서 변경 */
  const fromIdx = coupangChildDragInfo.childIdx;
  const toIdx = targetChildIdx;
  const [moved] = COUPANG_GROUP.children.splice(fromIdx, 1);
  COUPANG_GROUP.children.splice(toIdx, 0, moved);

  /* 저장 */
  if (!DATA.coupangChildOrder) DATA.coupangChildOrder = [];
  DATA.coupangChildOrder = COUPANG_GROUP.children.map(c => c.slotId);
  saveData();

  coupangChildDragInfo = null;
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
  showToast('쿠팡 순서가 저장되었습니다');
}
function handleCoupangChildDragEnd() {
  coupangChildDragInfo = null;
  document.querySelectorAll('.sales-table tr.dragging').forEach(tr => tr.classList.remove('dragging'));
  document.querySelectorAll('.sales-table tr.drag-over').forEach(tr => tr.classList.remove('drag-over'));
}

/* 모여라딜 하위 행 드래그앤드롭 */
let moyeoraChildDragInfo = null;
function handleMoyeoraChildDragStart(e, childIdx) {
  moyeoraChildDragInfo = { childIdx };
  e.target.closest('tr').classList.add('dragging');
}
function handleMoyeoraChildDragOver(e) {
  e.preventDefault();
  const tr = e.target.closest('tr');
  if (tr) tr.classList.add('drag-over');
}
function handleMoyeoraChildDrop(e, targetChildIdx) {
  e.preventDefault();
  const tr = e.target.closest('tr');
  if (tr) tr.classList.remove('drag-over');
  if (!moyeoraChildDragInfo) return;
  if (moyeoraChildDragInfo.childIdx === targetChildIdx) return;

  /* 순서 변경 */
  const fromIdx = moyeoraChildDragInfo.childIdx;
  const toIdx = targetChildIdx;
  const [moved] = MOYEORA_GROUP.children.splice(fromIdx, 1);
  MOYEORA_GROUP.children.splice(toIdx, 0, moved);

  /* 저장 */
  if (!DATA.moyeoraChildOrder) DATA.moyeoraChildOrder = [];
  DATA.moyeoraChildOrder = MOYEORA_GROUP.children.map(c => c.slotId);
  saveData();

  moyeoraChildDragInfo = null;
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
  showToast('모여라딜 순서가 저장되었습니다');
}
function handleMoyeoraChildDragEnd() {
  moyeoraChildDragInfo = null;
  document.querySelectorAll('.sales-table tr.dragging').forEach(tr => tr.classList.remove('dragging'));
  document.querySelectorAll('.sales-table tr.drag-over').forEach(tr => tr.classList.remove('drag-over'));
}

/* 정렬 순환: null(원래) → 'desc'(내림차순) → 'asc'(오름차순) → null(원래) */
function sortSalesTable(col) {
  if (salesSortCol === col) {
    if (salesSortAsc === false) {
      salesSortAsc = true; /* 내림차순 → 오름차순 */
    } else {
      salesSortCol = null; /* 오름차순 → 원래 상태 */
      salesSortAsc = false;
    }
  } else {
    salesSortCol = col;
    salesSortAsc = false; /* 새 열 클릭시 내림차순부터 */
  }
  const q = document.getElementById('salesSearch');
  renderSalesOverview(q ? q.value : '');
}

/* 매출현황에서 쇼핑몰 클릭 시 해당 쇼핑몰로 이동 */
function goToShop(shopId) {
  switchTab('shops');
  selectShop(shopId);
}

function createNavItem(shop, groupName) {
  const div = document.createElement('div');
  const done = shop.subTabs ? shop.subTabs.every(t => isCompleted(currentMonth, t.id)) : isCompleted(currentMonth, shop.id);
  div.className = 'nav-item' + (shop.group === 'grohome' ? ' grohome' : shop.group === 'both' ? ' both' : shop.group === 'moyeora' ? ' moyeora' : '') + (currentShop === shop.id ? ' active' : '') + (done ? ' completed' : '');
  div.dataset.shopId = shop.id;
  div.dataset.group = groupName;
  div.draggable = true;
  const displayName = shop.group === 'both' ? shop.name : shop.name.replace('포어_', '').replace('그로홈_', '');
  div.innerHTML = `<span>${displayName}</span><span class="nav-check material-symbols-outlined">check_circle</span><span class="nav-dot"></span>`;
  div.onclick = () => goToShop(shop.id);
  /* 드래그 이벤트 */
  div.ondragstart = (e) => handleDragStart(e, shop.id, groupName);
  div.ondragover = (e) => handleDragOver(e);
  div.ondrop = (e) => handleDrop(e, shop.id, groupName);
  div.ondragend = () => handleDragEnd();
  return div;
}

/* 드래그앤드롭 변수 */
let draggedShopId = null;
let draggedGroup = null;

function handleDragStart(e, shopId, group) {
  draggedShopId = shopId;
  draggedGroup = group;
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  const target = e.target.closest('.nav-item');
  if (target && !target.classList.contains('dragging')) {
    document.querySelectorAll('.nav-item.drag-over').forEach(el => el.classList.remove('drag-over'));
    target.classList.add('drag-over');
  }
}

function handleDrop(e, targetShopId, targetGroup) {
  e.preventDefault();
  if (!draggedShopId || draggedGroup !== targetGroup) return;
  if (draggedShopId === targetShopId) return;

  /* SHOPS 배열에서 순서 변경 */
  const groupShops = SHOPS.filter(s => s.group === targetGroup);
  const draggedIdx = groupShops.findIndex(s => s.id === draggedShopId);
  const targetIdx = groupShops.findIndex(s => s.id === targetShopId);

  if (draggedIdx === -1 || targetIdx === -1) return;

  /* 전체 SHOPS에서 인덱스 찾기 */
  const fullDraggedIdx = SHOPS.findIndex(s => s.id === draggedShopId);
  const fullTargetIdx = SHOPS.findIndex(s => s.id === targetShopId);

  /* 배열에서 이동 */
  const [removed] = SHOPS.splice(fullDraggedIdx, 1);
  const newTargetIdx = SHOPS.findIndex(s => s.id === targetShopId);
  SHOPS.splice(fullDraggedIdx < fullTargetIdx ? newTargetIdx + 1 : newTargetIdx, 0, removed);

  /* 순서 저장 */
  saveShopOrder();
  renderSidebar();
  renderShopContents();
  if (currentShop) selectShop(currentShop);
}

function handleDragEnd() {
  draggedShopId = null;
  draggedGroup = null;
  document.querySelectorAll('.nav-item.dragging').forEach(el => el.classList.remove('dragging'));
  document.querySelectorAll('.nav-item.drag-over').forEach(el => el.classList.remove('drag-over'));
}

/* 쇼핑몰 순서 저장/불러오기 */
function saveShopOrder() {
  const order = SHOPS.map(s => s.id);
  localStorage.setItem('shopOrder', JSON.stringify(order));
}

function loadShopOrder() {
  const saved = localStorage.getItem('shopOrder');
  if (!saved) return;
  try {
    const order = JSON.parse(saved);
    SHOPS.sort((a, b) => {
      const aIdx = order.indexOf(a.id);
      const bIdx = order.indexOf(b.id);
      if (aIdx === -1 && bIdx === -1) return 0;
      if (aIdx === -1) return 1;
      if (bIdx === -1) return -1;
      return aIdx - bIdx;
    });
  } catch(e) {}

  /* 쿠팡 하위 순서 복원 */
  if (DATA.coupangChildOrder && DATA.coupangChildOrder.length > 0) {
    COUPANG_GROUP.children.sort((a, b) => {
      const aIdx = DATA.coupangChildOrder.indexOf(a.slotId);
      const bIdx = DATA.coupangChildOrder.indexOf(b.slotId);
      if (aIdx === -1 && bIdx === -1) return 0;
      if (aIdx === -1) return 1;
      if (bIdx === -1) return -1;
      return aIdx - bIdx;
    });
  }

  /* 모여라딜 하위 순서 복원 */
  if (DATA.moyeoraChildOrder && DATA.moyeoraChildOrder.length > 0) {
    MOYEORA_GROUP.children.sort((a, b) => {
      const aIdx = DATA.moyeoraChildOrder.indexOf(a.slotId);
      const bIdx = DATA.moyeoraChildOrder.indexOf(b.slotId);
      if (aIdx === -1 && bIdx === -1) return 0;
      if (aIdx === -1) return 1;
      if (bIdx === -1) return -1;
      return aIdx - bIdx;
    });
  }
}

function selectShop(shopId) {
  currentShop = shopId;
  document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.shopId === shopId));
  document.querySelectorAll('.shop-content').forEach(el => el.classList.toggle('active', el.dataset.shopId === shopId));
}

function renderShopContents() {
  const container = document.getElementById('shopContents');
  container.innerHTML = '';
  SHOPS.forEach(shop => {
    const div = document.createElement('div');
    div.className = 'shop-content';
    div.dataset.shopId = shop.id;
    div.id = 'shop_' + shop.id;
    div.innerHTML = buildShopHTML(shop);
    container.appendChild(div);
  });
}

function buildShopHTML(shop) {
  const gc = shop.group === 'grohome' ? 'grohome' : shop.group === 'both' ? 'both' : shop.group === 'moyeora' ? 'moyeora' : 'pour';
  const ic = shop.group === 'grohome' ? 'lavender' : shop.group === 'both' ? 'pink' : shop.group === 'moyeora' ? 'teal' : 'sky';
  const path = getShopSetting(shop.id, 'path');
  const dataPath = getShopSetting(shop.id, 'dataPath');
  const done = isCompleted(currentMonth, shop.id);

  const boxClass = shop.group === 'grohome' ? 'lav' : shop.group === 'both' ? 'pink-box' : shop.group === 'moyeora' ? 'teal-box' : '';

  /* multiLogin 지원: 접속 링크는 하나, 로그인 정보는 각각 표시 */
  let loginInfoHtml = '';
  const multiLogin = shop.multiLogin;
  if (multiLogin && Array.isArray(multiLogin)) {
    const mainUrl = multiLogin[0].url;
    const urlHtml = `
      <div class="info-item">
        <div class="label">접속 링크</div>
        <div class="value"><a href="${mainUrl}" target="_blank">${mainUrl}</a></div>
        <div class="actions">
          <button class="btn-icon" onclick="copyText('${mainUrl}')" title="복사"><span class="material-symbols-outlined">content_copy</span></button>
          <button class="btn-icon" onclick="window.open('${mainUrl}','_blank')" title="새 탭"><span class="material-symbols-outlined">open_in_new</span></button>
        </div>
      </div>`;
    const loginsHtml = multiLogin.map((login, idx) => {
      const lUserId = getMultiLoginSetting(shop.id, idx, 'userId') || login.userId;
      const lUserPw = getMultiLoginSetting(shop.id, idx, 'userPw') || login.userPw;
      const lNote = getMultiLoginSetting(shop.id, idx, 'note') || login.note;
      let lNoteHtml = '';
      if (lNote) {
        const isEmail = lNote.startsWith('이메일인증');
        const noteLabel = isEmail ? '이메일인증' : '참고사항';
        const noteValue = isEmail ? (lNote.includes(':') ? lNote.split(':').slice(1).join(':').trim() : '') || '필요' : lNote;
        lNoteHtml = `<div class="info-item">
          <div class="label">${noteLabel}</div>
          <div class="value">${noteValue}</div>
          <div class="actions">${noteValue && noteValue !== '필요' ? `<button class="btn-icon" onclick="copyText('${noteValue.replace(/'/g,"\\'")}')" title="복사"><span class="material-symbols-outlined">content_copy</span></button>` : ''}</div>
        </div>`;
      }
      return `
        <div class="multi-login-section" style="margin-top:${idx===0?'0':'16px'};">
          <div class="info-item" style="background:#f8f9fa;border-radius:4px;">
            <div class="label" style="color:#333;font-weight:500;">${login.label}</div>
            <div class="value"></div>
            <div class="actions"></div>
          </div>
          <div class="info-item">
            <div class="label">아이디</div>
            <div class="value">${lUserId}</div>
            <div class="actions">
              <button class="btn-icon" onclick="copyText('${lUserId}')" title="복사"><span class="material-symbols-outlined">content_copy</span></button>
            </div>
          </div>
          <div class="info-item">
            <div class="label">비밀번호</div>
            <div class="value masked" id="pw_${shop.id}_${idx}">••••••••</div>
            <div class="actions">
              <button class="btn-icon" onclick="togglePwMulti('${shop.id}',${idx},'${lUserPw}')" title="보기"><span class="material-symbols-outlined" id="pwIcon_${shop.id}_${idx}">visibility</span></button>
              <button class="btn-icon" onclick="copyText('${lUserPw}')" title="복사"><span class="material-symbols-outlined">content_copy</span></button>
            </div>
          </div>
          ${lNoteHtml}
        </div>`;
    }).join('');
    loginInfoHtml = urlHtml + loginsHtml;
  } else {
    const url = getShopSetting(shop.id, 'url');
    const userId = getShopSetting(shop.id, 'userId');
    const userPw = getShopSetting(shop.id, 'userPw');
    const note = getShopSetting(shop.id, 'note');
    let noteHtml = '';
    if (note) {
      if (note.startsWith('이메일인증')) {
        const emailDetail = note.includes(':') ? note.split(':').slice(1).join(':').trim() : '';
        noteHtml = `<div class="info-item">
            <div class="label">이메일인증</div>
            <div class="value">${emailDetail || '필요'}</div>
            <div class="actions">${emailDetail ? `<button class="btn-icon" onclick="copyText('${emailDetail.replace(/'/g,"\\'")}')" title="복사"><span class="material-symbols-outlined">content_copy</span></button>` : ''}</div>
          </div>`;
      } else {
        noteHtml = `<div class="note-box"><span class="material-symbols-outlined">info</span>${note}</div>`;
      }
    }
    loginInfoHtml = `
      <div class="info-item">
        <div class="label">접속 링크</div>
        <div class="value"><a href="${url}" target="_blank">${url}</a></div>
        <div class="actions">
          <button class="btn-icon" onclick="copyText('${url}')" title="복사"><span class="material-symbols-outlined">content_copy</span></button>
          <button class="btn-icon" onclick="window.open('${url}','_blank')" title="새 탭"><span class="material-symbols-outlined">open_in_new</span></button>
        </div>
      </div>
      <div class="info-item">
        <div class="label">아이디</div>
        <div class="value">${userId}</div>
        <div class="actions">
          <button class="btn-icon" onclick="copyText('${userId}')" title="복사"><span class="material-symbols-outlined">content_copy</span></button>
        </div>
      </div>
      <div class="info-item">
        <div class="label">비밀번호</div>
        <div class="value masked" id="pw_${shop.id}">••••••••</div>
        <div class="actions">
          <button class="btn-icon" onclick="togglePw('${shop.id}')" title="보기"><span class="material-symbols-outlined" id="pwIcon_${shop.id}">visibility</span></button>
          <button class="btn-icon" onclick="copyText('${userPw}')" title="복사"><span class="material-symbols-outlined">content_copy</span></button>
        </div>
      </div>
      ${noteHtml}`;
  }

  const dataPaths = getShopSetting(shop.id, 'dataPaths');
  const paths = getShopSetting(shop.id, 'paths');

  /* paths와 dataPaths가 같은 label을 공유하면 그룹으로 묶어서 표시 (예: 쿠팡 중개/로켓그로스) */
  let combinedPathHtml = '';
  if (paths && Array.isArray(paths) && paths.length > 0 && dataPaths && Array.isArray(dataPaths) && dataPaths.length > 0) {
    const pathLabels = paths.map(p => p.label);
    const dataLabels = dataPaths.map(d => d.label);
    const canGroup = pathLabels.length === dataLabels.length && pathLabels.every((l, i) => l === dataLabels[i]);

    if (canGroup) {
      /* 그룹으로 묶어서 표시: 중개(위탁), 로켓그로스 등 */
      combinedPathHtml = paths.map((p, idx) => {
        const dp = dataPaths[idx];
        const mainSteps = p.path.split('>').map(s => s.trim()).filter(Boolean);
        const dataSteps = dp.path.split('>').map(s => s.trim()).filter(Boolean);
        return `<div class="path-group" style="margin-bottom:12px;padding:10px;background:rgba(0,0,0,0.02);border-radius:8px;">
          <div class="path-group-label" style="font-weight:600;font-size:0.8rem;color:var(--text-primary);margin-bottom:8px;">${p.label}</div>
          <div class="path-section" style="margin-bottom:6px;"><div class="path-label">매출 금액 조회</div><div class="path-flow">${renderSteps(mainSteps)}</div></div>
          <div class="path-section"><div class="path-label">로우데이터</div><div class="path-flow">${renderSteps(dataSteps)}</div></div>
        </div>`;
      }).join('');
    }
  }

  /* 그룹으로 묶이지 않는 경우 기존 방식 유지 */
  let dataPathHtml = '';
  let mainPathHtml = '';
  if (!combinedPathHtml) {
    if (dataPaths && Array.isArray(dataPaths)) {
      const showSublabel = dataPaths.length > 1;
      dataPathHtml = dataPaths.map(dp => {
        const steps = dp.path.split('>').map(s => s.trim()).filter(Boolean);
        const sublabelHtml = showSublabel ? `<div class="path-sublabel">${dp.label}</div>` : '';
        return `<div class="path-section"><div class="path-label">로우데이터</div>${sublabelHtml}<div class="path-flow">${renderSteps(steps)}</div></div>`;
      }).join('');
    } else if (dataPath) {
      const steps = dataPath.split('>').map(s => s.trim()).filter(Boolean);
      dataPathHtml = `<div class="path-section"><div class="path-label">데이터 확인 경로</div><div class="path-flow">${renderSteps(steps)}</div></div>`;
    }
    /* paths 배열 지원 (매출 금액 조회가 여러 개인 경우) */
    if (paths && Array.isArray(paths) && paths.length > 0) {
      const showPathSublabel = paths.length > 1;
      mainPathHtml = paths.map(p => {
        const steps = p.path.split('>').map(s => s.trim()).filter(Boolean);
        const sublabelHtml = showPathSublabel ? `<div class="path-sublabel">${p.label}</div>` : '';
        return `<div class="path-section"><div class="path-label">매출 금액 조회</div>${sublabelHtml}<div class="path-flow">${renderSteps(steps)}</div></div>`;
      }).join('');
    } else {
      const pathSteps = path ? path.split('>').map(s => s.trim()).filter(Boolean) : [];
      mainPathHtml = `<div class="path-section"><div class="path-label">매출 금액 조회</div><div class="path-flow">${renderSteps(pathSteps)}</div></div>`;
    }
  }

  return `
    <div class="content-card ${gc}" id="info_${shop.id}">
      <div class="card-header">
        <div class="card-header-icon ${ic}"><span class="material-symbols-outlined" style="font-size:16px;">link</span></div>
        <div><div class="card-header-title">시스템 접속 정보</div></div>
        <div class="card-header-right">
          <button class="btn-edit" onclick="startEditInfo('${shop.id}')"><span class="material-symbols-outlined" style="font-size:13px;">edit</span>수정</button>
        </div>
      </div>
      <div class="card-body" id="infoBody_${shop.id}">
        <div class="checkpoint-box ${boxClass}">
          ${loginInfoHtml}
        </div>
      </div>
    </div>
    <div class="content-card ${gc}" id="path_${shop.id}">
      <div class="card-header">
        <div class="card-header-icon ${shop.group==='grohome'?'pink':shop.group==='both'?'pink':shop.group==='moyeora'?'teal':'yellow'}"><span class="material-symbols-outlined" style="font-size:16px;">route</span></div>
        <div><div class="card-header-title">매출 금액 확인 경로</div></div>
        <div class="card-header-right">
          <button class="btn-edit" onclick="startEditPath('${shop.id}')"><span class="material-symbols-outlined" style="font-size:13px;">edit</span>수정</button>
        </div>
      </div>
      <div class="card-body" id="pathBody_${shop.id}">
        <div class="checkpoint-box ${boxClass}">
          ${combinedPathHtml || (mainPathHtml + dataPathHtml)}
        </div>
      </div>
    </div>
    ${shop.subTabs ? buildSubTabsHTML(shop, gc, ic, boxClass) : buildSalesSection(shop, gc, ic, boxClass, done)}`;
}

/* 매핑 없는 쇼핑몰용 간단 파일 업로드 + 금액 검증 */
function buildVerifyUpload(shopId, boxClass) {
  const fileInfo = VERIFY_FILES[shopId];
  return `
    <div style="margin-top:8px;padding-top:8px;border-top:1px dashed rgba(0,0,0,0.08);">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
        <span class="material-symbols-outlined" style="font-size:14px;color:var(--text-muted);">fact_check</span>
        <span style="font-size:0.75rem;font-weight:600;color:var(--text-muted);">금액 검증</span>
      </div>
      <div class="upload-dropzone ${fileInfo ? 'has-file' : ''}" style="padding:10px;min-height:auto;"
           ondragover="event.preventDefault();this.classList.add('dragover')"
           ondragleave="this.classList.remove('dragover')"
           ondrop="event.preventDefault();this.classList.remove('dragover');handleVerifyDrop(event,'${shopId}')"
           onclick="document.getElementById('verifyInput_${shopId}').click()">
        <span class="material-symbols-outlined" style="font-size:16px;">${fileInfo ? 'description' : 'upload_file'}</span>
        <span style="font-size:0.75rem;">${fileInfo ? fileInfo.name + ' (' + fileInfo.rowCount + '행)' : '검증용 파일 드래그 또는 클릭'}</span>
      </div>
      <input type="file" id="verifyInput_${shopId}" accept=".xlsx,.xls,.csv" style="display:none"
             onchange="handleVerifySelect(event,'${shopId}')">
      <div class="verify-box" id="verify_${shopId}"></div>
    </div>`;
}
const VERIFY_FILES = {};
function handleVerifyDrop(event, shopId) {
  const file = event.dataTransfer.files[0];
  if (file) parseVerifyFile(file, shopId);
}
function handleVerifySelect(event, shopId) {
  const file = event.target.files[0];
  if (file) parseVerifyFile(file, shopId);
}
function parseVerifyFile(file, shopId, password) {
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const opts = {type:'array'};
      if (password) opts.password = password;
      const wb = XLSX.read(e.target.result, opts);
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:''});
      if (json.length < 2) { showToast('데이터가 없습니다'); return; }
      const headers = json[0].map(h => String(h).trim());
      const rows = json.slice(1).filter(r => r.some(c => c !== ''));
      VERIFY_FILES[shopId] = {name: file.name, headers: headers, rows: rows, rowCount: rows.length};
      showVerifyResult(shopId, headers, rows);
      refreshShopContent(shopId);
      showToast(file.name + ' 검증 완료 (' + rows.length + '행)');
    } catch(err) {
      if (!password && (err.message.includes('password') || err.message.includes('encrypt') || err.message.includes('cfb'))) {
        const pw = prompt('암호가 설정된 파일입니다. 비밀번호를 입력하세요:');
        if (pw) parseVerifyFile(file, shopId, pw);
        else showToast('업로드 취소');
      } else {
        showToast('파일 파싱 오류: ' + err.message);
      }
    }
  };
  reader.readAsArrayBuffer(file);
}

function buildSalesBlock(tabId, boxClass) {
  // 지마켓은 상품판매 + 배송비 분리 입력
  if (tabId === 'pour_gmarket') {
    return buildGmarketSalesBlock(tabId, boxClass);
  }
  // 쿠팡은 중개(위탁) + 로켓그로스 분리 입력
  if (tabId === 'pour_coupang') {
    return buildCoupangSalesBlock(tabId, boxClass);
  }
  return `<div class="sales-input-row" id="salesRow_${tabId}">
    <div class="label">${currentMonth}월</div>
    ${getSalesAmount(tabId) ?
      `<div class="sales-display" id="salesVal_${tabId}">${Number(getSalesAmount(tabId)).toLocaleString()}원</div>
       <div class="sales-actions">
         <button class="btn-icon" onclick="editSales('${tabId}')" title="수정"><span class="material-symbols-outlined">edit</span></button>
         <button class="btn-icon" onclick="clearSales('${tabId}')" title="삭제"><span class="material-symbols-outlined">delete</span></button>
       </div>` :
      `<input class="sales-input" id="salesInput_${tabId}" type="text" placeholder="금액을 입력하세요" onkeydown="if(event.key==='Enter')saveSales('${tabId}')">
       <div class="sales-actions">
         <button class="btn-icon" onclick="saveSales('${tabId}')" title="저장"><span class="material-symbols-outlined">check</span></button>
       </div>`}
  </div>`;
}

/* 지마켓 전용: 상품판매 + 배송비 분리 입력 */
function getGmarketSalesData(shopId) {
  if (!DATA.sales) DATA.sales = {};
  if (!DATA.sales[currentMonth]) DATA.sales[currentMonth] = {};
  const saved = DATA.sales[currentMonth][shopId + '_detail'];
  return saved ? saved : {product: '', shipping: ''};
}
function buildGmarketSalesBlock(tabId, boxClass) {
  const detail = getGmarketSalesData(tabId);
  const total = getSalesAmount(tabId);
  const hasData = total && Number(total) > 0;

  if (hasData) {
    return `<div id="salesRow_${tabId}" style="display:flex;flex-direction:column;gap:0;">
      <div class="sales-input-row">
        <div class="label">상품판매</div>
        <div class="sales-display">${Number(detail.product || 0).toLocaleString()}원</div>
      </div>
      <div class="sales-input-row">
        <div class="label">배송비</div>
        <div class="sales-display">${Number(detail.shipping || 0).toLocaleString()}원</div>
      </div>
      <div class="sales-input-row" style="border-top:1px solid #e0e0e0;background:rgba(26,115,232,0.03);">
        <div class="label" style="font-weight:700;">${currentMonth}월 합계</div>
        <div class="sales-display" style="font-weight:700;color:#1a73e8;">${Number(total).toLocaleString()}원</div>
        <div class="sales-actions">
          <button class="btn-icon" onclick="editGmarketSales('${tabId}')" title="수정"><span class="material-symbols-outlined">edit</span></button>
          <button class="btn-icon" onclick="clearSales('${tabId}')" title="삭제"><span class="material-symbols-outlined">delete</span></button>
        </div>
      </div>
    </div>`;
  } else {
    return `<div id="salesRow_${tabId}" style="display:flex;flex-direction:column;gap:0;">
      <div class="sales-input-row">
        <div class="label">상품판매</div>
        <input class="sales-input" id="gmarket_product_${tabId}" type="text" placeholder="상품판매 금액 입력" oninput="updateGmarketTotal('${tabId}')" onkeydown="if(event.key==='Enter')saveGmarketSales('${tabId}')">
      </div>
      <div class="sales-input-row">
        <div class="label">배송비</div>
        <input class="sales-input" id="gmarket_shipping_${tabId}" type="text" placeholder="배송비 금액 입력" oninput="updateGmarketTotal('${tabId}')" onkeydown="if(event.key==='Enter')saveGmarketSales('${tabId}')">
      </div>
      <div class="sales-input-row" style="border-top:1px solid #e0e0e0;background:rgba(26,115,232,0.03);">
        <div class="label" style="font-weight:700;">${currentMonth}월 합계</div>
        <div class="sales-display" id="gmarket_total_${tabId}" style="font-weight:700;color:#1a73e8;">0원</div>
        <div class="sales-actions">
          <button class="btn-icon" onclick="saveGmarketSales('${tabId}')" title="저장"><span class="material-symbols-outlined">check</span></button>
        </div>
      </div>
    </div>`;
  }
}
function updateGmarketTotal(tabId) {
  const productInput = document.getElementById('gmarket_product_' + tabId);
  const shippingInput = document.getElementById('gmarket_shipping_' + tabId);
  const totalDisplay = document.getElementById('gmarket_total_' + tabId);
  if (!productInput || !shippingInput || !totalDisplay) return;
  const product = parseInt(productInput.value.replace(/[^0-9]/g, '')) || 0;
  const shipping = parseInt(shippingInput.value.replace(/[^0-9]/g, '')) || 0;
  totalDisplay.textContent = (product + shipping).toLocaleString() + '원';
}
function saveGmarketSales(tabId) {
  const productInput = document.getElementById('gmarket_product_' + tabId);
  const shippingInput = document.getElementById('gmarket_shipping_' + tabId);
  if (!productInput || !shippingInput) return;
  const product = productInput.value.replace(/[^0-9]/g, '');
  const shipping = shippingInput.value.replace(/[^0-9]/g, '');
  if (!product && !shipping) return;
  const total = (parseInt(product) || 0) + (parseInt(shipping) || 0);
  if (!DATA.sales) DATA.sales = {};
  if (!DATA.sales[currentMonth]) DATA.sales[currentMonth] = {};
  DATA.sales[currentMonth][tabId] = String(total);
  DATA.sales[currentMonth][tabId + '_detail'] = {product: product, shipping: shipping};
  saveData();
  refreshShopContent(tabId);
}
function editGmarketSales(tabId) {
  const detail = getGmarketSalesData(tabId);
  const row = document.getElementById('salesRow_' + tabId);
  row.innerHTML = `
    <div class="sales-input-row">
      <div class="label">상품판매</div>
      <input class="sales-input" id="gmarket_product_${tabId}" type="text" value="${detail.product}" oninput="updateGmarketTotal('${tabId}')" onkeydown="if(event.key==='Enter')saveGmarketSales('${tabId}')">
    </div>
    <div class="sales-input-row">
      <div class="label">배송비</div>
      <input class="sales-input" id="gmarket_shipping_${tabId}" type="text" value="${detail.shipping}" oninput="updateGmarketTotal('${tabId}')" onkeydown="if(event.key==='Enter')saveGmarketSales('${tabId}')">
    </div>
    <div class="sales-input-row" style="border-top:1px solid #e0e0e0;background:rgba(26,115,232,0.03);">
      <div class="label" style="font-weight:700;">${currentMonth}월 합계</div>
      <div class="sales-display" id="gmarket_total_${tabId}" style="font-weight:700;color:#1a73e8;">${(parseInt(detail.product||0) + parseInt(detail.shipping||0)).toLocaleString()}원</div>
      <div class="sales-actions">
        <button class="btn-icon" onclick="saveGmarketSales('${tabId}')" title="저장"><span class="material-symbols-outlined">check</span></button>
        <button class="btn-icon" onclick="refreshShopContent('pour_gmarket')" title="취소"><span class="material-symbols-outlined">close</span></button>
      </div>
    </div>`;
  document.getElementById('gmarket_product_' + tabId).focus();
}

/* 쿠팡 전용: 중개(위탁) + 로켓그로스 분리 입력 + 판매자할인쿠폰 */
function getCoupangSalesData(shopId) {
  if (!DATA.sales) DATA.sales = {};
  if (!DATA.sales[currentMonth]) DATA.sales[currentMonth] = {};
  const saved = DATA.sales[currentMonth][shopId + '_detail'];
  return saved ? saved : {junggae: '', rocketgrowth: '', sellerCoupon: ''};
}
function buildCoupangSalesBlock(tabId, boxClass) {
  const detail = getCoupangSalesData(tabId);
  const total = getSalesAmount(tabId);
  const hasData = total && Number(total) > 0;
  const sellerCoupon = Number(detail.sellerCoupon || 0);

  if (hasData) {
    return `<div id="salesRow_${tabId}" style="display:flex;flex-direction:column;gap:0;">
      <div class="sales-input-row">
        <div class="label">중개(위탁)</div>
        <div class="sales-display">${Number(detail.junggae || 0).toLocaleString()}원</div>
      </div>
      <div class="sales-input-row">
        <div class="label">로켓그로스</div>
        <div class="sales-display">${Number(detail.rocketgrowth || 0).toLocaleString()}원</div>
      </div>
      <div class="sales-input-row" style="background:rgba(234,67,53,0.05);border-top:1px dashed #ea4335;">
        <div class="label" style="color:#ea4335;">판매자할인쿠폰</div>
        <div class="sales-display" style="color:#ea4335;">-${sellerCoupon.toLocaleString()}원</div>
      </div>
      <div class="sales-input-row" style="border-top:1px solid #e0e0e0;background:rgba(26,115,232,0.03);">
        <div class="label" style="font-weight:700;">${currentMonth}월 합계</div>
        <div class="sales-display" style="font-weight:700;color:#1a73e8;">${Number(total).toLocaleString()}원</div>
        <div class="sales-actions">
          <button class="btn-icon" onclick="editCoupangSales('${tabId}')" title="수정"><span class="material-symbols-outlined">edit</span></button>
          <button class="btn-icon" onclick="clearSales('${tabId}')" title="삭제"><span class="material-symbols-outlined">delete</span></button>
        </div>
      </div>
    </div>`;
  } else {
    return `<div id="salesRow_${tabId}" style="display:flex;flex-direction:column;gap:0;">
      <div class="sales-input-row">
        <div class="label">중개(위탁)</div>
        <input class="sales-input" id="coupang_junggae_${tabId}" type="text" placeholder="중개(위탁) 금액 입력" oninput="updateCoupangTotal('${tabId}')" onkeydown="if(event.key==='Enter')saveCoupangSales('${tabId}')">
      </div>
      <div class="sales-input-row">
        <div class="label">로켓그로스</div>
        <input class="sales-input" id="coupang_rocketgrowth_${tabId}" type="text" placeholder="로켓그로스 금액 입력" oninput="updateCoupangTotal('${tabId}')" onkeydown="if(event.key==='Enter')saveCoupangSales('${tabId}')">
      </div>
      <div class="sales-input-row" style="background:rgba(234,67,53,0.05);border-top:1px dashed #ea4335;">
        <div class="label" style="color:#ea4335;">판매자할인쿠폰</div>
        <input class="sales-input" id="coupang_sellerCoupon_${tabId}" type="text" placeholder="할인쿠폰 금액 (차감)" style="color:#ea4335;" oninput="updateCoupangTotal('${tabId}')" onkeydown="if(event.key==='Enter')saveCoupangSales('${tabId}')">
      </div>
      <div class="sales-input-row" style="border-top:1px solid #e0e0e0;background:rgba(26,115,232,0.03);">
        <div class="label" style="font-weight:700;">${currentMonth}월 합계</div>
        <div class="sales-display" id="coupang_total_${tabId}" style="font-weight:700;color:#1a73e8;">0원</div>
        <div class="sales-actions">
          <button class="btn-icon" onclick="saveCoupangSales('${tabId}')" title="저장"><span class="material-symbols-outlined">check</span></button>
        </div>
      </div>
    </div>`;
  }
}
function updateCoupangTotal(tabId) {
  const junggaeInput = document.getElementById('coupang_junggae_' + tabId);
  const rocketgrowthInput = document.getElementById('coupang_rocketgrowth_' + tabId);
  const totalDisplay = document.getElementById('coupang_total_' + tabId);
  if (!junggaeInput || !rocketgrowthInput || !totalDisplay) return;
  const junggae = parseInt(junggaeInput.value.replace(/[^0-9]/g, '')) || 0;
  const rocketgrowth = parseInt(rocketgrowthInput.value.replace(/[^0-9]/g, '')) || 0;
  /* 합계에는 할인쿠폰 미반영 (이미 중개 금액에 반영됨) */
  totalDisplay.textContent = (junggae + rocketgrowth).toLocaleString() + '원';
}
function saveCoupangSales(tabId) {
  const junggaeInput = document.getElementById('coupang_junggae_' + tabId);
  const rocketgrowthInput = document.getElementById('coupang_rocketgrowth_' + tabId);
  const sellerCouponInput = document.getElementById('coupang_sellerCoupon_' + tabId);
  if (!junggaeInput || !rocketgrowthInput) return;
  const junggae = junggaeInput.value.replace(/[^0-9]/g, '');
  const rocketgrowth = rocketgrowthInput.value.replace(/[^0-9]/g, '');
  const sellerCoupon = sellerCouponInput ? sellerCouponInput.value.replace(/[^0-9]/g, '') : '';
  if (!junggae && !rocketgrowth) return;
  /* 합계에는 할인쿠폰 미반영 (이미 중개 금액에 반영됨, 엑셀 다운로드 시에만 별도 마이너스 행으로 반영) */
  const total = (parseInt(junggae) || 0) + (parseInt(rocketgrowth) || 0);
  if (!DATA.sales) DATA.sales = {};
  if (!DATA.sales[currentMonth]) DATA.sales[currentMonth] = {};
  DATA.sales[currentMonth][tabId] = String(total);
  DATA.sales[currentMonth][tabId + '_detail'] = {junggae: junggae, rocketgrowth: rocketgrowth, sellerCoupon: sellerCoupon};
  /* 쿠팡 슬롯별 매출 저장 (매출현황 테이블용) */
  DATA.sales[currentMonth]['pour_coupang_0'] = junggae;
  DATA.sales[currentMonth]['pour_coupang_1'] = rocketgrowth;
  saveData();
  refreshShopContent(tabId);
}
function editCoupangSales(tabId) {
  const detail = getCoupangSalesData(tabId);
  const row = document.getElementById('salesRow_' + tabId);
  const currentTotal = (parseInt(detail.junggae||0) + parseInt(detail.rocketgrowth||0));
  row.innerHTML = `
    <div class="sales-input-row">
      <div class="label">중개(위탁)</div>
      <input class="sales-input" id="coupang_junggae_${tabId}" type="text" value="${detail.junggae}" oninput="updateCoupangTotal('${tabId}')" onkeydown="if(event.key==='Enter')saveCoupangSales('${tabId}')">
    </div>
    <div class="sales-input-row">
      <div class="label">로켓그로스</div>
      <input class="sales-input" id="coupang_rocketgrowth_${tabId}" type="text" value="${detail.rocketgrowth}" oninput="updateCoupangTotal('${tabId}')" onkeydown="if(event.key==='Enter')saveCoupangSales('${tabId}')">
    </div>
    <div class="sales-input-row" style="background:rgba(234,67,53,0.05);border-top:1px dashed #ea4335;">
      <div class="label" style="color:#ea4335;">판매자할인쿠폰</div>
      <input class="sales-input" id="coupang_sellerCoupon_${tabId}" type="text" value="${detail.sellerCoupon||''}" style="color:#ea4335;" oninput="updateCoupangTotal('${tabId}')" onkeydown="if(event.key==='Enter')saveCoupangSales('${tabId}')">
    </div>
    <div class="sales-input-row" style="border-top:1px solid #e0e0e0;background:rgba(26,115,232,0.03);">
      <div class="label" style="font-weight:700;">${currentMonth}월 합계</div>
      <div class="sales-display" id="coupang_total_${tabId}" style="font-weight:700;color:#1a73e8;">${currentTotal.toLocaleString()}원</div>
      <div class="sales-actions">
        <button class="btn-icon" onclick="saveCoupangSales('${tabId}')" title="저장"><span class="material-symbols-outlined">check</span></button>
        <button class="btn-icon" onclick="refreshShopContent('pour_coupang')" title="취소"><span class="material-symbols-outlined">close</span></button>
      </div>
    </div>`;
  document.getElementById('coupang_junggae_' + tabId).focus();
}

function buildSalesSection(shop, gc, ic, boxClass, done) {
  const hasMapping = !!SHOP_MAPPINGS[shop.id];
  const verifyHtml = hasMapping ? '' : buildVerifyUpload(shop.id, boxClass);
  return `
    <div class="content-card ${gc}" id="sales_${shop.id}">
      <div class="card-header">
        <div class="card-header-icon ${ic}"><span class="material-symbols-outlined" style="font-size:16px;">payments</span></div>
        <div><div class="card-header-title">매출금액</div><div class="card-header-sub">${currentMonth}월 금액 입력 + 연간 누적</div></div>
        <div class="card-header-right"></div>
      </div>
      <div class="card-body">
        <div class="checkpoint-box ${boxClass}">
          ${buildSalesBlock(shop.id, boxClass)}
          ${verifyHtml}
        </div>
      </div>
    </div>
    ${shop.id === 'pour_coupang' ? buildCoupangUploadCards(shop, gc, ic, boxClass) : buildUploadCard(shop, gc, ic, boxClass)}
    <button class="complete-toggle ${done?'done':''}" id="completeBtn_${shop.id}" onclick="handleComplete('${shop.id}')">
      <span class="check-box"><span class="material-symbols-outlined">check</span></span>
      <span>${shop.name} — ${currentMonth}월 확인 완료</span>
    </button>`;
}

function buildSubTabsHTML(shop, gc, ic, boxClass) {
  let html = '';
  shop.subTabs.forEach(t => {
    const tabDone = isCompleted(currentMonth, t.id);
    html += `
    <div class="sub-section-label ${gc}">${t.label}</div>
    <div class="content-card ${gc}" id="sales_${t.id}">
      <div class="card-header">
        <div class="card-header-icon ${ic}"><span class="material-symbols-outlined" style="font-size:16px;">payments</span></div>
        <div><div class="card-header-title">매출금액</div><div class="card-header-sub">${currentMonth}월 금액 입력 + 연간 누적</div></div>
        <div class="card-header-right"></div>
      </div>
      <div class="card-body">
        <div class="checkpoint-box ${boxClass}">
          ${buildSalesBlock(t.id, boxClass)}
        </div>
      </div>
    </div>
    ${buildUploadCard(shop, gc, ic, boxClass, t.id)}
    <button class="complete-toggle ${tabDone?'done':''}" id="completeBtn_${t.id}" onclick="handleSubComplete('${shop.id}','${t.id}')">
      <span class="check-box"><span class="material-symbols-outlined">check</span></span>
      <span>${t.label} — ${currentMonth}월 확인 완료</span>
    </button>`;
  });
  return html;
}

function handleSubComplete(shopId, tabId) {
  toggleCompleted(currentMonth, tabId);
  const done = isCompleted(currentMonth, tabId);
  const btn = document.getElementById('completeBtn_' + tabId);
  if (btn) btn.classList.toggle('done', done);
  const shop = SHOPS.find(s => s.id === shopId);
  if (shop) {
    const navItem = document.querySelector(`.nav-item[data-shop-id="${shopId}"]`);
    if (navItem) navItem.classList.toggle('completed', shop.subTabs.every(t => isCompleted(currentMonth, t.id)));
  }
  updateDashboard();
  showToast(done ? '완료 처리되었습니다' : '완료 해제되었습니다');
}

function refreshShopContent(shopId) {
  const shop = SHOPS.find(s => s.id === shopId);
  if (!shop) return;
  const el = document.getElementById('shop_' + shopId);
  if (el) el.innerHTML = buildShopHTML(shop);
}


function getSalesAmount(shopId) {
  if (!DATA.sales) DATA.sales = {};
  if (!DATA.sales[currentMonth]) DATA.sales[currentMonth] = {};
  return DATA.sales[currentMonth][shopId] || '';
}
function saveSales(shopId) {
  const input = document.getElementById('salesInput_' + shopId);
  if (!input) return;
  const val = input.value.replace(/[^0-9]/g, '');
  if (!val) return;
  if (!DATA.sales) DATA.sales = {};
  if (!DATA.sales[currentMonth]) DATA.sales[currentMonth] = {};
  DATA.sales[currentMonth][shopId] = val;
  saveData();
  refreshShopContent(shopId);
}

/* 모여라딜 분류별 매출 자동 계산 */
function updateMoyeoraCategorySales() {
  /* 취합 실행하여 결과 데이터 얻기 */
  const result = executeMerge('moyeora_cafe24', true);
  if (!result || !result.headers || !result.rows) return;

  /* 브랜드, 매출금액(v+) 컬럼 인덱스 찾기 */
  const catIdx = result.headers.indexOf('브랜드');
  const amtIdx = result.headers.indexOf('매출금액(v+)');
  if (catIdx < 0 || amtIdx < 0) return;

  /* 분류별 합계 계산 */
  let grohomeTotal = 0;
  let moyeoraTotal = 0;
  result.rows.forEach(row => {
    const cat = String(row[catIdx] || '').trim();
    const amt = Number(String(row[amtIdx] || 0).replace(/,/g, '')) || 0;
    if (cat === '그로홈') {
      grohomeTotal += amt;
    } else {
      /* 미분류, 모여라딜 등 그로홈 외 전부 모여라딜로 */
      moyeoraTotal += amt;
    }
  });

  /* DATA.sales에 저장 */
  if (!DATA.sales) DATA.sales = {};
  if (!DATA.sales[currentMonth]) DATA.sales[currentMonth] = {};
  DATA.sales[currentMonth]['moyeora_grohome'] = grohomeTotal;
  DATA.sales[currentMonth]['moyeora_moyeora'] = moyeoraTotal;
  saveData();
  console.log('모여라딜 분류별 매출 계산:', {그로홈: grohomeTotal, 모여라딜: moyeoraTotal});
}
/* 계좌입금 브랜드별 매출 자동 계산 */
function updateOfflineCategorySales() {
  const result = executeMerge('pour_offline', true);
  if (!result || !result.headers || !result.rows) return;

  const brandIdx = result.headers.indexOf('브랜드');
  const amtIdx = result.headers.indexOf('매출금액(v+)');
  const nameIdx = result.headers.indexOf('제품명');
  if (brandIdx < 0 || amtIdx < 0) return;

  let grohomeTotal = 0, pourstoreTotal = 0, moyeoraTotal = 0;
  /* 모여라딜 하위: 제품매출(그로홈) vs 중개매출 */
  let moyeoraGrohome = 0, moyeoraJungae = 0;

  result.rows.forEach(row => {
    const brand = String(row[brandIdx] || '').trim();
    const amt = Number(String(row[amtIdx] || 0).replace(/,/g, '')) || 0;
    const desc = String(row[nameIdx] || '');
    if (brand === '그로홈') {
      grohomeTotal += amt;
    } else if (brand === '포어스토어') {
      pourstoreTotal += amt;
    } else if (brand === '모여라딜') {
      moyeoraTotal += amt;
      /* 적요에서 중개매출 vs 제품매출 구분 */
      if (desc.includes('중개매출')) {
        moyeoraJungae += amt;
      } else {
        moyeoraGrohome += amt;
      }
    }
  });

  if (!DATA.sales) DATA.sales = {};
  if (!DATA.sales[currentMonth]) DATA.sales[currentMonth] = {};
  DATA.sales[currentMonth]['pour_offline_grohome'] = grohomeTotal;
  DATA.sales[currentMonth]['pour_offline_pourstore'] = pourstoreTotal;
  DATA.sales[currentMonth]['pour_offline_moyeora'] = moyeoraTotal;
  /* 모여라딜 하위 중개/그로홈 분리 저장 */
  DATA.sales[currentMonth]['pour_offline_moyeora_grohome'] = moyeoraGrohome;
  DATA.sales[currentMonth]['pour_offline_moyeora_jungae'] = moyeoraJungae;
  /* 합계도 저장 (호환성) */
  DATA.sales[currentMonth]['pour_offline'] = grohomeTotal + pourstoreTotal + moyeoraTotal;
  saveData();
  console.log('계좌입금 브랜드별 매출:', {그로홈: grohomeTotal, 포어스토어: pourstoreTotal, 모여라딜: moyeoraTotal, 모딜그로홈: moyeoraGrohome, 모딜중개: moyeoraJungae});
}

function editSales(shopId) {
  const row = document.getElementById('salesRow_' + shopId);
  const current = getSalesAmount(shopId);
  row.innerHTML = `<div class="label">매출금액</div>
    <input class="sales-input" id="salesInput_${shopId}" type="text" value="${current}" onkeydown="if(event.key==='Enter')saveSales('${shopId}')">
    <div class="sales-actions">
      <button class="btn-icon" onclick="saveSales('${shopId}')" title="저장"><span class="material-symbols-outlined">check</span></button>
      <button class="btn-icon" onclick="refreshShopContent('${shopId}')" title="취소"><span class="material-symbols-outlined">close</span></button>
    </div>`;
  document.getElementById('salesInput_' + shopId).focus();
}
function clearSales(shopId) {
  if (!DATA.sales || !DATA.sales[currentMonth]) return;
  delete DATA.sales[currentMonth][shopId];
  delete DATA.sales[currentMonth][shopId + '_detail']; // 지마켓 상세 데이터도 삭제
  saveData();
  refreshShopContent(shopId);
}

function buildYearlyTable(shopId) {
  if (!DATA.sales) return '';
  let hasAny = false;
  for (let m = 1; m <= 12; m++) {
    if (DATA.sales[m] && DATA.sales[m][shopId]) { hasAny = true; break; }
  }
  if (!hasAny) return '';
  let rows = '';
  let total = 0;
  for (let m = 1; m <= 12; m++) {
    const val = (DATA.sales[m] && DATA.sales[m][shopId]) ? Number(DATA.sales[m][shopId]) : 0;
    if (val) total += val;
    const isCur = m === currentMonth;
    rows += `<div class="sales-month-row">
      <div class="m-label">${m}월</div>
      <div class="m-value${val ? (isCur ? ' current' : '') : ' empty'}">${val ? val.toLocaleString() : '-'}</div>
    </div>`;
  }
  return `<div class="sales-yearly">
    <div class="sales-yearly-title">연간 누적 현황</div>
    ${rows}
    <div class="sales-total-row">
      <div class="m-label">합계</div>
      <div class="m-value">${total.toLocaleString()}원</div>
    </div>
  </div>`;
}

function downloadSalesCSV() {
  const year = new Date().getFullYear();
  function buildSection(label, fmtFn) {
    let csv = label + '\n';
    csv += '채널,1월,2월,3월,4월,5월,6월,7월,8월,9월,10월,11월,12월,합계\n';
    const gt = new Array(12).fill(0);
    let gTotal = 0;
    SHOPS.forEach(shop => {
      let row = shop.name;
      let sTotal = 0;
      for (let m = 1; m <= 12; m++) {
        const raw = (DATA.sales && DATA.sales[m] && DATA.sales[m][shop.id]) ? Number(DATA.sales[m][shop.id]) : 0;
        const val = fmtFn(raw);
        row += ',' + (val || '');
        sTotal += val;
        gt[m-1] += val;
      }
      gTotal += sTotal;
      row += ',' + (sTotal || '');
      csv += row + '\n';
    });
    csv += '합계';
    for (let m = 0; m < 12; m++) csv += ',' + (gt[m] || '');
    csv += ',' + gTotal + '\n';
    return csv;
  }
  let csv = '\uFEFF';
  csv += buildSection('▶ 채널별 매출금액 (VAT+)', v => v);
  csv += '\n';
  csv += buildSection('▶ 채널별 매출금액 (VAT-)', v => Math.round(v / 1.1));
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = '채널별_매출금액_' + year + '.csv';
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('CSV 파일이 다운로드됩니다');
}

function togglePw(shopId) {
  const el = document.getElementById('pw_' + shopId);
  const icon = document.getElementById('pwIcon_' + shopId);
  const pw = getShopSetting(shopId, 'userPw');
  if (el.textContent === '••••••••') { el.textContent = pw; el.classList.remove('masked'); icon.textContent = 'visibility_off'; }
  else { el.textContent = '••••••••'; el.classList.add('masked'); icon.textContent = 'visibility'; }
}

function toggleEmailAuth(shopId, detail) {
  const el = document.getElementById('emailAuth_' + shopId);
  const icon = document.getElementById('emailAuthIcon_' + shopId);
  if (el.textContent === '••••••••') { el.textContent = detail; el.classList.remove('masked'); icon.textContent = 'visibility_off'; }
  else { el.textContent = '••••••••'; el.classList.add('masked'); icon.textContent = 'visibility'; }
}

function copyText(t) { navigator.clipboard.writeText(t).then(() => showToast('복사되었습니다')); }
function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 1800); }

function startEditInfo(shopId) {
  const body = document.getElementById('infoBody_' + shopId);
  const shop = SHOPS.find(s => s.id === shopId);

  /* multiLogin인 경우 각 로그인 정보 수정 */
  if (shop && shop.multiLogin && Array.isArray(shop.multiLogin)) {
    let editHtml = '';
    shop.multiLogin.forEach((login, idx) => {
      const lUserId = getMultiLoginSetting(shopId, idx, 'userId') || login.userId;
      const lUserPw = getMultiLoginSetting(shopId, idx, 'userPw') || login.userPw;
      const lNote = getMultiLoginSetting(shopId, idx, 'note') || login.note;
      editHtml += `
        <div style="margin-bottom:12px;padding:10px;background:#fafafa;border-radius:6px;border-left:3px solid ${idx===0?'#7c4dff':'#4A7C7F'};">
          <div style="font-weight:600;margin-bottom:8px;color:${idx===0?'#7c4dff':'#4A7C7F'};">${login.label}</div>
          <div class="info-row"><span class="label">아이디</span><input class="edit-input" id="editId_${shopId}_${idx}" value="${esc(lUserId)}"></div>
          <div class="info-row"><span class="label">비밀번호</span><input class="edit-input" id="editPw_${shopId}_${idx}" value="${esc(lUserPw)}"></div>
          <div class="info-row"><span class="label">${lNote && lNote.startsWith('이메일인증') ? '이메일인증' : '참고사항'}</span><input class="edit-input" id="editNote_${shopId}_${idx}" value="${esc(lNote)}" placeholder="없으면 비워두세요"></div>
        </div>`;
    });
    body.innerHTML = editHtml + `
      <div style="display:flex;gap:6px;margin-top:8px;justify-content:flex-end;">
        <button class="btn-cancel" onclick="refreshShopContent('${shopId}')">취소</button>
        <button class="btn-save" onclick="saveEditInfoMulti('${shopId}')">저장</button>
      </div>`;
    return;
  }

  const url = getShopSetting(shopId, 'url');
  const userId = getShopSetting(shopId, 'userId');
  const userPw = getShopSetting(shopId, 'userPw');
  const note = getShopSetting(shopId, 'note');
  body.innerHTML = `
    <div class="info-row"><span class="label">접속 링크</span><input class="edit-input" id="editUrl_${shopId}" value="${esc(url)}"></div>
    <div class="info-row"><span class="label">아이디</span><input class="edit-input" id="editId_${shopId}" value="${esc(userId)}"></div>
    <div class="info-row"><span class="label">비밀번호</span><input class="edit-input" id="editPw_${shopId}" value="${esc(userPw)}"></div>
    <div class="info-row"><span class="label">${note && note.startsWith('이메일인증') ? '이메일인증' : '참고사항'}</span><input class="edit-input" id="editNote_${shopId}" value="${esc(note)}" placeholder="없으면 비워두세요"></div>
    <div style="display:flex;gap:6px;margin-top:8px;justify-content:flex-end;">
      <button class="btn-cancel" onclick="refreshShopContent('${shopId}')">취소</button>
      <button class="btn-save" onclick="saveEditInfo('${shopId}')">저장</button>
    </div>`;
}
function saveEditInfoMulti(shopId) {
  const shop = SHOPS.find(s => s.id === shopId);
  if (shop && shop.multiLogin) {
    shop.multiLogin.forEach((login, idx) => {
      setMultiLoginSetting(shopId, idx, 'userId', document.getElementById(`editId_${shopId}_${idx}`).value);
      setMultiLoginSetting(shopId, idx, 'userPw', document.getElementById(`editPw_${shopId}_${idx}`).value);
      setMultiLoginSetting(shopId, idx, 'note', document.getElementById(`editNote_${shopId}_${idx}`).value);
    });
  }
  refreshShopContent(shopId); showToast('접속정보가 저장되었습니다');
}
function saveEditInfo(shopId) {
  setShopSetting(shopId, 'url', document.getElementById('editUrl_' + shopId).value);
  setShopSetting(shopId, 'userId', document.getElementById('editId_' + shopId).value);
  setShopSetting(shopId, 'userPw', document.getElementById('editPw_' + shopId).value);
  setShopSetting(shopId, 'note', document.getElementById('editNote_' + shopId).value);
  refreshShopContent(shopId); showToast('접속정보가 저장되었습니다');
}
function startEditPath(shopId) {
  const body = document.getElementById('pathBody_' + shopId);
  const path = getShopSetting(shopId, 'path');
  const paths = getShopSetting(shopId, 'paths');
  const dataPaths = getShopSetting(shopId, 'dataPaths');
  const dataPath = getShopSetting(shopId, 'dataPath');

  /* paths 배열 지원 (쿠팡 등) */
  let mainPathHtml = '';
  if (paths && Array.isArray(paths) && paths.length > 0) {
    mainPathHtml = paths.map((p, i) => `
      <div class="info-row"><span class="label">매출 경로 (${p.label})</span><input class="edit-input" id="editPath_${shopId}_${i}" value="${esc(p.path)}" placeholder="메뉴1 > 메뉴2"></div>
    `).join('');
  } else {
    mainPathHtml = `<div class="info-row"><span class="label">매출 경로</span><input class="edit-input" id="editPath_${shopId}" value="${esc(path)}" placeholder="메뉴1 > 메뉴2 > 메뉴3"></div>`;
  }

  let dpHtml = '';
  if (dataPaths && Array.isArray(dataPaths)) {
    dpHtml = dataPaths.map((dp, i) => `
      <div class="info-row"><span class="label">로우데이터 (${dp.label})</span><input class="edit-input" id="editDPPath_${shopId}_${i}" value="${esc(dp.path)}" placeholder="메뉴1 > 메뉴2"></div>
    `).join('');
  } else {
    dpHtml = `<div class="info-row"><span class="label">데이터 경로</span><input class="edit-input" id="editDP_${shopId}" value="${esc(dataPath)}" placeholder="없으면 비워두세요"></div>`;
  }
  body.innerHTML = `
    ${mainPathHtml}
    ${dpHtml}
    <div style="display:flex;gap:6px;margin-top:8px;justify-content:flex-end;">
      <button class="btn-cancel" onclick="refreshShopContent('${shopId}')">취소</button>
      <button class="btn-save" onclick="saveEditPath('${shopId}')">저장</button>
    </div>`;
}
function saveEditPath(shopId) {
  /* paths 배열 지원 (쿠팡 등) */
  const paths = getShopSetting(shopId, 'paths');
  if (paths && Array.isArray(paths) && paths.length > 0) {
    const updatedPaths = paths.map((p, i) => {
      const pathEl = document.getElementById('editPath_' + shopId + '_' + i);
      return {label: p.label, path: pathEl ? pathEl.value.trim() : p.path};
    });
    setShopSetting(shopId, 'paths', updatedPaths);
  } else {
    const pathEl = document.getElementById('editPath_' + shopId);
    if (pathEl) setShopSetting(shopId, 'path', pathEl.value);
  }

  const dataPaths = getShopSetting(shopId, 'dataPaths');
  if (dataPaths && Array.isArray(dataPaths)) {
    const updated = dataPaths.map((dp, i) => {
      const pathEl = document.getElementById('editDPPath_' + shopId + '_' + i);
      return {label: dp.label, path: pathEl ? pathEl.value.trim() : dp.path};
    });
    setShopSetting(shopId, 'dataPaths', updated);
  } else {
    const dpEl = document.getElementById('editDP_' + shopId);
    if (dpEl) setShopSetting(shopId, 'dataPath', dpEl.value);
  }
  refreshShopContent(shopId); showToast('경로가 저장되었습니다');
}

function handleComplete(shopId) {
  toggleCompleted(currentMonth, shopId);
  const done = isCompleted(currentMonth, shopId);
  document.getElementById('completeBtn_' + shopId).classList.toggle('done', done);
  const navItem = document.querySelector(`.nav-item[data-shop-id="${shopId}"]`);
  if (navItem) navItem.classList.toggle('completed', done);
  updateDashboard();
  showToast(done ? '완료 처리되었습니다' : '완료 해제되었습니다');
}

function getAllCheckIds() {
  const ids = [];
  SHOPS.forEach(s => {
    if (s.subTabs) s.subTabs.forEach(t => ids.push(t.id));
    else ids.push(s.id);
  });
  return ids;
}
function updateDashboard() {
  /* 대시보드 탭에서 renderSalesOverview를 통해 렌더링됨 */
}

function esc(str) {
  const d = document.createElement('div');
  d.textContent = str || '';
  return d.innerHTML.replace(/"/g, '&quot;');
}
function renderStep(s) {
  if (/^https?:\/\//.test(s)) return `<span class="path-step"><a href="${esc(s)}" target="_blank" style="color:var(--sky-deep);text-decoration:none;">${s}</a></span>`;
  return `<span class="path-step">${s}</span>`;
}
function renderSteps(steps) {
  return steps.map((s,i) => renderStep(s) + (i<steps.length-1?'<span class="path-arrow material-symbols-outlined">chevron_right</span>':'')).join('');
}

/* ───── 데이터 취합 기능 ───── */
const MAPPING_VERSION = 8;

/* 제품코드→제품명 공식 매핑 (재고관리 파일 기준) */
const PRODUCT_CODE_NAME_MAP = {
  "03033": "유리블러 올인원",
  "03031": "롤러일체형 페인트",
  "03034": "미니 롤러일체형 페인트",
  "03032": "미끄럼방지 롤러페인트",
  "N00100115": "POUR 씰 맥스 프로 500ml (블랙)+ 플라스틱+실리콘",
  "N00100116": "POUR 씰 맥스 프로 500ml (회색)+ 플라스틱+실리콘",
  "N00100110": "플라스틱 헤라(노란색)_ 씰 프로맥스_ 부자재",
  "N00100111": "실리콘헤라_ 씰 프로맥스_ 부자재",
  "03244": "철제용 브러쉬 페인트_다크 그레이",
  "03243": "철제용 브러쉬 페인트_다크 블루",
  "03242": "철제용 브러쉬 페인트_미디엄 그레이",
  "03246": "철제용 브러쉬 페인트_블랙",
  "03241": "철제용 브러쉬 페인트_아이언 그린",
  "03240": "철제용 브러쉬 페인트_아이언 레드",
  "03245": "철제용 브러쉬 페인트_화이트",
  "03248": "목재용 브러쉬 페인트_그레이 앤틱",
  "03253": "목재용 브러쉬 페인트_다크 블루",
  "03251": "목재용 브러쉬 페인트_마호가니",
  "03249": "목재용 브러쉬 페인트_블랙",
  "03250": "목재용 브러쉬 페인트_블랙 월넛",
  "03252": "목재용 브러쉬 페인트_오크",
  "03247": "목재용 브러쉬 페인트_화이트",
  "03254": "벽체용 브러쉬 페인트_펄화이트",
  "03255": "벽체용 브러쉬 페인트_화이트",
  "03184": "종이진열대"
};

/* 제품코드로 공식 제품명 가져오기 */
function getOfficialProductName(code) {
  if (!code) return null;
  return PRODUCT_CODE_NAME_MAP[String(code).trim()] || null;
}

/* 상품키워드관리 테이블 */
const DEFAULT_PRODUCT_KEYWORDS = [
  /* 그로홈 브랜드명 포함 시 바로 매칭 */
  {priority:0,  code:'', name:'그로홈 제품', keywords:['그로홈'], match:'SINGLE'},
  {priority:1,  code:'03034', name:'미니 롤러일체형 페인트', keywords:['미니','롤러일체형'], match:'AND'},
  {priority:2,  code:'03033', name:'유리블러 올인원', keywords:['유리블러','올인원'], match:'AND'},
  {priority:3,  code:'03032', name:'미끄럼방지 롤러페인트', keywords:['미끄럼','논술립','non-slip'], match:'OR'},
  /* 철제용 브러쉬 페인트 - 색상별 (AND 조건이 먼저) */
  {priority:4,  code:'03240', name:'철제용 브러쉬 페인트_아이언 레드', keywords:['철제','아이언 레드'], match:'AND'},
  {priority:5,  code:'03241', name:'철제용 브러쉬 페인트_아이언 그린', keywords:['철제','아이언 그린'], match:'AND'},
  {priority:6,  code:'03242', name:'철제용 브러쉬 페인트_미디엄 그레이', keywords:['철제','미디엄 그레이'], match:'AND'},
  {priority:7,  code:'03243', name:'철제용 브러쉬 페인트_다크 블루', keywords:['철제','다크 블루'], match:'AND'},
  {priority:8,  code:'03244', name:'철제용 브러쉬 페인트_다크 그레이', keywords:['철제','다크 그레이'], match:'AND'},
  {priority:9,  code:'03245', name:'철제용 브러쉬 페인트_화이트', keywords:['철제','화이트'], match:'AND'},
  {priority:10, code:'03246', name:'철제용 브러쉬 페인트_블랙', keywords:['철제','블랙'], match:'AND'},
  /* 목재용 브러쉬 페인트 - 색상별 (AND 조건이 먼저) */
  {priority:11, code:'03247', name:'목재용 브러쉬 페인트_화이트', keywords:['목재','화이트'], match:'AND'},
  {priority:12, code:'03248', name:'목재용 브러쉬 페인트_그레이 앤틱', keywords:['목재','그레이 앤틱'], match:'AND'},
  {priority:13, code:'03249', name:'목재용 브러쉬 페인트_블랙', keywords:['목재','블랙'], match:'AND'},
  {priority:14, code:'03250', name:'목재용 브러쉬 페인트_블랙 월넛', keywords:['목재','블랙 월넛'], match:'AND'},
  {priority:15, code:'03251', name:'목재용 브러쉬 페인트_마호가니', keywords:['목재','마호가니'], match:'AND'},
  {priority:16, code:'03252', name:'목재용 브러쉬 페인트_오크', keywords:['목재','오크'], match:'AND'},
  {priority:17, code:'03253', name:'목재용 브러쉬 페인트_다크 블루', keywords:['목재','다크 블루'], match:'AND'},
  /* 벽체용 브러쉬 페인트 - 색상별 (펄화이트가 먼저 체크되어야 함) */
  {priority:18, code:'03254', name:'벽체용 브러쉬 페인트_펄화이트', keywords:['벽체','펄'], match:'AND'},
  {priority:19, code:'03255', name:'벽체용 브러쉬 페인트_화이트', keywords:['벽체','화이트'], match:'AND'},
  /* 일반 분류 (색상 없는 경우 fallback - SINGLE은 맨 나중에) */
  {priority:90, code:'',      name:'목재용 브러쉬 페인트', keywords:['목재용'], match:'SINGLE'},
  {priority:21, code:'03461', name:'철제코팅페인트(1L)_미디엄그레이', keywords:['철제코팅','미디엄그레이','미디엄 그레이'], match:'OR'},
  {priority:22, code:'03462', name:'철제코팅페인트(1L)_아이언그린', keywords:['철제코팅','아이언그린','아이언 그린'], match:'OR'},
  {priority:23, code:'03463', name:'철제코팅페인트(1L)_아이언레드', keywords:['철제코팅','아이언레드','아이언 레드'], match:'OR'},
  {priority:24, code:'03464', name:'철제코팅페인트(1L)_다크그레이', keywords:['철제코팅','다크그레이','다크 그레이'], match:'OR'},
  {priority:25, code:'03465', name:'철제코팅페인트(1L)_블랙', keywords:['철제코팅','블랙'], match:'AND'},
  {priority:26, code:'03466', name:'철제코팅페인트(1L)_다크블루', keywords:['철제코팅','다크블루','다크 블루'], match:'OR'},
  {priority:27, code:'03467', name:'철제코팅페인트(1L)_화이트', keywords:['철제코팅','화이트'], match:'AND'},
  {priority:28, code:'03455', name:'목재코팅페인트(1L)_화이트', keywords:['목재코팅','화이트'], match:'AND'},
  {priority:29, code:'03456', name:'목재코팅페인트(1L)_그레이앤틱', keywords:['목재코팅','그레이앤틱','그레이 앤틱'], match:'OR'},
  {priority:30, code:'03457', name:'목재코팅페인트(1L)_블랙월넛', keywords:['목재코팅','블랙월넛','블랙 월넛'], match:'OR'},
  {priority:31, code:'03458', name:'목재코팅페인트(1L)_오크컬러', keywords:['목재코팅','오크컬러','오크 컬러'], match:'OR'},
  {priority:32, code:'03459', name:'목재코팅페인트(1L)_마호가니', keywords:['목재코팅','마호가니'], match:'AND'},
  {priority:33, code:'03460', name:'목재코팅페인트(1L)_다크블루', keywords:['목재코팅','다크블루','다크 블루'], match:'OR'},
  {priority:34, code:'03470', name:'목재코팅페인트(1L)_블랙', keywords:['목재코팅','블랙'], match:'AND'},
  {priority:35, code:'03468', name:'유리블러페인트(1L)', keywords:['유리블러','1L'], match:'AND'},
  {priority:92, code:'03468', name:'유리블러페인트', keywords:['유리블러'], match:'SINGLE'},
  {priority:36, code:'03469', name:'파워커버페인트(1L)', keywords:['파워커버','1L'], match:'AND'},
  {priority:37, code:'03184', name:'종이진열대', keywords:['종이진열대'], match:'SINGLE'},
  {priority:38, code:'03256', name:'롤러일체형 진열세트 4종', keywords:['진열세트','4종'], match:'AND'},
  /* 씰 맥스 프로 제품 */
  {priority:39, code:'N00100115', name:'POUR 씰 맥스 프로 500ml (블랙)+ 플라스틱+실리콘', keywords:['씰 맥스','블랙'], match:'AND'},
  {priority:40, code:'N00100116', name:'POUR 씰 맥스 프로 500ml (회색)+ 플라스틱+실리콘', keywords:['씰 맥스','회색'], match:'AND'},
  {priority:41, code:'N00100110', name:'플라스틱 헤라(노란색)_ 씰 프로맥스_ 부자재', keywords:['플라스틱','헤라'], match:'AND'},
  {priority:42, code:'N00100111', name:'실리콘헤라_ 씰 프로맥스_ 부자재', keywords:['실리콘','헤라'], match:'AND'},
  /* 일반 분류 (SINGLE - 맨 나중에) */
  {priority:91, code:'03031', name:'롤러일체형 페인트', keywords:['롤러일체형'], match:'SINGLE'}
];
/* localStorage에서 키워드 불러오기 (없으면 기본값 사용) */
let PRODUCT_KEYWORDS = (function() {
  try {
    const saved = localStorage.getItem('productKeywords');
    if (saved) {
      const arr = JSON.parse(saved);
      let needsSave = false;
      /* 유리블러 올인원: OR→AND 보정 */
      const fix1 = arr.find(k => k.code === '03033');
      if (fix1 && fix1.match === 'OR') { fix1.match = 'AND'; needsSave = true; }
      /* 목재용 브러쉬 페인트 (SINGLE): 우선순위 90으로 이동 (색상별 키워드보다 낮게) */
      const fix2 = arr.find(k => k.name === '목재용 브러쉬 페인트' && k.match === 'SINGLE');
      if (fix2 && fix2.priority < 50) { fix2.priority = 90; needsSave = true; }
      /* 벽체용 브러쉬 페인트- 펄화이트: OR→AND 보정, 키워드를 ['벽체','펄']로 변경 */
      const fix3 = arr.find(k => k.code === '03254');
      if (fix3 && (fix3.match === 'OR' || fix3.keywords.includes('펄화이트'))) {
        fix3.match = 'AND';
        fix3.keywords = ['벽체','펄'];
        needsSave = true;
      }
      /* 상품명 "- " → "_" 변경 보정 */
      arr.forEach(k => {
        if (k.name && k.name.includes('- ')) {
          k.name = k.name.replace(/- /g, '_');
          needsSave = true;
        }
        if (k.name && k.name.includes('-') && !k.name.includes('_') && k.name.match(/페인트-|부자재-/)) {
          k.name = k.name.replace(/-/g, '_');
          needsSave = true;
        }
      });
      if (needsSave) {
        arr.sort((a, b) => a.priority - b.priority);
        localStorage.setItem('productKeywords', JSON.stringify(arr));
      }
      return arr;
    }
  } catch(e) {}
  return JSON.parse(JSON.stringify(DEFAULT_PRODUCT_KEYWORDS));
})();

/* 키워드 테이블 렌더링 */
function toggleKeywordFold() {
  const body = document.getElementById('keywordCardBody');
  const icon = document.getElementById('keywordFoldIcon');
  const open = body.style.display === 'none';
  body.style.display = open ? '' : 'none';
  icon.style.transform = open ? 'rotate(180deg)' : '';
  if (open) renderKeywordTable();
}
function renderKeywordTable() {
  const tbody = document.getElementById('keywordTableBody');
  if (!tbody) return;
  tbody.innerHTML = PRODUCT_KEYWORDS.map((kw, i) => `
    <tr>
      <td><input class="edit-input" style="width:40px;text-align:center;" value="${kw.priority}" data-kw-idx="${i}" data-kw-field="priority"></td>
      <td><input class="edit-input" style="width:60px;" value="${esc(kw.code)}" data-kw-idx="${i}" data-kw-field="code"></td>
      <td><input class="edit-input" value="${esc(kw.name)}" data-kw-idx="${i}" data-kw-field="name"></td>
      <td><input class="edit-input" value="${esc(kw.keywords[0]||'')}" data-kw-idx="${i}" data-kw-field="kw0"></td>
      <td><input class="edit-input" value="${esc(kw.keywords[1]||'')}" data-kw-idx="${i}" data-kw-field="kw1"></td>
      <td><input class="edit-input" value="${esc(kw.keywords[2]||'')}" data-kw-idx="${i}" data-kw-field="kw2"></td>
      <td><select class="edit-input" style="width:55px;padding:2px;" data-kw-idx="${i}" data-kw-field="match">
        <option value="AND" ${kw.match==='AND'?'selected':''}>AND</option>
        <option value="OR" ${kw.match==='OR'?'selected':''}>OR</option>
        <option value="SINGLE" ${kw.match==='SINGLE'?'selected':''}>단일</option>
      </select></td>
      <td><button class="btn-icon" onclick="removeKeywordRow(${i})" title="삭제"><span class="material-symbols-outlined" style="font-size:14px;color:#c55;">delete</span></button></td>
    </tr>
  `).join('');
}
function addKeywordRow() {
  const nextPriority = PRODUCT_KEYWORDS.length > 0 ? Math.max(...PRODUCT_KEYWORDS.map(k => k.priority)) + 1 : 1;
  PRODUCT_KEYWORDS.push({priority: nextPriority, code:'', name:'', keywords:['','',''], match:'AND'});
  renderKeywordTable();
  showToast('새 키워드 행이 추가되었습니다');
}
function removeKeywordRow(idx) {
  PRODUCT_KEYWORDS.splice(idx, 1);
  renderKeywordTable();
  showToast('키워드가 삭제되었습니다');
}
function saveKeywords() {
  /* 테이블에서 값 수집 */
  const inputs = document.querySelectorAll('#keywordTableBody input, #keywordTableBody select');
  inputs.forEach(el => {
    const idx = Number(el.dataset.kwIdx);
    const field = el.dataset.kwField;
    if (field === 'priority') PRODUCT_KEYWORDS[idx].priority = Number(el.value) || 0;
    else if (field === 'code') PRODUCT_KEYWORDS[idx].code = el.value.trim();
    else if (field === 'name') PRODUCT_KEYWORDS[idx].name = el.value.trim();
    else if (field === 'kw0') PRODUCT_KEYWORDS[idx].keywords[0] = el.value.trim();
    else if (field === 'kw1') PRODUCT_KEYWORDS[idx].keywords[1] = el.value.trim();
    else if (field === 'kw2') PRODUCT_KEYWORDS[idx].keywords[2] = el.value.trim();
    else if (field === 'match') PRODUCT_KEYWORDS[idx].match = el.value;
  });
  /* 빈 키워드 제거 및 우선순위 정렬 */
  PRODUCT_KEYWORDS.forEach(kw => { kw.keywords = kw.keywords.filter(k => k !== ''); });
  PRODUCT_KEYWORDS.sort((a, b) => a.priority - b.priority);
  localStorage.setItem('productKeywords', JSON.stringify(PRODUCT_KEYWORDS));
  renderKeywordTable();
  showToast('키워드가 저장되었습니다');
}

/* 상품명 키워드 매칭 (코드 포함) */
function matchProductKeywordWithCode(text) {
  if (!text || String(text).trim() === '') return {code:'', name:'미분류'};
  const s = String(text).toLowerCase();
  for (const rule of PRODUCT_KEYWORDS) {
    const kws = rule.keywords.map(k => k.toLowerCase());
    let matched = false;
    if (rule.match === 'AND') {
      matched = kws.every(k => s.includes(k));
    } else if (rule.match === 'OR') {
      matched = kws.some(k => s.includes(k));
    } else {
      matched = kws.some(k => s.includes(k));
    }
    if (matched) {
      const code = rule.code || '';
      /* 공식 제품명 우선 사용 (재고관리 파일 기준) */
      const officialName = code ? getOfficialProductName(code) : null;
      return {code: code, name: officialName || rule.name};
    }
  }
  return {code:'', name:'미분류'};
}
/* 상품명 키워드 매칭 (기존 호환) */
function matchProductKeyword(text) {
  return matchProductKeywordWithCode(text).name;
}

/* 구분 결정: 미분류→포어스토어(모여라딜은 모여라딜), 그 외→그로홈 */
function classifyCategory(productName, shopId) {
  if (productName === '미분류') {
    return shopId === 'moyeora_cafe24' ? '모여라딜' : '포어스토어';
  }
  return '그로홈';
}

const SHOP_MAPPINGS = {
  gro_toss_pay: {
    _v: MAPPING_VERSION,
    label: '자사몰_토스',
    multiSlotMappings: [
      { /* 슬롯0: 가상계좌 */
        slotIndex: 0,
        columns: [
          {name:'매출월', source:null, transform:'selectedMonth'},
          {name:'쇼핑몰', source:null, fixed:'그로홈_토스'},
          {name:'브랜드', source:null, transform:'classifyFromProduct'},
          {name:'제품코드', source:null, transform:'productCode'},
          {name:'제품명', source:null, transform:'keywordMatch'},
          {name:'수량', source:null, joinSource:{slotIndex:2, header:'수량'}},
          {name:'매출금액(v+)', source:'결제·취소액'},
          {name:'매출금액(v-)', source:'결제·취소액', transform:'vatMinus'},
          {name:'정산예정금액', source:'결제·취소액'},
          {name:'판매상품명', source:'구매상품'},
          {name:'옵션명', source:null, joinSource:{slotIndex:2, header:'주문상품명(옵션포함)'}},
          {name:'주문번호', source:'주문번호'},
          {name:'주문일', source:'결제일시'},
          {name:'정산완료일', source:'정산완료일시'}
        ]
      },
      { /* 슬롯1: 계좌이체 */
        slotIndex: 1,
        columns: [
          {name:'매출월', source:null, transform:'selectedMonth'},
          {name:'쇼핑몰', source:null, fixed:'그로홈_토스'},
          {name:'브랜드', source:null, transform:'classifyFromProduct'},
          {name:'제품코드', source:null, transform:'productCode'},
          {name:'제품명', source:null, transform:'keywordMatch'},
          {name:'수량', source:null, joinSource:{slotIndex:2, header:'수량'}},
          {name:'매출금액(v+)', source:'결제·취소액'},
          {name:'매출금액(v-)', source:'결제·취소액', transform:'vatMinus'},
          {name:'정산예정금액', source:'결제·취소액'},
          {name:'판매상품명', source:'구매상품'},
          {name:'옵션명', source:null, joinSource:{slotIndex:2, header:'주문상품명(옵션포함)'}},
          {name:'주문번호', source:'주문번호'},
          {name:'주문일', source:'결제일시'},
          {name:'정산완료일', source:'정산완료일시'}
        ]
      }
    ],
    joins: [
      {slotIndex:2, label:'카페24 상세내역', keySource:'주문번호', targetKey:'주문번호', appendAll:false}
    ]
  },
  gro_kakao: {
    _v: MAPPING_VERSION,
    label: '카카오 톡체크아웃',
    mainSlot: 0,
    columns: [
      {name:'매출월', source:null, transform:'selectedMonth'},
      {name:'쇼핑몰', source:null, fixed:'카카오 톡체크아웃'},
      {name:'브랜드', source:null, transform:'classifyFromProduct'},
      {name:'제품코드', source:null, transform:'productCode'},
      {name:'제품명', source:null, transform:'keywordMatch'},
      {name:'수량', source:'수량', transform:'toNumber'},
      {name:'매출금액(v+)', source:'판매가', transform:'toNumber'},
      {name:'매출금액(v-)', source:'판매가', transform:'vatMinus'},
      {name:'정산예정금액', source:'주문원결제금액', transform:'toNumber'},
      {name:'판매상품명', source:'상품명'},
      {name:'옵션명', source:'옵션명'},
      {name:'주문번호', source:'주문번호'},
      {name:'주문일', source:'결제일'},
      {name:'정산완료일', source:'구매결정일'}
    ]
  },
  gro_kakaotalk: {
    _v: MAPPING_VERSION,
    label: '카카오 톡스토어',
    mainSlot: 0,
    columns: [
      {name:'매출월', source:null, transform:'selectedMonth'},
      {name:'쇼핑몰', source:null, fixed:'카카오 톡스토어'},
      {name:'브랜드', source:null, transform:'classifyFromProduct'},
      {name:'제품코드', source:null, transform:'productCode'},
      {name:'제품명', source:null, transform:'keywordMatch'},
      {name:'수량', source:'수량'},
      {name:'매출금액(v+)', source:'정산기준금액'},
      {name:'매출금액(v-)', source:'정산기준금액', transform:'vatMinus'},
      {name:'정산예정금액', source:'판매정산금액'},
      {name:'판매상품명', source:'상품명'},
      {name:'옵션명', source:'옵션명'},
      {name:'주문번호', source:'주문번호'},
      {name:'주문일', source:'결제일'},
      {name:'정산완료일', source:'구매결정일'}
    ]
  },
  gro_cafe24: {
    _v: MAPPING_VERSION,
    label: '그로홈_카페24',
    mainSlot: 0,
    excludeRows: [{column:'MID', value:'합계'}],
    columns: [
      {name:'매출월', source:null, transform:'selectedMonth'},
      {name:'쇼핑몰', source:null, fixed:'그로홈_카페24'},
      {name:'브랜드', source:null, transform:'classifyFromProduct'},
      {name:'제품코드', source:null, transform:'productCode'},
      {name:'제품명', source:null, transform:'keywordMatch'},
      {name:'수량', source:null, joinSource:{slotIndex:1, header:'수량'}, transform:'qtyByAmountSign', signRef:'과세금액'},
      {name:'매출금액(v+)', source:'과세금액'},
      {name:'매출금액(v-)', source:'과세금액', transform:'vatMinus'},
      {name:'정산예정금액', source:'총금액'},
      {name:'판매상품명', source:null, joinSource:{slotIndex:1, header:'주문상품명'}},
      {name:'옵션명', source:null, joinSource:{slotIndex:1, header:'주문상품명(옵션포함)'}},
      {name:'주문번호', source:'주문번호'},
      {name:'주문일', source:'거래일시'},
      {name:'정산완료일', source:null, fixed:''}
    ],
    joins: [
      {slotIndex:1, label:'상세내역', keySource:'주문번호', targetKey:'주문번호', appendAll:false}
    ]
  },
  moyeora_cafe24: {
    _v: MAPPING_VERSION,
    label: '모여라딜_카페24',
    mainSlot: 0,
    excludeRows: [{column:'MID', value:'합계'}],
    columns: [
      {name:'매출월', source:null, transform:'selectedMonth'},
      {name:'쇼핑몰', source:null, fixed:'모여라딜'},
      {name:'브랜드', source:null, transform:'classifyFromProduct'},
      {name:'제품코드', source:null, transform:'productCode'},
      {name:'제품명', source:null, transform:'keywordMatch'},
      {name:'수량', source:null, joinSource:{slotIndex:1, header:'수량'}, transform:'qtyByAmountSign', signRef:'과세금액'},
      {name:'매출금액(v+)', source:'과세금액'},
      {name:'매출금액(v-)', source:'과세금액', transform:'vatMinus'},
      {name:'정산예정금액', source:'총금액'},
      {name:'판매상품명', source:null, joinSource:{slotIndex:1, header:'주문상품명'}},
      {name:'옵션명', source:null, joinSource:{slotIndex:1, header:'주문상품명(옵션포함)'}},
      {name:'주문번호', source:'주문번호'},
      {name:'주문일', source:'거래일시'},
      {name:'정산완료일', source:null, fixed:''}
    ],
    joins: [
      {slotIndex:1, label:'상세내역', keySource:'주문번호', targetKey:'주문번호', appendAll:false}
    ]
  },
  pour_kg: {
    _v: MAPPING_VERSION,
    label: 'KG이니시스',
    mainSlot: 0,
    columns: [
      {name:'매출월',   source:'승인일', transform:'monthSerial'},
      {name:'쇼핑몰',   source:null, fixed:'포어스토어_kg'},
      {name:'브랜드',     source:null, transform:'classifyFromProduct'},
      {name:'제품코드', source:null, transform:'productCode'},
      {name:'제품명',   source:null, transform:'keywordMatch'},
      {name:'수량',     source:null, joinSource:{slotIndex:1, header:'구매수량'}},
      {name:'매출금액(v+)', source:'거래금액'},
      {name:'매출금액(v-)', source:'거래금액', transform:'vatMinus'},
      {name:'정산예정금액', source:'지급액'},
      {name:'판매상품명', source:'상품명'},
      {name:'옵션명',   source:null, joinSource:{slotIndex:1, header:'옵션명'}},
      {name:'주문번호', source:'주문번호'},
      {name:'주문일',   source:'승인일'},
      {name:'지급일',   source:'지급일'}
    ],
    appendRaw: false,
    joins: [
      {slotIndex:1, label:'아임웹', keySource:'주문번호', keyTransform:'removePSuffix', targetKey:'주문번호', appendAll:false}
    ]
  },
  both_naver_pour: {
    _v: MAPPING_VERSION,
    label: '포어_네이버페이',
    mainSlot: 0,
    mergeShipping: {categoryCol:'구분', shippingValue:'배송비', groupByCol:'주문번호', sumCols:['정산기준금액','정산예정금액','Npay 수수료']},
    columns: [
      {name:'매출월',       source:'세금신고기준일', transform:'monthStartText'},
      {name:'쇼핑몰',       source:null, fixed:'포어스토어_네이버페이'},
      {name:'브랜드',         source:null, transform:'classifyFromProduct'},
      {name:'제품코드',     source:null, transform:'productCode'},
      {name:'제품명',       source:null, transform:'keywordMatch'},
      {name:'수량',         source:'구분', transform:'qtyFromJoinOrZero'},
      {name:'매출금액(v+)', source:'정산기준금액'},
      {name:'매출금액(v-)', source:'정산기준금액', transform:'vatMinus'},
      {name:'정산예정금액',  source:'정산예정금액'},
      {name:'판매상품명',    source:'상품명'},
      {name:'옵션명',       source:null, joinSource:{slotIndex:1, header:'옵션정보'}},
      {name:'주문번호',     source:'상품주문번호'},
      {name:'주문일',       source:'결제일'},
      {name:'정산완료일',    source:'정산완료일'}
    ],
    appendRaw: false,
    joins: [
      {slotIndex:1, label:'구매확정내역', keySource:'상품주문번호', targetKey:'상품주문번호', appendAll:false}
    ]
  },
  pour_navimro: {
    _v: MAPPING_VERSION,
    label: '나비엠알오',
    mainSlot: 0,
    customParse: 'navimro',
    columns: [
      {name:'매출월',       source:'매입일', transform:'navimroMonth'},
      {name:'쇼핑몰',       source:null, fixed:'나비엠알오'},
      {name:'브랜드',         source:null, transform:'classifyFromProduct'},
      {name:'제품코드',     source:null, transform:'productCode'},
      {name:'제품명',       source:null, transform:'keywordMatch'},
      {name:'수량',         source:'매입수량'},
      {name:'매출금액(v+)', source:'매입액(VAT포함)'},
      {name:'매출금액(v-)', source:'매입액(VAT포함)', transform:'vatMinus'},
      {name:'정산예정금액', source:'매입액(VAT포함)'},
      {name:'상품명',       source:'상품명', transform:'navimroProdName'},
      {name:'옵션명',       source:'옵션'},
      {name:'주문번호',     source:'발주번호'},
      {name:'주문일',       source:'발주일'},
      {name:'정산완료일',   source:null, fixed:''}
    ],
    appendRaw: false,
    joins: []
  },
  both_naver_gro: {
    _v: MAPPING_VERSION,
    label: '그로홈_네이버페이',
    mainSlot: 0,
    mergeShipping: {categoryCol:'구분', shippingValue:'배송비', groupByCol:'주문번호', sumCols:['정산기준금액','정산예정금액','Npay 수수료']},
    columns: [
      {name:'매출월',       source:'세금신고기준일', transform:'monthStartText'},
      {name:'쇼핑몰',       source:null, fixed:'그로홈_네이버페이'},
      {name:'브랜드',         source:null, transform:'classifyFromProduct'},
      {name:'제품코드',     source:null, transform:'productCode'},
      {name:'제품명',       source:null, transform:'keywordMatch'},
      {name:'수량',         source:'구분', transform:'qtyFromJoinOrZero'},
      {name:'매출금액(v+)', source:'정산기준금액'},
      {name:'매출금액(v-)', source:'정산기준금액', transform:'vatMinus'},
      {name:'정산예정금액',  source:'정산예정금액'},
      {name:'판매상품명',    source:'상품명'},
      {name:'옵션명',       source:null, joinSource:{slotIndex:1, header:'옵션정보'}},
      {name:'주문번호',     source:'상품주문번호'},
      {name:'주문일',       source:'결제일'},
      {name:'정산완료일',    source:'정산완료일'}
    ],
    appendRaw: false,
    joins: [
      {slotIndex:1, label:'구매확정내역', keySource:'상품주문번호', targetKey:'상품주문번호', appendAll:false}
    ]
  },
  both_smart_pour: {
    _v: MAPPING_VERSION,
    label: '스마트스토어_포어',
    mainSlot: 0,
    mergeShipping: {categoryCol:'구분', shippingValue:'배송비', groupByCol:'주문번호', sumCols:['정산기준금액','정산예정금액','Npay 수수료']},
    columns: [
      {name:'매출월',       source:'세금신고기준일', transform:'monthStartText'},
      {name:'쇼핑몰',       source:null, fixed:'스마트스토어_포어'},
      {name:'브랜드',         source:null, transform:'classifyFromProduct'},
      {name:'제품코드',     source:null, transform:'productCode'},
      {name:'제품명',       source:null, transform:'keywordMatch'},
      {name:'수량',         source:'구분', transform:'qtyFromJoinOrZero'},
      {name:'매출금액(v+)', source:'정산기준금액'},
      {name:'매출금액(v-)', source:'정산기준금액', transform:'vatMinus'},
      {name:'정산예정금액',  source:'정산예정금액'},
      {name:'판매상품명',    source:'상품명'},
      {name:'옵션명',       source:null, joinSource:{slotIndex:1, header:'옵션정보'}},
      {name:'주문번호',     source:'상품주문번호'},
      {name:'주문일',       source:'결제일'},
      {name:'정산완료일',    source:'정산완료일'}
    ],
    appendRaw: false,
    joins: [
      {slotIndex:1, label:'구매확정내역', keySource:'상품주문번호', targetKey:'상품주문번호', appendAll:false}
    ]
  },
  both_smart_gro: {
    _v: MAPPING_VERSION,
    label: '스마트스토어_그로홈',
    mainSlot: 0,
    mergeShipping: {categoryCol:'구분', shippingValue:'배송비', groupByCol:'주문번호', sumCols:['정산기준금액','정산예정금액','Npay 수수료']},
    columns: [
      {name:'매출월',       source:'세금신고기준일', transform:'monthStartText'},
      {name:'쇼핑몰',       source:null, fixed:'스마트스토어_그로홈'},
      {name:'브랜드',         source:null, transform:'classifyFromProduct'},
      {name:'제품코드',     source:null, transform:'productCode'},
      {name:'제품명',       source:null, transform:'keywordMatch'},
      {name:'수량',         source:'구분', transform:'qtyFromJoinOrZero'},
      {name:'매출금액(v+)', source:'정산기준금액'},
      {name:'매출금액(v-)', source:'정산기준금액', transform:'vatMinus'},
      {name:'정산예정금액',  source:'정산예정금액'},
      {name:'판매상품명',    source:'상품명'},
      {name:'옵션명',       source:null, joinSource:{slotIndex:1, header:'옵션정보'}},
      {name:'주문번호',     source:'상품주문번호'},
      {name:'주문일',       source:'결제일'},
      {name:'정산완료일',    source:'정산완료일'}
    ],
    appendRaw: false,
    joins: [
      {slotIndex:1, label:'구매확정내역', keySource:'상품주문번호', targetKey:'상품주문번호', appendAll:false}
    ]
  },
  pour_bucket: {
    _v: MAPPING_VERSION,
    label: '오늘의집',
    mainSlot: 0,
    mergeShipping: {categoryCol:'상품명', shippingValue:'배송비', groupByCol:'주문번호', sumCols:['정산금액','결제금액']},
    columns: [
      {name:'매출월',       source:'구매확정/취소일', transform:'monthStartText'},
      {name:'쇼핑몰',       source:null, fixed:'오늘의집'},
      {name:'브랜드',         source:null, transform:'classifyFromProduct'},
      {name:'제품코드',     source:null, transform:'productCode'},
      {name:'제품명',       source:null, transform:'keywordMatch'},
      {name:'수량',         source:'개수', transform:'toNumber'},
      {name:'매출금액(v+)', source:'결제금액', transform:'toNumber'},
      {name:'매출금액(v-)', source:'결제금액', transform:'vatMinus'},
      {name:'정산예정금액',  source:'정산금액', transform:'toNumber'},
      {name:'판매상품명',    source:'상품명'},
      {name:'옵션명',       source:null, fixed:''},
      {name:'주문번호',     source:'주문번호'},
      {name:'주문일',       source:'구매확정/취소일'},
      {name:'정산완료일',    source:'구매확정/취소일'}
    ],
    appendRaw: false,
    joins: []
  },
  pour_gmarket: {
    _v: MAPPING_VERSION,
    label: '지마켓',
    mainSlot: 0,
    mergeShippingByOrder: {
      shippingSlot: 1,
      mainOrderCol: '주문번호',
      shippingOrderCol: '대표주문번호',
      shippingAmountCol: '배송비',
      shippingSettleCol: '배송비정산금액',
      addToSales: '고객결제금(구. 구매대금)',
      addToSettle: '판매자 최종정산금'
    },
    columns: [
      {name:'매출월',       source:'구매결정일', transform:'monthStartText'},
      {name:'쇼핑몰',       source:null, fixed:'지마켓'},
      {name:'브랜드',         source:null, transform:'classifyFromProduct'},
      {name:'제품코드',     source:null, transform:'productCode'},
      {name:'제품명',       source:null, transform:'keywordMatch'},
      {name:'수량',         source:'주문수량', transform:'toNumber'},
      {name:'매출금액(v+)', source:'고객결제금(구. 구매대금)', transform:'toNumber'},
      {name:'매출금액(v-)', source:'고객결제금(구. 구매대금)', transform:'vatMinus'},
      {name:'정산예정금액',  source:'판매자 최종정산금', transform:'toNumber'},
      {name:'판매상품명',    source:'상품명'},
      {name:'옵션명',       source:'옵션상품'},
      {name:'주문번호',     source:'주문번호'},
      {name:'주문일',       source:'구매결정일'},
      {name:'정산완료일',    source:'정산완료일'}
    ],
    appendRaw: false,
    joins: []
  },
  pour_domegook: {
    _v: MAPPING_VERSION,
    label: '도매꾹',
    mainSlot: 0,
    columns: [
      {name:'매출월',       source:null, transform:'selectedMonth'},
      {name:'쇼핑몰',       source:null, fixed:'도매꾹'},
      {name:'브랜드',         source:null, transform:'classifyFromProduct'},
      {name:'제품코드',     source:null, transform:'productCode'},
      {name:'제품명',       source:null, transform:'keywordMatch'},
      {name:'수량',         source:'주문수량'},
      {name:'매출금액(v+)', source:'적립예정금액', transform:'addShipping', shippingSource:'판매수수료'},
      {name:'매출금액(v-)', source:'적립예정금액', transform:'addShippingVatMinus', shippingSource:'판매수수료'},
      {name:'정산예정금액',  source:'적립예정금액'},
      {name:'판매상품명',    source:'상품명'},
      {name:'옵션명',       source:'상품주문옵션'},
      {name:'주문번호',     source:'주문번호'},
      {name:'주문일',       source:'구매확정일'},
      {name:'정산완료일',    source:'적립일시'}
    ],
    appendRaw: false,
    joins: []
  },
  pour_coupang: {
    _v: MAPPING_VERSION,
    label: '쿠팡',
    multiSlotMappings: [
      { /* 슬롯0: 중개(위탁) */
        slotIndex: 0,
        slotLabel: '중개(위탁)',
        shopName: '쿠팡',
        /* 배송비 합산: 옵션 ID에 '배송료' 포함 시 주문번호로 그룹핑하여 판매액/정산금액 합산 후 배송비 행 제거 */
        mergeShipping: {
          categoryCol: '옵션 ID',
          shippingValue: '<기본배송료>',
          shippingValue2: '<추가배송료>',
          groupByCol: '주문번호',
          sumCols: ['판매액', '정산금액']
        },
        columns: [
          {name:'매출월',       source:null, transform:'selectedMonth'},
          {name:'쇼핑몰',       source:null, fixed:'쿠팡'},
          {name:'브랜드',         source:null, transform:'classifyFromProduct'},
          {name:'제품코드',     source:null, transform:'productCode'},
          {name:'제품명',       source:null, transform:'keywordMatch'},
          {name:'수량',         source:'판매수량'},
          {name:'매출금액(v+)', source:'판매액'},
          {name:'매출금액(v-)', source:'판매액', transform:'vatMinus'},
          {name:'정산예정금액', source:'정산금액'},
          {name:'판매상품명',   source:'상품명', transform:'removeQuotes'},
          {name:'옵션명',       source:'옵션명', transform:'removeQuotes'},
          {name:'주문번호',     source:'주문번호', transform:'textPrefix'},
          {name:'주문일',       source:'결제완료일'},
          {name:'정산완료일',   source:'정산예정일'}
        ]
      },
      { /* 슬롯1: 로켓그로스 - 벤더아이템별 지표 양식 */
        slotIndex: 1,
        slotLabel: '로켓그로스',
        shopName: '쿠팡_로켓그로스',
        /* 로켓그로스 원본 컬럼: 옵션 ID, 옵션명, 상품명, 매출(원), 판매량 등 */
        columns: [
          {name:'매출월',       source:null, transform:'selectedMonth'},
          {name:'쇼핑몰',       source:null, fixed:'쿠팡_로켓그로스'},
          {name:'브랜드',         source:'상품명', transform:'classifyFromProductDirect'},
          {name:'제품코드',     source:'상품명', transform:'productCodeDirect'},
          {name:'제품명',       source:'상품명', transform:'keywordMatchDirect'},
          {name:'수량',         source:'판매량'},
          {name:'매출금액(v+)', source:'매출(원)'},
          {name:'매출금액(v-)', source:'매출(원)', transform:'vatMinus'},
          {name:'정산예정금액', source:'매출(원)'},
          {name:'판매상품명',   source:'상품명', transform:'removeQuotes'},
          {name:'옵션명',       source:'옵션명', transform:'removeQuotes'},
          {name:'주문번호',     source:'옵션 ID'},
          {name:'주문일',       source:null, fixed:''},
          {name:'정산완료일',   source:null, fixed:''}
        ]
      }
    ],
    appendRaw: false,
    joins: []
  },

  /* 계좌입금 매출 (더존 계정별원장) */
  pour_offline: {
    _v: MAPPING_VERSION,
    label: '계좌입금 매출',
    multiSlotMappings: [
      {
        slotIndex: 0,
        columns: [
          {name:'매출월',       source:null, transform:'selectedMonth'},
          {name:'쇼핑몰',       source:null, fixed:'계좌입금'},
          {name:'브랜드',       source:'적요', transform:'brandFromBracket'},
          {name:'제품코드',     source:null, fixed:''},
          {name:'제품명',       source:'적요', transform:'removeQuotes'},
          {name:'수량',         source:null, fixed:'1'},
          {name:'매출금액(v+)', source:'대변'},
          {name:'매출금액(v-)', source:'대변', transform:'vatMinus'},
          {name:'정산예정금액', source:'대변'},
          {name:'판매상품명',   source:'적요', transform:'removeQuotes'},
          {name:'옵션명',       source:'거래처', transform:'removeQuotes'},
          {name:'주문번호',     source:null, fixed:''},
          {name:'주문일',       source:'일자'},
          {name:'정산완료일',   source:'일자'}
        ]
      }
    ],
    appendRaw: false,
    joins: []
  }
};

/* 매핑 저장/불러오기 */
function getMappingConfig(shopId) {
  const saved = localStorage.getItem('mapping_' + shopId);
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      if (parsed._v === MAPPING_VERSION) return parsed;
      localStorage.removeItem('mapping_' + shopId);
    } catch(e) {}
  }
  return SHOP_MAPPINGS[shopId] ? JSON.parse(JSON.stringify(SHOP_MAPPINGS[shopId])) : null;
}
function saveMappingConfig(shopId, config) {
  localStorage.setItem('mapping_' + shopId, JSON.stringify(config));
}

/* 파일 저장소 (세션) */
const UPLOAD_FILES = {};
function getUploadKey(shopId, slotIdx, subTabId) { return (subTabId || shopId) + '_slot_' + slotIdx; }

/* 쿠팡 전용: 중개(위탁) / 로켓그로스 2개 업로드 카드 */
function buildCoupangUploadCards(shop, gc, ic, boxClass) {
  const mapping = SHOP_MAPPINGS[shop.id];
  if (!mapping) return '';
  const dataPaths = getShopSetting(shop.id, 'dataPaths');
  if (!dataPaths || !Array.isArray(dataPaths) || dataPaths.length < 2) return buildUploadCard(shop, gc, ic, boxClass);

  /* 기존 UI 스타일: 하나의 카드 안에 가로로 슬롯 배치 */
  let slotsHtml = '';
  dataPaths.forEach((dp, i) => {
    const key = getUploadKey(shop.id, i);
    const fileInfo = UPLOAD_FILES[key];
    slotsHtml += `
      <div class="upload-slot">
        <div class="upload-slot-label">
          <span>${dp.label}</span>
          ${fileInfo ? '<span class="badge-ok">✓ ' + fileInfo.name + ' (' + fileInfo.rowCount + '행) <span onclick="event.stopPropagation();clearUploadFile(\'' + key + '\',\'' + shop.id + '\',' + i + ',\'\')" style="cursor:pointer;color:#94a3b8;font-weight:700;margin-left:4px;" title="삭제">✕</span></span>' : ''}
        </div>
        <div class="upload-dropzone ${fileInfo ? 'has-file' : ''}" id="dropzone_${key}"
             ondragover="event.preventDefault();this.classList.add('dragover')"
             ondragleave="this.classList.remove('dragover')"
             ondrop="event.preventDefault();this.classList.remove('dragover');handleFileDrop(event,'${shop.id}',${i},'')"
             onclick="document.getElementById('fileInput_${key}').click()">
          <span class="material-symbols-outlined">${fileInfo ? 'description' : 'upload_file'}</span>
          <span>${fileInfo ? fileInfo.name : '드래그 또는 클릭 (.xlsx)'}</span>
        </div>
        <input type="file" id="fileInput_${key}" accept=".xlsx,.xls,.csv" style="display:none"
               onchange="handleFileSelect(event,'${shop.id}',${i},'')">
      </div>`;
  });

  const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shop.id, i)]);
  return `
    <div class="card" style="--gc:var(--${gc})">
      <div class="card-header">
        <div class="card-header-icon ${ic}"><span class="material-symbols-outlined" style="font-size:16px;">upload_file</span></div>
        <div><div class="card-header-title">데이터 취합</div><div class="card-header-sub">엑셀 업로드 → 매핑 → 통합 다운로드</div></div>
        <div class="card-header-right">
          <button class="btn-icon" onclick="toggleMappingUI('${shop.id}')" title="매핑 설정"><span class="material-symbols-outlined">settings</span></button>
        </div>
      </div>
      <div class="card-body">
        <div class="checkpoint-box ${boxClass}">
          <div class="upload-slots-grid">${slotsHtml}</div>
          <div style="padding:10px 16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <button class="btn-merge" id="mergeBtn_${shop.id}" onclick="executeMerge('${shop.id}', false, '')" ${allUploaded ? '' : 'disabled'}>
              <span class="material-symbols-outlined">download</span> 엑셀 다운로드
            </button>
          </div>
          <div class="verify-box" id="verify_${shop.id}"></div>
          <div id="mappingUI_${shop.id}" style="display:none;padding:10px 16px;"></div>
        </div>
      </div>
    </div>`;
}

/* 업로드 카드 HTML */
function buildUploadCard(shop, gc, ic, boxClass, subTabId) {
  const mergeId = subTabId || shop.id;
  const mapping = SHOP_MAPPINGS[shop.id];
  if (!mapping) return '';
  /* uploadPaths가 있으면 업로드용으로 사용, 없으면 dataPaths 사용 */
  const shopObj = SHOPS.find(s => s.id === shop.id);
  const uploadPaths = shopObj && shopObj.uploadPaths ? shopObj.uploadPaths : getShopSetting(shop.id, 'dataPaths');
  if (!uploadPaths || !Array.isArray(uploadPaths) || uploadPaths.length === 0) return '';
  const dataPaths = uploadPaths; /* 하위 호환을 위해 변수명 유지 */
  let slotsHtml = '';
  dataPaths.forEach((dp, i) => {
    const key = getUploadKey(shop.id, i, subTabId);
    const fileInfo = UPLOAD_FILES[key];
    slotsHtml += `
      <div class="upload-slot">
        <div class="upload-slot-label">
          <span>${dp.label}</span>
          ${fileInfo ? '<span class="badge-ok">✓ ' + fileInfo.name + ' (' + fileInfo.rowCount + '행) <span onclick="event.stopPropagation();clearUploadFile(\'' + key + '\',\'' + shop.id + '\',' + i + ',\'' + (subTabId||'') + '\')" style="cursor:pointer;color:#94a3b8;font-weight:700;margin-left:4px;" title="삭제">✕</span></span>' : ''}
        </div>
        <div class="upload-dropzone ${fileInfo ? 'has-file' : ''}" id="dropzone_${key}"
             ondragover="event.preventDefault();this.classList.add('dragover')"
             ondragleave="this.classList.remove('dragover')"
             ondrop="event.preventDefault();this.classList.remove('dragover');handleFileDrop(event,'${shop.id}',${i},'${subTabId||''}')"
             onclick="document.getElementById('fileInput_${key}').click()">
          <span class="material-symbols-outlined">${fileInfo ? 'description' : 'upload_file'}</span>
          <span>${fileInfo ? fileInfo.name : '드래그 또는 클릭 (.xlsx)'}</span>
        </div>
        <input type="file" id="fileInput_${key}" accept=".xlsx,.xls,.csv" style="display:none"
               onchange="handleFileSelect(event,'${shop.id}',${i},'${subTabId||''}')">
      </div>`;
  });
  const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shop.id, i, subTabId)]);
  return `
    <div class="card" style="--gc:var(--${gc})">
      <div class="card-header">
        <div class="card-header-icon ${ic}"><span class="material-symbols-outlined" style="font-size:16px;">upload_file</span></div>
        <div><div class="card-header-title">데이터 취합</div><div class="card-header-sub">엑셀 업로드 → 매핑 → 통합 다운로드</div></div>
        <div class="card-header-right">
          <button class="btn-icon" onclick="toggleMappingUI('${mergeId}')" title="매핑 설정"><span class="material-symbols-outlined">settings</span></button>
        </div>
      </div>
      <div class="card-body">
        <div class="checkpoint-box ${boxClass}">
          <div class="upload-slots-grid">${slotsHtml}</div>
          <div style="padding:10px 16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <button class="btn-merge" id="mergeBtn_${mergeId}" onclick="executeMerge('${shop.id}',false,'${subTabId||''}')" ${allUploaded ? '' : 'disabled'}>
              <span class="material-symbols-outlined">download</span> 엑셀 다운로드
            </button>
          </div>
          <div class="verify-box" id="verify_${mergeId}"></div>
          <div id="mappingUI_${mergeId}" style="display:none;padding:10px 16px;"></div>
        </div>
      </div>
    </div>`;
}

/* 파일 드롭/선택 처리 */
function handleFileDrop(event, shopId, slotIdx, subTabId) {
  const file = event.dataTransfer.files[0];
  if (file) parseUploadedFile(file, shopId, slotIdx, subTabId);
}
function handleFileSelect(event, shopId, slotIdx, subTabId) {
  const file = event.target.files[0];
  if (file) parseUploadedFile(file, shopId, slotIdx, subTabId);
}
/* 파일 삭제 (X 버튼): 기존 파일 삭제 후 UI 갱신 */
function clearUploadFile(key, shopId, slotIdx, subTabId) {
  delete UPLOAD_FILES[key];
  const input = document.getElementById('fileInput_' + key);
  if (input) input.value = '';
  /* UI 갱신 - 해당 쇼핑몰만 갱신 (전체 리렌더 방지) */
  refreshShopContent(shopId);
  showToast('파일이 삭제되었습니다.');
}
function parseUploadedFile(file, shopId, slotIdx, subTabId, password) {
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const opts = {type:'array'};
      if (password) opts.password = password;
      const wb = XLSX.read(e.target.result, opts);
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:''});
      if (json.length < 2) { showToast('데이터가 없습니다'); return; }
      /* 나비엠알오 커스텀 파싱: 헤더가 row7(index 7), 데이터는 row8~ */
      const mapping = SHOP_MAPPINGS[shopId];
      let headers, rows;
      if (mapping && mapping.customParse === 'navimro') {
        const headerRowIdx = json.findIndex((r, i) => i >= 5 && r.length > 5 && String(r[0] || '').includes('발주번호'));
        if (headerRowIdx < 0) { showToast('나비엠알오 매입원장 헤더를 찾을 수 없습니다'); return; }
        headers = json[headerRowIdx].map(h => String(h).replace(/\n/g,' ').trim());
        rows = json.slice(headerRowIdx + 1).filter(r => r.some(c => c !== '') && String(r[0] || '').trim() !== '');
      } else {
        headers = json[0].map(h => String(h).trim());
        rows = json.slice(1).filter(r => r.some(c => c !== ''));
      }
      const key = getUploadKey(shopId, slotIdx, subTabId || undefined);
      UPLOAD_FILES[key] = {name: file.name, headers: headers, rows: rows, rowCount: rows.length};
      refreshShopContent(shopId);
      showToast(file.name + ' 업로드 완료 (' + rows.length + '행)');
      updateMappingDropdowns(shopId, slotIdx);
      /* 모여라딜 업로드 시 분류별 매출 자동 계산 */
      if (shopId === 'moyeora_cafe24') updateMoyeoraCategorySales();
      /* 계좌입금 업로드 시 브랜드별 매출 자동 계산 */
      if (shopId === 'pour_offline') updateOfflineCategorySales();
    } catch(err) {
      if (!password && (err.message.includes('password') || err.message.includes('encrypt') || err.message.includes('cfb'))) {
        const pw = prompt('암호가 설정된 파일입니다. 비밀번호를 입력하세요:');
        if (pw) parseUploadedFile(file, shopId, slotIdx, subTabId, pw);
        else showToast('업로드 취소');
      } else {
        showToast('파일 파싱 오류: ' + err.message);
      }
    }
  };
  reader.readAsArrayBuffer(file);
}

/* 매핑 설정 UI */
function toggleMappingUI(shopId) {
  const el = document.getElementById('mappingUI_' + shopId);
  if (!el) return;
  if (el.style.display === 'none') {
    el.style.display = 'block';
    renderMappingUI(shopId);
  } else {
    el.style.display = 'none';
  }
}
function renderMappingUI(shopId) {
  const el = document.getElementById('mappingUI_' + shopId);
  if (!el) return;
  const config = getMappingConfig(shopId);
  if (!config) { el.innerHTML = '<div style="color:var(--gray);font-size:0.8rem;">매핑 규칙이 없습니다</div>'; return; }
  const mainFile = UPLOAD_FILES[getUploadKey(shopId, config.mainSlot || 0)];
  const mainHeaders = mainFile ? mainFile.headers : [];
  let html = '<div style="font-size:0.8rem;font-weight:600;margin-bottom:6px;">통합 열 매핑 (메인: ' + (config.label || '') + ')</div>';
  html += '<table class="mapping-table"><thead><tr><th>통합 열</th><th>원본 헤더</th><th>변환</th></tr></thead><tbody>';
  config.columns.forEach((col, ci) => {
    const isFixed = col.fixed !== undefined && col.fixed !== null;
    html += '<tr><td>' + col.name + '</td><td>';
    if (isFixed) {
      html += '<span style="color:var(--gray);font-size:0.75rem;">고정: ' + esc(String(col.fixed)) + '</span>';
    } else if (col.joinSource) {
      html += '<span style="color:#4A7A8E;font-size:0.75rem;">← JOIN: ' + esc(col.joinSource.header) + ' (슬롯 ' + col.joinSource.slotIndex + ')</span>';
    } else {
      html += '<select id="mapSel_' + shopId + '_' + ci + '" onchange="updateMappingSource(\'' + shopId + '\',' + ci + ',this.value)">';
      html += '<option value="">(선택)</option>';
      mainHeaders.forEach(h => {
        html += '<option value="' + esc(h) + '"' + (col.source === h ? ' selected' : '') + '>' + esc(h) + '</option>';
      });
      html += '</select>';
    }
    html += '</td><td style="font-size:0.7rem;color:var(--gray);">' + (col.transform || '-') + '</td></tr>';
  });
  html += '</tbody></table>';
  if (config.joins && config.joins.length > 0) {
    html += '<div style="font-size:0.8rem;font-weight:600;margin:10px 0 6px;">JOIN 설정</div>';
    config.joins.forEach((j, ji) => {
      const joinFile = UPLOAD_FILES[getUploadKey(shopId, j.slotIndex)];
      const joinHeaders = joinFile ? joinFile.headers : [];
      html += '<div style="font-size:0.75rem;margin-bottom:4px;">' + j.label + ' — KEY: ';
      html += '<select id="joinKey_' + shopId + '_' + ji + '" onchange="updateJoinKey(\'' + shopId + '\',' + ji + ',this.value)">';
      html += '<option value="">(선택)</option>';
      joinHeaders.forEach(h => {
        html += '<option value="' + esc(h) + '"' + (j.targetKey === h ? ' selected' : '') + '>' + esc(h) + '</option>';
      });
      html += '</select>';
      html += ' (변환: ' + (j.keyTransform || '없음') + ')</div>';
    });
  }
  html += '<div style="margin-top:8px;"><button class="btn-save" onclick="saveMappingFromUI(\'' + shopId + '\')">매핑 저장</button></div>';
  el.innerHTML = html;
}
function updateMappingSource(shopId, colIdx, value) {
  const config = getMappingConfig(shopId);
  if (config && config.columns[colIdx]) {
    config.columns[colIdx].source = value;
    saveMappingConfig(shopId, config);
  }
}
function updateJoinKey(shopId, joinIdx, value) {
  const config = getMappingConfig(shopId);
  if (config && config.joins && config.joins[joinIdx]) {
    config.joins[joinIdx].targetKey = value;
    saveMappingConfig(shopId, config);
  }
}
function saveMappingFromUI(shopId) {
  showToast('매핑 설정이 저장되었습니다');
}
function updateMappingDropdowns(shopId, slotIdx) {
  const el = document.getElementById('mappingUI_' + shopId);
  if (el && el.style.display !== 'none') renderMappingUI(shopId);
}

/* 변환 함수 */
function transformValue(value, transformType, context, col) {
  if (!transformType) return value;
  switch(transformType) {
    case 'monthSerial': {
      /* 엑셀 시리얼 → "YYYY-MM-01" 텍스트 형식 */
      if (typeof value === 'number' && value > 40000) {
        const d = excelDateToJS(value);
        return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-01';
      }
      return value;
    }
    case 'selectedMonth': {
      /* 사용자가 선택한 월로 고정 (예: 2026-01-01) */
      return currentYear + '-' + String(currentMonth).padStart(2,'0') + '-01';
    }
    case 'monthStartText': {
      /* "2025.01.15" or "2025-01-15" or "2025-01-15 12:30" → "2025-01-01" */
      /* 엑셀 시리얼 넘버 (예: 46051.48) 처리 포함 */
      const s = String(value || '').replace(/\./g, '-');
      const m = s.match(/(\d{4})-(\d{2})/);
      if (m) return m[1] + '-' + m[2] + '-01';
      /* 엑셀 시리얼 넘버 (숫자 또는 문자열) */
      const numVal = Number(value);
      if (!isNaN(numVal) && numVal > 40000 && numVal < 100000) {
        const d = excelDateToJS(numVal);
        return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-01';
      }
      return value;
    }
    case 'vatMinus': {
      const num = Number(String(value).replace(/,/g, ''));
      return isNaN(num) ? value : Math.round(num / 1.1);
    }
    case 'toNumber': {
      /* 문자열을 숫자로 변환 (콤마 제거) */
      const num = Number(String(value || '').replace(/,/g, ''));
      return isNaN(num) ? 0 : num;
    }
    case 'removeQuotes': {
      /* 쌍따옴표 제거 */
      return String(value || '').replace(/"/g, '');
    }
    case 'textPrefix': {
      /* 숫자를 텍스트로 인식시키기 위해 앞에 ' 붙이기 */
      const v = String(value || '');
      return v ? "'" + v : '';
    }
    case 'brandFromBracket': {
      /* 적요에서 대괄호 안의 브랜드명 추출: [그로홈] → 그로홈, [모여라딜] → 모여라딜, [포어스토어] → 포어스토어 */
      const bracketMatch = String(value || '').match(/\[(.+?)\]/);
      if (!bracketMatch) return '포어스토어';
      const bName = bracketMatch[1].trim();
      if (bName === '그로홈') return '그로홈';
      if (bName === '모여라딜') return '모여라딜';
      if (bName === '포어스토어') return '포어스토어';
      return '포어스토어';
    }
    case 'classifyFromProductDirect': {
      /* 상품명 value에서 직접 분류 추출 (로켓그로스용) */
      const text = String(value || '').replace(/"/g, '');
      const matchedName = matchProductKeyword(text);
      return classifyCategory(matchedName);
    }
    case 'productCodeDirect': {
      /* 상품명 value에서 직접 제품코드 추출 (로켓그로스용) */
      const text = String(value || '').replace(/"/g, '');
      const result = matchProductKeywordWithCode(text);
      return result.code || '';
    }
    case 'keywordMatchDirect': {
      /* 상품명 value에서 직접 제품명 매칭 (로켓그로스용) */
      const text = String(value || '').replace(/"/g, '');
      return matchProductKeyword(text);
    }
    case 'qtyByAmountSign': {
      /* 매출금액이 음수이면 수량도 음수로 변환 */
      const qty = Number(value) || 0;
      if (col.signRef && context && context._row && context._headers) {
        const signIdx = context._headers.indexOf(col.signRef);
        if (signIdx >= 0) {
          const amountVal = Number(String(context._row[signIdx]).replace(/,/g, '')) || 0;
          return amountVal < 0 ? -Math.abs(qty) : Math.abs(qty);
        }
      }
      return qty;
    }
    case 'addShipping': {
      /* 상품금액 + 배송비 합산 */
      const base = Number(String(value).replace(/,/g, '').replace(/-/g, '').trim()) || 0;
      const shipCol = col.shippingSource;
      let ship = 0;
      if (shipCol && context && context._row && context._headers) {
        /* 헤더에 공백/대괄호 포함된 경우를 위해 정규화 비교 */
        const normalize = s => String(s).replace(/[\[\]\s]/g, '');
        const shipIdx = context._headers.findIndex(h => normalize(h) === normalize(shipCol));
        if (shipIdx >= 0) ship = Number(String(context._row[shipIdx] || 0).replace(/,/g, '').replace(/-/g, '').trim()) || 0;
      }
      return base + ship;
    }
    case 'addShippingVatMinus': {
      /* 상품금액 + 배송비 합산 후 VAT 제외 */
      const base = Number(String(value).replace(/,/g, '').replace(/-/g, '').trim()) || 0;
      const shipCol = col.shippingSource;
      let ship = 0;
      if (shipCol && context && context._row && context._headers) {
        /* 헤더에 공백/대괄호 포함된 경우를 위해 정규화 비교 */
        const normalize = s => String(s).replace(/[\[\]\s]/g, '');
        const shipIdx = context._headers.findIndex(h => normalize(h) === normalize(shipCol));
        if (shipIdx >= 0) ship = Number(String(context._row[shipIdx] || 0).replace(/,/g, '').replace(/-/g, '').trim()) || 0;
      }
      return Math.round((base + ship) / 1.1);
    }
    case 'keywordMatch': {
      /* 상품명만 반환 */
      return context && context._productName ? context._productName : '미분류';
    }
    case 'productCode': {
      /* 제품코드만 반환 */
      return context && context._productCode ? context._productCode : '';
    }
    case 'classifyFromProduct': {
      const defaultVal = context && context._shopId === 'moyeora_cafe24' ? '모여라딜' : '포어스토어';
      return context && context._productName ? classifyCategory(context._productName, context._shopId) : defaultVal;
    }
    case 'navimroMonth': {
      /* 나비엠알오 매입일: "2026/01/05" → "YYYY-MM-01" 텍스트 형식 */
      const s = String(value || '').replace(/\./g, '/');
      const m = s.match(/(\d{4})\/(\d{2})/);
      if (m) {
        return m[1] + '-' + m[2] + '-01';
      }
      return value;
    }
    case 'navimroProdName': {
      /* 상품명 + "-" + 옵션 결합 */
      if (context && context._rawOption) return String(value || '') + '-' + context._rawOption;
      return value;
    }
    case 'qtyFromJoinOrZero': {
      /* 원본.구분이 "배송비"이면 0, 아니면 JOIN에서 수량 가져오기 */
      const catVal = String(value || '');
      if (catVal === '배송비') return 0;
      if (context && context._joinQty !== undefined) return context._joinQty;
      return '';
    }
    default: return value;
  }
}
function removePSuffix(orderNum) {
  if (!orderNum) return '';
  return String(orderNum).replace(/-P\d+$/, '');
}
function excelDateToJS(serial) {
  const epoch = new Date(1899, 11, 30);
  return new Date(epoch.getTime() + serial * 86400000);
}
function jsDateToExcel(date) {
  const epoch = new Date(1899, 11, 30);
  return Math.round((date.getTime() - epoch.getTime()) / 86400000);
}

/* 슬롯별 매핑 처리 (multiSlotMappings용) */
function executeSlotMerge(shopId, mainData, config, stId) {
  if (!mainData || !config) return null;

  /* 디버깅: 헤더 확인 */
  console.log('=== executeSlotMerge 디버깅 ===');
  console.log('shopId:', shopId);
  console.log('mainData.headers:', JSON.stringify(mainData.headers));
  console.log('mainData.rows.length:', mainData.rows.length);
  if (mainData.rows.length > 0) console.log('첫번째 행:', JSON.stringify(mainData.rows[0]));
  console.log('config.columns:', config.columns.map(c => ({name: c.name, source: c.source})));

  /* excludeRows 필터링 */
  if (config.excludeRows) {
    const filteredRows = mainData.rows.filter(row => {
      for (const excl of config.excludeRows) {
        const exclIdx = mainData.headers.indexOf(excl.column);
        if (exclIdx >= 0 && String(row[exclIdx] || '').trim() === excl.value) {
          return false;
        }
      }
      return true;
    });
    mainData = {...mainData, rows: filteredRows};
  }

  const resultHeaders = config.columns.map(c => c.name);
  const resultRows = [];

  /* JOIN 데이터 준비 */
  const joinDataMap = {};
  if (config.joins) {
    config.joins.forEach((j, ji) => {
      const jData = UPLOAD_FILES[getUploadKey(shopId, j.slotIndex, stId)];
      if (jData) {
        const keyIdx = jData.headers.indexOf(j.targetKey);
        const map = {};
        jData.rows.forEach(row => {
          const key = String(row[keyIdx] || '').trim();
          if (key && !map[key]) map[key] = row;
        });
        joinDataMap[j.slotIndex] = {data: jData, keyIdx, map};
      }
    });
  }

  /* 행별 매핑 */
  mainData.rows.forEach(row => {
    /* JOIN 행 찾기 */
    const joinedRows = {};
    if (config.joins) {
      config.joins.forEach(j => {
        const keySourceIdx = mainData.headers.indexOf(j.keySource);
        if (keySourceIdx >= 0 && joinDataMap[j.slotIndex]) {
          const keyVal = String(row[keySourceIdx] || '').trim();
          joinedRows[j.slotIndex] = joinDataMap[j.slotIndex].map[keyVal] || null;
        }
      });
    }

    /* 키워드 매칭용 텍스트 */
    const prodNameCol = config.columns.find(c => c.name === '판매상품명');
    let prodNameText = '';
    if (prodNameCol && prodNameCol.source) {
      const pIdx = mainData.headers.indexOf(prodNameCol.source);
      if (pIdx >= 0) prodNameText = String(row[pIdx] || '');
    }
    const matchResult = matchProductKeywordWithCode(prodNameText);
    const matchedProduct = matchResult.name;
    const matchedCode = matchResult.code;

    const rowContext = {_productName: matchedProduct, _productCode: matchedCode, _row: row, _headers: mainData.headers, _shopId: shopId};

    const out = [];
    config.columns.forEach(col => {
      if (col.fixed !== undefined && col.fixed !== null) {
        out.push(col.fixed);
      } else if (col.joinSource) {
        const jRow = joinedRows[col.joinSource.slotIndex];
        const jInfo = joinDataMap[col.joinSource.slotIndex];
        if (jRow && jInfo) {
          const hIdx = jInfo.data.headers.indexOf(col.joinSource.header);
          let joinVal = hIdx >= 0 ? jRow[hIdx] : '';
          if (col.transform) joinVal = transformValue(joinVal, col.transform, rowContext, col);
          out.push(joinVal);
        } else {
          out.push('');
        }
      } else {
        const idx = mainData.headers.indexOf(col.source);
        const val = idx >= 0 ? row[idx] : '';
        out.push(transformValue(val, col.transform, rowContext, col));
      }
    });
    resultRows.push(out);
  });

  return {headers: resultHeaders, rows: resultRows};
}

/* 취합 실행 */
function executeMerge(shopId, returnData, subTabId) {
  const stId = subTabId || undefined;
  const mergeId = stId || shopId;
  const config = getMappingConfig(shopId);
  if (!config) { if (!returnData) showToast('매핑 규칙이 없습니다'); return returnData ? null : undefined; }

  /* multiSlotMappings: 각 슬롯별로 개별 매핑 처리 후 결과 합치기 */
  if (config.multiSlotMappings && Array.isArray(config.multiSlotMappings)) {
    let allResultRows = [];
    let resultHeaders = null;
    config.multiSlotMappings.forEach(slotMapping => {
      let slotData = UPLOAD_FILES[getUploadKey(shopId, slotMapping.slotIndex, stId)];
      if (!slotData) return;

      /* 슬롯별 배송비 합산 처리 (쿠팡 중개(위탁) 등) */
      if (slotMapping.mergeShipping) {
        const ms = slotMapping.mergeShipping;
        const catIdx = slotData.headers.indexOf(ms.categoryCol);
        const grpIdx = slotData.headers.indexOf(ms.groupByCol);
        const sumIdxs = ms.sumCols.map(c => slotData.headers.indexOf(c));
        if (catIdx >= 0 && grpIdx >= 0) {
          /* 배송비 행 판별 함수 */
          const isShippingRow = (row) => {
            const catVal = String(row[catIdx] || '').trim();
            if (catVal === ms.shippingValue) return true;
            if (ms.shippingValue2 && catVal === ms.shippingValue2) return true;
            if (catVal.includes('배송료')) return true;
            return false;
          };
          /* 상품주문 행이 있는 주문번호 집합 */
          const productOrderKeys = new Set();
          slotData.rows.forEach(row => {
            if (!isShippingRow(row)) {
              productOrderKeys.add(String(row[grpIdx] || '').trim());
            }
          });
          /* 배송비를 주문번호별로 그룹핑 */
          const shippingMap = {};
          slotData.rows.forEach(row => {
            if (isShippingRow(row)) {
              const grpKey = String(row[grpIdx] || '').trim();
              if (!shippingMap[grpKey]) shippingMap[grpKey] = [];
              shippingMap[grpKey].push(row);
            }
          });
          const mergedRows = [];
          const shippingApplied = {};
          slotData.rows.forEach(row => {
            const grpKey = String(row[grpIdx] || '').trim();
            if (isShippingRow(row)) {
              /* 같은 주문번호의 상품주문이 없으면 배송비 행 유지 */
              if (!productOrderKeys.has(grpKey)) mergedRows.push(row);
              return;
            }
            /* 첫 번째 상품주문 행에만 배송비 금액 합산 (중복 방지) */
            if (shippingMap[grpKey] && !shippingApplied[grpKey]) {
              row = [...row];
              shippingMap[grpKey].forEach(shipRow => {
                sumIdxs.forEach(si => {
                  if (si >= 0) {
                    const base = Number(String(row[si] || 0).replace(/,/g, '')) || 0;
                    const add = Number(String(shipRow[si] || 0).replace(/,/g, '')) || 0;
                    row[si] = base + add;
                  }
                });
              });
              shippingApplied[grpKey] = true;
            }
            mergedRows.push(row);
          });
          slotData = {headers: slotData.headers, rows: mergedRows, name: slotData.name, rowCount: mergedRows.length};
        }
      }

      /* 슬롯별 매핑 처리 */
      const slotConfig = {...config, columns: slotMapping.columns, mainSlot: slotMapping.slotIndex, multiSlotMappings: null};
      const slotResult = executeSlotMerge(shopId, slotData, slotConfig, stId);
      if (slotResult) {
        if (!resultHeaders) resultHeaders = slotResult.headers;
        /* 로켓그로스(slotIndex:1): 매출금액 0인 행 제외 */
        let filteredRows = slotResult.rows;
        if (shopId === 'pour_coupang' && slotMapping.slotIndex === 1) {
          const amtIdx = slotResult.headers.indexOf('매출금액(v+)');
          if (amtIdx >= 0) {
            filteredRows = slotResult.rows.filter(row => {
              const amt = Number(String(row[amtIdx] || 0).replace(/,/g, '')) || 0;
              return amt !== 0;
            });
          }
        }
        allResultRows = allResultRows.concat(filteredRows);
      }
    });
    if (!resultHeaders || allResultRows.length === 0) {
      if (!returnData) showToast('업로드된 파일이 없습니다');
      return returnData ? null : undefined;
    }

    /* 쿠팡 전용: 판매자할인쿠폰 매출비율 배분 마이너스 행 추가 */
    if (shopId === 'pour_coupang') {
      const coupangDetail = getCoupangSalesData(shopId);
      const sellerCoupon = parseInt(coupangDetail.sellerCoupon || 0) || 0;
      if (sellerCoupon > 0) {
        /* 쇼핑몰 컬럼 인덱스 찾기 */
        const shopColIdx = resultHeaders.indexOf('쇼핑몰');
        const amtColIdx = resultHeaders.indexOf('매출금액(v+)');
        const amtMinusColIdx = resultHeaders.indexOf('매출금액(v-)');
        const settleColIdx = resultHeaders.indexOf('정산예정금액');
        const monthColIdx = resultHeaders.indexOf('매출월');
        const categoryColIdx = resultHeaders.indexOf('브랜드');
        const productNameColIdx = resultHeaders.indexOf('제품명');
        const salesProductColIdx = resultHeaders.indexOf('판매상품명');

        /* 쿠팡(중개)에만 할인쿠폰 전액 반영 (로켓그로스 제외) */
        const monthVal = currentYear + '-' + String(currentMonth).padStart(2,'0') + '-01';

        const couponRow = new Array(resultHeaders.length).fill('');
        couponRow[monthColIdx] = monthVal;
        couponRow[shopColIdx] = '쿠팡';
        couponRow[categoryColIdx] = '그로홈';
        couponRow[productNameColIdx] = '판매자할인쿠폰';
        couponRow[salesProductColIdx] = '판매자할인쿠폰';
        couponRow[amtColIdx] = -sellerCoupon;
        couponRow[amtMinusColIdx] = Math.round(-sellerCoupon / 1.1);
        couponRow[settleColIdx] = -sellerCoupon;
        allResultRows.push(couponRow);
      }
    }

    if (returnData) return {headers: resultHeaders, rows: allResultRows};
    /* 엑셀 다운로드 */
    const wsData = [resultHeaders, ...allResultRows];
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '쇼핑몰별_매출상세');
    const shop = SHOPS.find(s => s.id === shopId);
    let dlLabel = shop ? shop.name : shopId;
    if (shopId === 'gro_cafe24') dlLabel = '자사몰_카페24_그로홈';
    else if (shopId === 'moyeora_cafe24') dlLabel = '자사몰_카페24_모여라딜';
    else if (shopId === 'gro_toss_pay') dlLabel = '자사몰_토스_그로홈';
    else if (shopId === 'pour_coupang') dlLabel = '쿠팡';
    const monthStr = String(currentMonth).padStart(2, '0');
    const fileName = dlLabel + '_' + currentYear + '.' + monthStr + '.xlsx';
    XLSX.writeFile(wb, fileName);
    showToast('엑셀 다운로드: ' + fileName);
    showVerifyResult(mergeId, resultHeaders, allResultRows);
    return;
  }

  const mainSlot = config.mainSlot || 0;
  let mainData = UPLOAD_FILES[getUploadKey(shopId, mainSlot, stId)];

  if (!mainData) { if (!returnData) showToast('메인 파일을 업로드해 주세요'); return returnData ? null : undefined; }

  /* 배송비 합산 처리: 배송비 행의 금액을 같은 주문번호 상품주문 행에 합산 후 배송비 행 제거 */
  if (config.mergeShipping) {
    const ms = config.mergeShipping;
    const catIdx = mainData.headers.indexOf(ms.categoryCol);
    const grpIdx = mainData.headers.indexOf(ms.groupByCol);
    const sumIdxs = ms.sumCols.map(c => mainData.headers.indexOf(c));
    if (catIdx >= 0 && grpIdx >= 0) {
      /* 상품주문 행이 있는 주문번호 집합 */
      const productOrderKeys = new Set();
      mainData.rows.forEach(row => {
        if (String(row[catIdx] || '').trim() !== ms.shippingValue) {
          productOrderKeys.add(String(row[grpIdx] || '').trim());
        }
      });
      /* 배송비를 주문번호별로 그룹핑 */
      const shippingMap = {};
      mainData.rows.forEach(row => {
        if (String(row[catIdx] || '').trim() === ms.shippingValue) {
          const grpKey = String(row[grpIdx] || '').trim();
          if (!shippingMap[grpKey]) shippingMap[grpKey] = [];
          shippingMap[grpKey].push(row);
        }
      });
      const mergedRows = [];
      const shippingApplied = {};
      mainData.rows.forEach(row => {
        const cat = String(row[catIdx] || '').trim();
        const grpKey = String(row[grpIdx] || '').trim();
        if (cat === ms.shippingValue) {
          /* 같은 주문번호의 상품주문이 없으면 배송비 행 유지 */
          if (!productOrderKeys.has(grpKey)) mergedRows.push(row);
          return;
        }
        /* 첫 번째 상품주문 행에만 배송비 금액 합산 (중복 방지) */
        if (shippingMap[grpKey] && !shippingApplied[grpKey]) {
          row = [...row];
          shippingMap[grpKey].forEach(shipRow => {
            sumIdxs.forEach(si => {
              if (si >= 0) {
                const base = Number(String(row[si] || 0).replace(/,/g, '')) || 0;
                const add = Number(String(shipRow[si] || 0).replace(/,/g, '')) || 0;
                row[si] = base + add;
              }
            });
          });
          shippingApplied[grpKey] = true;
        }
        mergedRows.push(row);
      });
      mainData = {headers: mainData.headers, rows: mergedRows, name: mainData.name, rowCount: mergedRows.length};
    }
  }

  /* 지마켓 등: 별도 배송비 파일에서 주문번호로 매칭하여 합산 */
  if (config.mergeShippingByOrder) {
    const mso = config.mergeShippingByOrder;
    const shipData = UPLOAD_FILES[getUploadKey(shopId, mso.shippingSlot, stId)];
    if (shipData) {
      const mainOrderIdx = mainData.headers.indexOf(mso.mainOrderCol);
      const shipOrderIdx = shipData.headers.indexOf(mso.shippingOrderCol);
      const shipAmtIdx = shipData.headers.indexOf(mso.shippingAmountCol);
      const shipSettleIdx = shipData.headers.indexOf(mso.shippingSettleCol);
      const addSalesIdx = mainData.headers.indexOf(mso.addToSales);
      const addSettleIdx = mainData.headers.indexOf(mso.addToSettle);

      if (mainOrderIdx >= 0 && shipOrderIdx >= 0) {
        /* 배송비 데이터를 주문번호별로 그룹핑 */
        const shipMap = {};
        shipData.rows.forEach(row => {
          const orderNo = String(row[shipOrderIdx] || '').trim();
          if (!orderNo) return;
          const shipAmt = Number(String(row[shipAmtIdx] || 0).replace(/,/g, '')) || 0;
          const shipSettle = Number(String(row[shipSettleIdx] || 0).replace(/,/g, '')) || 0;
          if (!shipMap[orderNo]) shipMap[orderNo] = {amt: 0, settle: 0};
          shipMap[orderNo].amt += shipAmt;
          shipMap[orderNo].settle += shipSettle;
        });

        /* 메인 데이터의 주문번호 집합 */
        const mainOrderSet = new Set();
        mainData.rows.forEach(row => {
          mainOrderSet.add(String(row[mainOrderIdx] || '').trim());
        });

        /* 첫 번째 행에만 배송비 합산 (중복 방지) */
        const shippingApplied = {};
        const mergedRows = mainData.rows.map(row => {
          const orderNo = String(row[mainOrderIdx] || '').trim();
          if (shipMap[orderNo] && !shippingApplied[orderNo]) {
            row = [...row];
            if (addSalesIdx >= 0) {
              const base = Number(String(row[addSalesIdx] || 0).replace(/,/g, '')) || 0;
              row[addSalesIdx] = base + shipMap[orderNo].amt;
            }
            if (addSettleIdx >= 0) {
              const base = Number(String(row[addSettleIdx] || 0).replace(/,/g, '')) || 0;
              row[addSettleIdx] = base + shipMap[orderNo].settle;
            }
            shippingApplied[orderNo] = true;
          }
          return row;
        });

        /* 매칭되지 않은 배송비 행 추가 (상품 없이 배송비만 있는 경우) */
        Object.keys(shipMap).forEach(orderNo => {
          if (!mainOrderSet.has(orderNo)) {
            /* 배송비 전용 행 생성 */
            const newRow = new Array(mainData.headers.length).fill('');
            newRow[mainOrderIdx] = orderNo;
            if (addSalesIdx >= 0) newRow[addSalesIdx] = shipMap[orderNo].amt;
            if (addSettleIdx >= 0) newRow[addSettleIdx] = shipMap[orderNo].settle;
            /* 구매결정일은 배송비 데이터에서 가져옴 */
            const dateIdx = mainData.headers.indexOf('구매결정일');
            const shipDateIdx = shipData.headers.indexOf('구매결정일') >= 0 ? shipData.headers.indexOf('구매결정일') : shipData.headers.indexOf('매출기준일');
            if (dateIdx >= 0 && shipDateIdx >= 0) {
              const shipRow = shipData.rows.find(r => String(r[shipOrderIdx] || '').trim() === orderNo);
              if (shipRow) newRow[dateIdx] = shipRow[shipDateIdx];
            }
            /* 상품명에 '배송비' 표시 */
            const prodIdx = mainData.headers.indexOf('상품명');
            if (prodIdx >= 0) newRow[prodIdx] = '배송비';
            mergedRows.push(newRow);
          }
        });

        mainData = {headers: mainData.headers, rows: mergedRows, name: mainData.name, rowCount: mergedRows.length};
      }
    }
  }

  /* JOIN 데이터 Map 구성 */
  const joinMaps = [];
  if (config.joins) {
    config.joins.forEach(j => {
      const jData = UPLOAD_FILES[getUploadKey(shopId, j.slotIndex, stId)];
      if (!jData) { joinMaps.push(null); return; }
      const keyIdx = jData.headers.indexOf(j.targetKey);
      if (keyIdx < 0) { joinMaps.push(null); return; }
      const map = {};
      jData.rows.forEach(row => {
        const k = String(row[keyIdx] || '').trim();
        if (k) map[k] = row;
      });
      joinMaps.push({map, headers: jData.headers, keyTransform: j.keyTransform});
    });
  }

  /* 통합 헤더 구성 */
  const resultHeaders = config.columns.map(c => c.name);
  if (config.appendRaw) mainData.headers.forEach(h => resultHeaders.push(h));
  if (config.joins) {
    config.joins.forEach((j, ji) => {
      if (!j.appendAll) return;
      const jData = UPLOAD_FILES[getUploadKey(shopId, j.slotIndex, stId)];
      if (jData) jData.headers.forEach(h => resultHeaders.push(h));
    });
  }

  /* 슬롯별 JOIN 매칭 헬퍼 */
  function getJoinedRow(row, joinIdx) {
    const j = config.joins[joinIdx];
    const jm = joinMaps[joinIdx];
    if (!jm) return null;
    const srcIdx = mainData.headers.indexOf(j.keySource || config.columns.find(c => c.name === '주문번호')?.source);
    let orderKey = srcIdx >= 0 ? String(row[srcIdx] || '').trim() : '';
    if (jm.keyTransform === 'removePSuffix') orderKey = removePSuffix(orderKey);
    return jm.map[orderKey] || null;
  }

  /* 서브탭 라벨 조회 */
  const shop = SHOPS.find(s => s.id === shopId);
  const subTab = shop && shop.subTabs ? shop.subTabs.find(t => t.id === stId) : null;
  const subTabLabel = subTab ? subTab.label : '';

  /* 행별 매핑 */
  const resultRows = [];
  mainData.rows.forEach(row => {
    /* excludeRows 필터링: 특정 열에 특정 값이 있는 행 제외 */
    if (config.excludeRows) {
      for (const excl of config.excludeRows) {
        const exclIdx = mainData.headers.indexOf(excl.column);
        if (exclIdx >= 0 && String(row[exclIdx] || '').trim() === excl.value) {
          return; /* 이 행 건너뛰기 */
        }
      }
    }
    const out = [];
    /* JOIN 행 미리 조회 (joinSource 참조용) */
    const joinedRows = {};
    if (config.joins) config.joins.forEach((j, ji) => { joinedRows[j.slotIndex] = getJoinedRow(row, ji); });

    /* 판매상품명(또는 상품명) 열에서 키워드 매칭용 텍스트 추출 */
    const prodNameCol = config.columns.find(c => c.name === '판매상품명') || config.columns.find(c => c.name === '상품명' && c.source);
    let prodNameText = '';
    if (prodNameCol && prodNameCol.source) {
      const pIdx = mainData.headers.indexOf(prodNameCol.source);
      if (pIdx >= 0) prodNameText = String(row[pIdx] || '');
    }
    /* 옵션명도 키워드 매칭에 포함 (색상 구분 등) */
    const optColForMatch = config.columns.find(c => c.name === '옵션명');
    let optTextForMatch = '';
    if (optColForMatch) {
      if (optColForMatch.source) {
        const optIdx = mainData.headers.indexOf(optColForMatch.source);
        if (optIdx >= 0) optTextForMatch = String(row[optIdx] || '');
      } else if (optColForMatch.joinSource) {
        const jRow = joinedRows[optColForMatch.joinSource.slotIndex];
        const jData = UPLOAD_FILES[getUploadKey(shopId, optColForMatch.joinSource.slotIndex, stId)];
        if (jRow && jData) {
          const hIdx = jData.headers.indexOf(optColForMatch.joinSource.header);
          if (hIdx >= 0) optTextForMatch = String(jRow[hIdx] || '');
        }
      }
    }
    const matchResult = matchProductKeywordWithCode(prodNameText + ' ' + optTextForMatch);
    const matchedProduct = matchResult.name;
    const matchedCode = matchResult.code;

    /* JOIN에서 수량 가져오기 (qtyFromJoinOrZero용) */
    let joinQty = '';
    if (config.joins && config.joins.length > 0) {
      const jRow0 = joinedRows[config.joins[0].slotIndex];
      const jData0 = UPLOAD_FILES[getUploadKey(shopId, config.joins[0].slotIndex, stId)];
      if (jRow0 && jData0) {
        const qIdx = jData0.headers.indexOf('수량');
        if (qIdx >= 0) joinQty = jRow0[qIdx];
      }
    }

    /* 나비엠알오: 옵션 값을 컨텍스트에 전달 (상품명+옵션 결합용) */
    let rawOption = '';
    const optCol = config.columns.find(c => c.name === '옵션명');
    if (optCol && optCol.source) {
      const oIdx = mainData.headers.indexOf(optCol.source);
      if (oIdx >= 0) rawOption = String(row[oIdx] || '');
    }

    const rowContext = {_productName: matchedProduct, _productCode: matchedCode, _joinQty: joinQty, _rawOption: rawOption, _row: row, _headers: mainData.headers, _shopId: shopId};

    /* A~K 매핑 */
    config.columns.forEach(col => {
      let fixedVal = col.fixed;
      if (fixedVal === '_SUBTAB_LABEL_') fixedVal = subTabLabel;
      if (fixedVal !== undefined && fixedVal !== null) {
        out.push(fixedVal);
      } else if (col.joinSource) {
        /* JOIN 슬롯에서 값 가져오기 */
        const jRow = joinedRows[col.joinSource.slotIndex];
        const jData = UPLOAD_FILES[getUploadKey(shopId, col.joinSource.slotIndex, stId)];
        let joinVal = '';
        if (jRow && jData) {
          const hIdx = jData.headers.indexOf(col.joinSource.header);
          joinVal = hIdx >= 0 ? jRow[hIdx] : '';
        }
        /* transform 적용 (예: qtyByAmountSign) */
        if (col.transform) {
          out.push(transformValue(joinVal, col.transform, rowContext, col));
        } else {
          out.push(joinVal);
        }
      } else {
        const idx = mainData.headers.indexOf(col.source);
        const val = idx >= 0 ? row[idx] : '';
        out.push(transformValue(val, col.transform, rowContext, col));
      }
    });
    /* L~ 원본 행 전체 */
    if (config.appendRaw) {
      row.forEach(cell => out.push(cell));
    }
    /* JOIN 행 전체 붙이기 (appendAll인 경우만) */
    if (config.joins) {
      config.joins.forEach((j, ji) => {
        if (!j.appendAll) return;
        const jData = UPLOAD_FILES[getUploadKey(shopId, j.slotIndex, stId)];
        const colCount = jData ? jData.headers.length : 0;
        const matched = joinedRows[j.slotIndex];
        if (matched) {
          matched.forEach(cell => out.push(cell));
        } else {
          for (let c = 0; c < colCount; c++) out.push('');
        }
      });
    }
    resultRows.push(out);
  });

  /* 엑셀 다운로드 or 데이터 리턴 */
  if (returnData) return {headers: resultHeaders, rows: resultRows};
  const wsData = [resultHeaders, ...resultRows];
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '쇼핑몰별_매출상세');
  let dlLabel = subTab ? subTab.label : (shop ? shop.name : shopId);
  /* 카페24 파일명: 자사몰_카페24_그로홈 / 자사몰_카페24_모여라딜 */
  if (shopId === 'gro_cafe24') dlLabel = '자사몰_카페24_그로홈';
  else if (shopId === 'moyeora_cafe24') dlLabel = '자사몰_카페24_모여라딜';
  const monthStr = String(currentMonth).padStart(2, '0');
  const fileName = dlLabel + '_' + currentYear + '.' + monthStr + '.xlsx';
  XLSX.writeFile(wb, fileName);
  showToast('엑셀 다운로드: ' + fileName);
  showVerifyResult(mergeId, resultHeaders, resultRows);
}

/* 금액 검증 */
function findAmountColIdx(headers) {
  const candidates = ['매출금액(v+)', '매출금액', '매입액(VAT포함)', '거래금액', '정산기준금액', '결제금액', '주문금액'];
  for (const c of candidates) {
    const idx = headers.indexOf(c);
    if (idx >= 0) return {idx, label: c};
  }
  return null;
}
function showVerifyResult(shopId, headers, rows) {
  const el = document.getElementById('verify_' + shopId);
  if (!el) return;
  const col = findAmountColIdx(headers);
  if (!col) return;
  let fileSum = 0;
  rows.forEach(r => { const v = Number(String(r[col.idx] || 0).replace(/,/g, '')); if (!isNaN(v)) fileSum += v; });
  const inputAmount = Number(getSalesAmount(shopId)) || 0;
  const diff = fileSum - inputAmount;
  const isMatch = diff === 0;
  el.className = 'verify-box show ' + (isMatch ? 'match' : 'mismatch');
  el.innerHTML = `
    <div class="verify-title">${isMatch ? '✓ 금액 일치' : '✗ 금액 불일치'}</div>
    <div class="verify-row"><span>파일 합계 (${col.label})</span><span>${fileSum.toLocaleString()}원</span></div>
    <div class="verify-row"><span>입력 매출금액</span><span>${inputAmount.toLocaleString()}원</span></div>
    ${!isMatch ? '<div class="verify-row" style="font-weight:700;margin-top:2px;"><span>차이</span><span>' + (diff > 0 ? '+' : '') + diff.toLocaleString() + '원</span></div>' : ''}`;
}

/* 전체 쇼핑몰 취합 다운로드 */
function executeMergeAll() {
  const allRows = [];
  let mergedCount = 0;
  const rawDataSums = {}; /* shopId별 로우데이터 합계 저장 */

  function tryMerge(shopId, subTabId, label) {
    const stId = subTabId || undefined;
    const dataPaths = getShopSetting(shopId, 'dataPaths');
    if (!dataPaths || !Array.isArray(dataPaths)) return;
    const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shopId, i, stId)]);
    if (!allUploaded) return;
    const result = executeMerge(shopId, true, subTabId);
    if (result && result.rows.length > 0) {
      if (allRows.length === 0) allRows.push(result.headers);
      /* 매출금액 컬럼 인덱스 찾기 (여러 후보 중 첫번째 매칭) */
      const amtCandidates = ['매출금액(v+)', '매출금액', '매입액(VAT포함)'];
      let amtIdx = -1;
      for (const col of amtCandidates) {
        amtIdx = result.headers.indexOf(col);
        if (amtIdx >= 0) break;
      }
      let rowSum = 0;
      result.rows.forEach(r => {
        allRows.push(r);
        if (amtIdx >= 0) {
          rowSum += Number(String(r[amtIdx] || 0).replace(/,/g, '')) || 0;
        }
      });
      /* 키 생성: subTabId 있으면 shopId_subTabId, 없으면 shopId */
      const key = stId ? shopId + '_' + stId : shopId;
      rawDataSums[key] = (rawDataSums[key] || 0) + rowSum;
      mergedCount++;
    }
  }
  SHOPS.forEach(shop => {
    if (!SHOP_MAPPINGS[shop.id]) return;
    if (shop.subTabs && shop.subTabs.length > 0) {
      shop.subTabs.forEach(t => tryMerge(shop.id, t.id, t.label));
    } else {
      tryMerge(shop.id, null, shop.name);
    }
  });
  if (mergedCount === 0) {
    showToast('취합할 데이터가 없습니다. 각 쇼핑몰에서 파일을 먼저 업로드해 주세요.');
    return;
  }

  /* 매출현황 탭 데이터와 검증 */
  const mismatches = [];
  const matches = [];
  const salesData = DATA.sales && DATA.sales[currentMonth] ? DATA.sales[currentMonth] : {};

  /* shopId → 매출현황 slotId 매핑 */
  const shopToSlotMap = {
    'pour_kg': 'pour_kg',
    'pour_bucket': 'pour_bucket',
    'pour_navimro': 'pour_navimro',
    'pour_11st': 'pour_11st',
    'pour_gmarket': 'pour_gmarket',
    'pour_auction': 'pour_auction',
    'pour_offline': 'pour_offline',
    'both_smart_pour': 'both_smart_pour',
    'both_smart_gro': 'both_smart_gro',
    'pour_domegook': 'pour_domegook',
    'both_naver_pour': 'both_naver_pour',
    'both_naver_gro': 'both_naver_gro',
    'gro_toss_pay': 'gro_toss_pay',
    'gro_kakao': 'gro_kakao',
    'gro_kakaotalk': 'gro_kakaotalk',
    'gro_toss_shop': 'gro_toss_shop',
    'gro_cafe24': 'gro_cafe24',
    'moyeora_cafe24': 'moyeora_cafe24'
  };
  /* 쿠팡 서브탭 매핑 */
  const coupangSubMap = {
    'pour_coupang_rocket': 'coupang_rocket',
    'pour_coupang_jungae': 'coupang_jungae'
  };

  Object.entries(rawDataSums).forEach(([key, rawSum]) => {
    let slotId = key;
    let displayName = key;

    /* 쿠팡 서브탭 처리 */
    if (coupangSubMap[key]) {
      slotId = coupangSubMap[key];
      const child = COUPANG_GROUP.children.find(c => c.slotId === slotId);
      displayName = child ? '쿠팡_' + child.label : key;
    } else if (shopToSlotMap[key]) {
      slotId = shopToSlotMap[key];
      const shop = SHOPS.find(s => s.id === key);
      displayName = shop ? shop.name : key;
    }

    const salesAmt = Number(salesData[slotId] || 0);
    const diff = Math.abs(rawSum - salesAmt);

    /* 100원 이상 차이나면 불일치로 판단 */
    if (diff > 100) {
      mismatches.push({
        name: displayName,
        raw: rawSum,
        sales: salesAmt,
        diff: rawSum - salesAmt
      });
    } else {
      matches.push({ name: displayName, raw: rawSum, sales: salesAmt });
    }
  });

  /* 검증 결과 모달 표시 */
  showVerifyModal(mismatches, matches, function() {
    /* 다운로드 실행 */
    const ws = XLSX.utils.aoa_to_sheet(allRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '쇼핑몰별_매출상세');
    const monthStr = String(currentMonth).padStart(2, '0');
    const fileName = '전체_매출상세_' + currentYear + '.' + monthStr + '.xlsx';
    XLSX.writeFile(wb, fileName);
    showToast(mergedCount + '개 다운로드 완료: ' + fileName);
  });
}

/* 위하고 업로드 양식 다운로드 */
function downloadMaeibMaechulFormat() {
  /* 브랜드별 쇼핑몰 매출 집계 (키: 양식 품명) */
  const salesByLabel = {};

  /*
   * 고정 양식 목록 - shopId+subTabId → 브랜드별 양식 품명 매핑
   * 하나의 shopId가 두 브랜드에 걸칠 수 있으므로 브랜드별로 분리 집계
   */
  const LABEL_MAP = [
    /* 포어스토어 (code 404) */
    {shopId:'pour_kg',           subTab:'',        brand:'포어스토어', label:'자사몰_kg이니시스',      code:404, bizName:'(주)케이지이니시스', bizNo:'2208155597'},
    {shopId:'both_naver_pour',   subTab:'',        brand:'포어스토어', label:'자사몰_네이버페이',      code:404, bizName:'네이버파이낸셜 주식회사', bizNo:'5248601528'},
    {shopId:'both_naver_gro',    subTab:'',        brand:'포어스토어', label:'자사몰_네이버페이',      code:404, bizName:'네이버파이낸셜 주식회사', bizNo:'5248601528'},
    {shopId:'both_smart_pour',   subTab:'',        brand:'포어스토어', label:'스마트스토어',           code:404, bizName:'스마트스토어', bizNo:'5248601528'},
    {shopId:'pour_coupang',      subTab:'jungae',  brand:'포어스토어', label:'쿠팡',                  code:404, bizName:'쿠팡 주식회사', bizNo:'1208800767'},
    {shopId:'pour_coupang',      subTab:'rocket',  brand:'포어스토어', label:'쿠팡_로켓그로스',        code:404, bizName:'쿠팡 주식회사', bizNo:'1208800767'},
    {shopId:'pour_gmarket',      subTab:'',        brand:'포어스토어', label:'지마켓',                code:404, bizName:'주식회사 지마켓', bizNo:'2208183676'},
    {shopId:'pour_auction',      subTab:'',        brand:'포어스토어', label:'옥션',                  code:404, bizName:'주식회사 지마켓', bizNo:'2208183676'},
    {shopId:'pour_11st',         subTab:'',        brand:'포어스토어', label:'11번가',                code:404, bizName:'십일번가 주식회사', bizNo:'8158101244'},
    {shopId:'pour_bucket',       subTab:'',        brand:'포어스토어', label:'오늘의집',              code:404, bizName:'주식회사 버킷플레이스', bizNo:'1198691245'},
    {shopId:'pour_domegook',     subTab:'',        brand:'포어스토어', label:'도매꾹',                code:404, bizName:'(주)지앤지커머스', bizNo:'1078628206'},
    /* 그로홈 (code 401) */
    {shopId:'both_naver_gro',    subTab:'',        brand:'그로홈',    label:'그로홈몰_네이버페이',      code:401, bizName:'네이버파이낸셜 주식회사', bizNo:'5248601528'},
    {shopId:'gro_cafe24',        subTab:'',        brand:'그로홈',    label:'그로홈몰_카페24',          code:401, bizName:'카페24 주식회사', bizNo:'1188120586'},
    {shopId:'pour_coupang',      subTab:'jungae',  brand:'그로홈',    label:'쿠팡',                    code:401, bizName:'쿠팡 주식회사', bizNo:'1208800767'},
    {shopId:'pour_coupang',      subTab:'rocket',  brand:'그로홈',    label:'쿠팡_로켓그로스',          code:401, bizName:'쿠팡 주식회사', bizNo:'1208800767'},
    {shopId:'pour_domegook',     subTab:'',        brand:'그로홈',    label:'도매꾹',                  code:401, bizName:'(주)지앤지커머스', bizNo:'1078628206'},
    {shopId:'both_smart_gro',    subTab:'',        brand:'그로홈',    label:'스마트스토어_그로홈',      code:401, bizName:'스마트스토어', bizNo:'5248601528'},
    {shopId:'gro_kakao',         subTab:'',        brand:'그로홈',    label:'카카오톡 체크아웃',        code:401, bizName:'톡서랍플러스', bizNo:'1208147521'},
    {shopId:'pour_bucket',       subTab:'',        brand:'그로홈',    label:'오늘의집',                code:401, bizName:'주식회사 버킷플레이스', bizNo:'1198691245'},
    {shopId:'gro_kakaotalk',     subTab:'',        brand:'그로홈',    label:'카카오톡',                code:401, bizName:'톡서랍플러스', bizNo:'1208147521'},
    {shopId:'pour_gmarket',      subTab:'',        brand:'그로홈',    label:'지마켓',                  code:401, bizName:'주식회사 지마켓', bizNo:'2208183676'},
    /* 모여라딜 (code 401 그로홈 제품 / code 401 중개매출) */
    {shopId:'moyeora_cafe24',     subTab:'',        brand:'그로홈',    label:'모여라딜_그로홈',        code:401, bizName:'카페24 주식회사', bizNo:'1188120586'},
    {shopId:'moyeora_cafe24',     subTab:'',        brand:'모여라딜',  label:'모여라딜_중개',          code:401, bizName:'카페24 주식회사', bizNo:'1188120586'}
  ];

  /* 각 쇼핑몰 데이터 취합하여 라벨별 집계 */
  function processMerge(shopId, subTabId) {
    const stId = subTabId || undefined;
    const dataPaths = getShopSetting(shopId, 'dataPaths');
    if (!dataPaths || !Array.isArray(dataPaths)) return;
    const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shopId, i, stId)]);
    if (!allUploaded) return;

    const result = executeMerge(shopId, true, subTabId);
    if (!result || result.rows.length === 0) return;

    const brandIdx = result.headers.indexOf('브랜드');
    const amtIdx = result.headers.indexOf('매출금액(v-)');
    const amtPlusIdx = result.headers.indexOf('매출금액(v+)');
    const finalAmtIdx = amtIdx >= 0 ? amtIdx : amtPlusIdx;
    if (finalAmtIdx < 0) return;

    const shopColIdx = result.headers.indexOf('쇼핑몰');

    result.rows.forEach(row => {
      const brand = String(row[brandIdx] || '').trim();
      let amt = Number(String(row[finalAmtIdx] || 0).replace(/,/g, '')) || 0;
      if (amtIdx < 0 && amtPlusIdx >= 0) amt = Math.round(amt / 1.1);

      /* 이 행에 해당하는 LABEL_MAP 항목 찾기 */
      let stKey = subTabId || '';
      /* 쿠팡: 쇼핑몰 컬럼 기반으로 중개/로켓그로스 subTab 결정 */
      if (shopId === 'pour_coupang' && !subTabId && shopColIdx >= 0) {
        const shopColVal = String(row[shopColIdx] || '').trim();
        stKey = shopColVal.includes('로켓그로스') ? 'rocket' : 'jungae';
      }
      const matches = LABEL_MAP.filter(m => m.shopId === shopId && m.subTab === stKey && m.brand === brand);
      matches.forEach(m => {
        const key = m.brand + '|' + m.label;
        if (!salesByLabel[key]) salesByLabel[key] = {brand: m.brand, label: m.label, code: m.code, bizName: m.bizName, bizNo: m.bizNo, amount: 0};
        salesByLabel[key].amount += amt;
      });
    });
  }

  /* 모든 쇼핑몰 처리 */
  SHOPS.forEach(shop => {
    if (!SHOP_MAPPINGS[shop.id]) return;
    if (shop.subTabs && shop.subTabs.length > 0) {
      shop.subTabs.forEach(t => processMerge(shop.id, t.id));
    } else {
      processMerge(shop.id, null);
    }
  });

  /* 데이터가 있는 항목만 필터링 */
  const entries = Object.values(salesByLabel).filter(e => e.amount !== 0);
  if (entries.length === 0) {
    showToast('취합할 데이터가 없습니다.');
    return;
  }

  /* 엑셀 양식 생성 */
  const year = currentYear;
  const month = currentMonth;
  const lastDay = new Date(year, month, 0).getDate();

  const headers = [
    '년도', '월', '일', '매입매출구분(1-매출/2-매입)', '과세유형', '불공제사유',
    '신용카드거래처코드', '신용카드사명', '신용카드(가맹점)번호', '거래처명',
    '사업자(주민)등록번호', '공급가액', '부가세', '품명', '전자세금(1.전자)',
    '기본계정', '상대계정', '현금영수증 승인번호', ''
  ];

  const rows = [headers];

  /* LABEL_MAP 순서대로 출력 (포어스토어 → 그로홈) */
  LABEL_MAP.forEach(m => {
    const key = m.brand + '|' + m.label;
    const data = salesByLabel[key];
    if (!data || data.amount === 0) return;
    const supplyAmt = Math.round(data.amount);
    const vatAmt = Math.round(data.amount * 0.1);
    const itemName = '[' + m.brand + '] ' + m.label + ' 매출';
    rows.push([
      year, month, lastDay, 1, 14, '', '', '', '', m.bizName || '',
      m.bizNo || '', supplyAmt, vatAmt, itemName, '', m.code, 108, '', ''
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '매입자료 & 매출자료');

  ws['!cols'] = [
    {wch:6}, {wch:4}, {wch:4}, {wch:24}, {wch:8}, {wch:10},
    {wch:18}, {wch:14}, {wch:18}, {wch:22},
    {wch:18}, {wch:14}, {wch:10}, {wch:40}, {wch:14},
    {wch:8}, {wch:8}, {wch:18}, {wch:4}
  ];

  const fileName = '위하고_매입매출_' + year + '년' + month + '월.xlsx';
  XLSX.writeFile(wb, fileName);
  showToast('위하고 업로드 양식 다운로드: ' + fileName);
}

/* 검증 결과 모달 표시 */
function showVerifyModal(mismatches, matches, onConfirm) {
  const hasMismatch = mismatches.length > 0;
  const totalCount = mismatches.length + matches.length;

  /* 불일치 없으면 바로 다운로드 */
  if (!hasMismatch) {
    showToast('검증완료: ' + totalCount + '개 몰 금액 일치');
    onConfirm();
    return;
  }

  let html = `
    <div id="verifyModal" style="display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;">
      <div style="background:white;border-radius:12px;width:90%;max-width:500px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;">
        <div style="padding:16px 20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:700;font-size:1.1rem;">금액 불일치 발견</div>
            <div style="font-size:0.75rem;color:var(--text-muted);">로우데이터 vs 매출현황 비교 (${matches.length}개 일치, ${mismatches.length}개 불일치)</div>
          </div>
          <button onclick="closeVerifyModal()" style="background:none;border:none;cursor:pointer;padding:4px;">
            <span class="material-symbols-outlined" style="font-size:24px;color:var(--gray);">close</span>
          </button>
        </div>
        <div style="padding:20px;overflow-y:auto;flex:1;">
          <table style="width:100%;font-size:0.85rem;border-collapse:collapse;background:#FFF8E1;border-radius:8px;">
            <thead>
              <tr>
                <th style="text-align:left;padding:10px;border-bottom:1px solid #FFEEBA;">쇼핑몰</th>
                <th style="text-align:right;padding:10px;border-bottom:1px solid #FFEEBA;">로우데이터</th>
                <th style="text-align:right;padding:10px;border-bottom:1px solid #FFEEBA;">매출현황</th>
                <th style="text-align:right;padding:10px;border-bottom:1px solid #FFEEBA;">차이</th>
              </tr>
            </thead>
            <tbody>`;
  mismatches.forEach(m => {
    const sign = m.diff > 0 ? '+' : '';
    const diffColor = m.diff > 0 ? '#28A745' : '#DC3545';
    html += `<tr>
      <td style="padding:10px;border-bottom:1px solid #FFEEBA;">${m.name}</td>
      <td style="text-align:right;padding:10px;border-bottom:1px solid #FFEEBA;">${m.raw.toLocaleString()}</td>
      <td style="text-align:right;padding:10px;border-bottom:1px solid #FFEEBA;">${m.sales.toLocaleString()}</td>
      <td style="text-align:right;padding:10px;border-bottom:1px solid #FFEEBA;color:${diffColor};font-weight:600;">${sign}${m.diff.toLocaleString()}</td>
    </tr>`;
  });
  html += `</tbody></table>
        </div>
        <div style="padding:16px 20px;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:10px;">
          <button onclick="closeVerifyModal()" style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">취소</button>
          <button onclick="confirmVerifyDownload()" style="padding:8px 16px;border:none;background:var(--sky);color:white;border-radius:6px;cursor:pointer;font-weight:600;">
            <span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;margin-right:4px;">download</span>다운로드
          </button>
        </div>
      </div>
    </div>`;

  document.body.insertAdjacentHTML('beforeend', html);
  window._verifyDownloadCallback = onConfirm;
}

function closeVerifyModal() {
  const modal = document.getElementById('verifyModal');
  if (modal) modal.remove();
  window._verifyDownloadCallback = null;
}

function confirmVerifyDownload() {
  const callback = window._verifyDownloadCallback;
  closeVerifyModal();
  if (callback) callback();
}

/* 매출현황 탭 진입 시 취합 상태 업데이트 */
function updateMergeAllStatus() {
  const el = document.getElementById('mergeAllStatus');
  if (!el) return;
  let readyList = [], notReadyList = [];
  SHOPS.forEach(shop => {
    if (!SHOP_MAPPINGS[shop.id]) return;
    const dataPaths = getShopSetting(shop.id, 'dataPaths');
    if (!dataPaths || !Array.isArray(dataPaths)) return;
    if (shop.subTabs && shop.subTabs.length > 0) {
      shop.subTabs.forEach(t => {
        const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shop.id, i, t.id)]);
        if (allUploaded) readyList.push(t.label);
        else notReadyList.push(t.label);
      });
    } else {
      const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shop.id, i)]);
      if (allUploaded) readyList.push(shop.name);
      else notReadyList.push(shop.name);
    }
  });
  if (readyList.length === 0 && notReadyList.length === 0) {
    el.innerHTML = '<span style="color:var(--gray);">매핑이 설정된 쇼핑몰이 없습니다.</span>';
    return;
  }
  let html = '';
  if (readyList.length > 0) html += '<div style="margin-bottom:4px;">✅ 취합 준비 완료: <b>' + readyList.join(', ') + '</b></div>';
  if (notReadyList.length > 0) html += '<div>⏳ 파일 미업로드: <span style="color:var(--gray);">' + notReadyList.join(', ') + '</span></div>';
  el.innerHTML = html;
}

/* ===== 대시보드 콘텐츠 렌더링 (기존 매출 대시보드 스타일 통일) ===== */
function renderDashboardContent(fmt) {
  const isVatMinus = vatMode === 'minus';
  if (!fmt) fmt = v => isVatMinus ? Math.round(v / 1.1) : v;
  const vatLabel = vatMode === 'plus' ? 'V+' : 'V-';

  /* 브랜드별 매출 집계 - 로우데이터 기반 */
  const brandTotals = { grohome: 0, pourstore: 0, moyeora: 0 };
  const brandMonthTotals = {
    grohome: new Array(12).fill(0),
    pourstore: new Array(12).fill(0),
    moyeora: new Array(12).fill(0)
  };

  /* 쇼핑몰별 매출 데이터 (그룹핑 적용) */
  const shopSalesData = {};

  /* 제품별 매출 데이터 (그로홈) - 색상별 상세 */
  const productSalesData = {};

  /* 제품별 매출 데이터 (그로홈) - 색상 제외 그룹핑 */
  const productGroupSalesData = {};

  /* 브랜드별/쇼핑몰별 매출 집계를 로우데이터에서 추출 */
  function aggregateDashboardData() {
    const brandData = { grohome: {}, pourstore: {}, moyeora: {} };
    const shopData = {}; /* shopName → { total, brand, monthVals } */

    /* 자사몰 그룹 정의 (포어스토어몰/그로홈몰은 합쳐서, 쿠팡은 분리) */
    const groupShopIds = {
      grohome_jasang: [...JASANG_GROUPS.grohome.shopIds],
      pourstore_jasang: [...JASANG_GROUPS.pourstore.shopIds]
    };

    /* 모든 쇼핑몰의 로우데이터를 조회 */
    SHOPS.forEach(shop => {
      if (!SHOP_MAPPINGS[shop.id]) return;
      const dataPaths = getShopSetting(shop.id, 'dataPaths');
      if (!dataPaths || !Array.isArray(dataPaths)) return;

      /* subTabs 처리 */
      if (shop.subTabs && shop.subTabs.length > 0) {
        shop.subTabs.forEach(t => {
          const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shop.id, i, t.id)]);
          if (!allUploaded) return;
          const result = executeMerge(shop.id, true, t.id);
          if (result && result.rows.length > 0) {
            processRowsForDashboard(result, t.label || shop.name, shop.id, brandData, shopData, groupShopIds, productSalesData, productGroupSalesData);
          }
        });
      } else {
        const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shop.id, i)]);
        if (!allUploaded) return;
        const result = executeMerge(shop.id, true);
        if (result && result.rows.length > 0) {
          processRowsForDashboard(result, shop.name, shop.id, brandData, shopData, groupShopIds, productSalesData, productGroupSalesData);
        }
      }
    });

    return { brandData, shopData };
  }

  /* 로우데이터에서 브랜드별/쇼핑몰별 매출 집계 */
  function processRowsForDashboard(result, shopName, shopId, brandData, shopData, groupShopIds, productData, productGroupData) {
    const brandIdx = result.headers.indexOf('브랜드');
    const amtIdx = result.headers.indexOf('매출금액(v+)');
    const monthIdx = result.headers.indexOf('매출월');
    const productIdx = result.headers.indexOf('제품명');

    if (brandIdx < 0 || amtIdx < 0) return;

    /* 쇼핑몰 그룹 결정 */
    let displayName = shopName;
    let shopKey = shopId;

    /* 자사몰 그룹핑 (포어스토어몰/그로홈몰은 합침) */
    if (groupShopIds.grohome_jasang.includes(shopId)) {
      displayName = '그로홈몰';
      shopKey = 'grohome_jasang';
    } else if (groupShopIds.pourstore_jasang.includes(shopId)) {
      displayName = '포어스토어몰';
      shopKey = 'pourstore_jasang';
    } else if (shopId === 'pour_coupang_0') {
      displayName = '쿠팡(중개)';
      shopKey = 'pour_coupang_0';
    } else if (shopId === 'pour_coupang_1') {
      displayName = '쿠팡(로켓그로스)';
      shopKey = 'pour_coupang_1';
    }

    result.rows.forEach(row => {
      const brand = String(row[brandIdx] || '').trim();
      const amt = Number(String(row[amtIdx] || 0).replace(/,/g, '')) || 0;
      if (amt === 0) return;

      let month = currentMonth;
      if (monthIdx >= 0) {
        const monthVal = String(row[monthIdx] || '');
        const m = monthVal.match(/(\d{4})-(\d{2})/);
        if (m) month = parseInt(m[2]);
      }

      const val = fmt(amt);

      /* 브랜드별 집계 */
      let brandKey = null;
      if (brand === '그로홈') brandKey = 'grohome';
      else if (brand === '포어스토어') brandKey = 'pourstore';
      else if (brand === '모여라딜') brandKey = 'moyeora';

      if (brandKey) {
        brandTotals[brandKey] += val;
        brandMonthTotals[brandKey][month - 1] += val;
      }

      /* 쇼핑몰별 집계 (브랜드별로 분리) */
      const shopBrandKey = shopKey + '_' + (brandKey || 'other');
      if (!shopData[shopBrandKey]) {
        shopData[shopBrandKey] = { name: displayName, total: 0, monthVals: new Array(12).fill(0), brand: brandKey, shopKey: shopKey };
      }
      shopData[shopBrandKey].total += val;
      shopData[shopBrandKey].monthVals[month - 1] += val;

      /* 그로홈 제품별 집계 (제품코드 기준으로 그룹핑) */
      if (brandKey === 'grohome' && productData) {
        const productCodeIdx = result.headers.indexOf('제품코드');
        const productCode = productCodeIdx >= 0 ? String(row[productCodeIdx] || '').trim() : '';
        const rawProductName = productIdx >= 0 ? String(row[productIdx] || '').trim() : '';

        /* 제품코드가 있으면 제품코드 기준, 없으면 제품명 기준 */
        const productKey = productCode || rawProductName;
        if (productKey && productKey !== '-' && productKey !== '미분류') {
          /* 공식 제품명 우선 사용 (재고관리 파일 기준) */
          const officialName = getOfficialProductName(productCode);
          const displayProductName = officialName || rawProductName || productKey;

          /* 색상별 상세 집계 */
          if (!productData[productKey]) {
            productData[productKey] = { name: displayProductName, code: productCode, total: 0, monthVals: new Array(12).fill(0) };
          }
          productData[productKey].total += val;
          productData[productKey].monthVals[month - 1] += val;

          /* 제품별 그룹 집계 (색상 제외) - "_" 앞 부분만 추출 */
          if (productGroupData) {
            const groupName = displayProductName.includes('_') ? displayProductName.split('_')[0] : displayProductName;
            if (!productGroupData[groupName]) {
              productGroupData[groupName] = { name: groupName, total: 0, monthVals: new Array(12).fill(0) };
            }
            productGroupData[groupName].total += val;
            productGroupData[groupName].monthVals[month - 1] += val;
          }
        }
      }
    });
  }

  /* 데이터 집계 실행 (로우데이터 기반 - 제품별 매출 등에 사용) */
  const { shopData } = aggregateDashboardData();

  /* 로우데이터 집계가 비어있으면 DATA.sales 슬롯 기반으로 fallback */
  const hasRawData = (brandTotals.grohome + brandTotals.pourstore + brandTotals.moyeora) > 0;
  if (!hasRawData) {
    const grohomeSlots = ['gro_cafe24','both_naver_gro','gro_toss_pay','both_smart_gro','gro_kakao','gro_kakaotalk','gro_toss_shop','pour_bucket','pour_offline_grohome'];
    const pourstoreSlots = ['pour_kg','both_naver_pour','both_smart_pour','pour_navimro','pour_coupang_0','pour_coupang_1','pour_gmarket','pour_domegook','pour_11st','pour_auction','pour_offline_pourstore'];

    for (let m = 1; m <= 12; m++) {
      const sales = DATA.sales && DATA.sales[m];
      if (!sales) continue;
      grohomeSlots.forEach(sid => {
        const v = fmt(Number(sales[sid]) || 0);
        brandTotals.grohome += v;
        brandMonthTotals.grohome[m - 1] += v;
      });
      pourstoreSlots.forEach(sid => {
        const v = fmt(Number(sales[sid]) || 0);
        brandTotals.pourstore += v;
        brandMonthTotals.pourstore[m - 1] += v;
      });
      /* 모여라딜 (moyeora_cafe24 fallback 처리) */
      let moySum = 0;
      const mGro = fmt(Number(sales['moyeora_grohome']) || 0);
      let mJg = fmt(Number(sales['moyeora_moyeora']) || 0);
      if (mJg === 0) {
        const legacy = Number(sales['moyeora_cafe24']) || 0;
        const groVal = Number(sales['moyeora_grohome']) || 0;
        if (legacy > 0 && groVal === 0) mJg = fmt(legacy);
        else if (legacy > 0) mJg = fmt(legacy - groVal);
      }
      const mOffGro = fmt(Number(sales['pour_offline_moyeora_grohome']) || 0);
      let mOffJg = fmt(Number(sales['pour_offline_moyeora_jungae']) || 0);
      if (mOffJg === 0 && mOffGro === 0) {
        mOffJg = fmt(Number(sales['pour_offline_moyeora']) || 0);
      }
      moySum = mGro + mJg + mOffGro + mOffJg;
      brandTotals.moyeora += moySum;
      brandMonthTotals.moyeora[m - 1] += moySum;
    }
  }

  /* 브랜드별 쇼핑몰 필터링 함수 */
  function filterShopsByBrand(data, targetBrand) {
    const result = {};
    Object.entries(data).forEach(([key, val]) => {
      if (targetBrand === 'all' || val.brand === targetBrand) {
        /* 같은 쇼핑몰이면 합산 */
        const shopKey = val.shopKey || key;
        if (!result[shopKey]) {
          result[shopKey] = { name: val.name, total: 0, monthVals: new Array(12).fill(0), brand: val.brand };
        }
        val.monthVals.forEach((v, i) => result[shopKey].monthVals[i] += v);
      }
    });
    /* total 계산 */
    Object.values(result).forEach(v => {
      v.total = v.monthVals.reduce((a, b) => a + b, 0);
    });
    return result;
  }

  /* 선택된 브랜드에 따른 데이터 필터링 */
  let filteredTotal = 0;
  let filteredMonthTotals = new Array(12).fill(0);
  let filteredShopSales = {};

  if (dashboardBrand === 'all') {
    filteredTotal = brandTotals.grohome + brandTotals.pourstore + brandTotals.moyeora;
    for (let i = 0; i < 12; i++) {
      filteredMonthTotals[i] = brandMonthTotals.grohome[i] + brandMonthTotals.pourstore[i] + brandMonthTotals.moyeora[i];
    }
    filteredShopSales = filterShopsByBrand(shopData, 'all');
  } else {
    filteredTotal = brandTotals[dashboardBrand];
    filteredMonthTotals = [...brandMonthTotals[dashboardBrand]];
    /* 브랜드별 쇼핑몰 필터링 */
    filteredShopSales = filterShopsByBrand(shopData, dashboardBrand);
  }

  const totalSales = brandTotals.grohome + brandTotals.pourstore + brandTotals.moyeora;
  const monthTotals = filteredMonthTotals;
  const currMonth = currentMonth;

  /* 월별 보기일 때 filteredTotal을 해당 월로 한정 */
  const viewMonth = dashboardViewMonth; /* 0=TOTAL, 1~12=월별 */
  if (viewMonth >= 1 && viewMonth <= 12) {
    filteredTotal = monthTotals[viewMonth - 1] || 0;
  }

  const currMonthTotal = monthTotals[currMonth - 1] || 0;
  const prevMonth = currMonth === 1 ? 12 : currMonth - 1;
  const prevMonthTotal = monthTotals[prevMonth - 1] || 0;
  const monthChange = prevMonthTotal > 0 ? ((currMonthTotal - prevMonthTotal) / prevMonthTotal * 100).toFixed(1) : 0;

  /* 월별 보기일 때 브랜드별 카드도 해당 월 값으로 */
  const brandCardGrh = viewMonth >= 1 ? (brandMonthTotals.grohome[viewMonth - 1] || 0) : brandTotals.grohome;
  const brandCardPour = viewMonth >= 1 ? (brandMonthTotals.pourstore[viewMonth - 1] || 0) : brandTotals.pourstore;
  const brandCardMoy = viewMonth >= 1 ? (brandMonthTotals.moyeora[viewMonth - 1] || 0) : brandTotals.moyeora;

  /* 월별 보기 시 쇼핑몰 순위도 해당 월 데이터로 재계산 */
  if (viewMonth >= 1 && viewMonth <= 12) {
    Object.values(filteredShopSales).forEach(v => {
      v.total = v.monthVals[viewMonth - 1] || 0;
    });
  }

  const brandLabel = dashboardBrand === 'all' ? '전체' :
                     dashboardBrand === 'grohome' ? '그로홈' :
                     dashboardBrand === 'pourstore' ? '포어스토어' : '모여라딜';

  /* 모여라딜 순액조정 및 그로홈/중개 분리 계산 (전체/모여라딜 탭 모두 적용) */
  let moyeoraDeductTotal = 0;
  const moyeoraDeductMonths = new Array(12).fill(0);
  const moyeoraNetMonths = new Array(12).fill(0);
  let moyeoraNetTotal = 0;
  /* 모여라딜 내 그로홈/중개 분리 */
  const moyeoraGrohomeMonths = new Array(12).fill(0);
  let moyeoraGrohomeTotal = 0;
  const moyeoraJungaeMonths = new Array(12).fill(0);
  let moyeoraJungaeTotal = 0;
  /* 순액조정은 항상 계산 (전체 탭 순매출 모드에서도 사용) */
  {
    for (let m = 1; m <= 12; m++) {
      const sales = DATA.sales && DATA.sales[m];
      /* 그로홈 매출 (moyeora_grohome + 계좌입금_그로홈) */
      const ghRaw = sales ? (Number(sales['moyeora_grohome']) || 0) : 0;
      const offGhRaw = sales ? (Number(sales['pour_offline_moyeora_grohome']) || 0) : 0;
      const ghVal = fmt(ghRaw) + fmt(offGhRaw);
      moyeoraGrohomeMonths[m - 1] = ghVal;
      moyeoraGrohomeTotal += ghVal;
      /* 중개 매출 (moyeora_moyeora 또는 legacy moyeora_cafe24 + 계좌입금_중개) */
      let jgRaw = sales ? (Number(sales['moyeora_moyeora']) || 0) : 0;
      if (jgRaw === 0 && sales) {
        const legacyVal = Number(sales['moyeora_cafe24']) || 0;
        const grohomeVal = Number(sales['moyeora_grohome']) || 0;
        if (legacyVal > 0 && grohomeVal === 0) jgRaw = legacyVal;
        else if (legacyVal > 0) jgRaw = legacyVal - grohomeVal;
      }
      /* 계좌입금 중개 (분리 슬롯 → fallback 합계 슬롯) */
      let offJgRaw = sales ? (Number(sales['pour_offline_moyeora_jungae']) || 0) : 0;
      if (offJgRaw === 0 && offGhRaw === 0 && sales) {
        offJgRaw = Number(sales['pour_offline_moyeora']) || 0;
      }
      const jgVal = fmt(jgRaw) + fmt(offJgRaw);
      moyeoraJungaeMonths[m - 1] = jgVal;
      moyeoraJungaeTotal += jgVal;
      /* 순액조정 (중개 매출에서만 차감) */
      const d = getMoyeoraDeduct(m);
      moyeoraDeductMonths[m - 1] = d;
      moyeoraDeductTotal += d;
    }
    moyeoraNetTotal = brandTotals.moyeora - moyeoraDeductTotal;
    for (let i = 0; i < 12; i++) {
      moyeoraNetMonths[i] = brandMonthTotals.moyeora[i] - moyeoraDeductMonths[i];
    }
  }

  /* 순매출 모드일 때 모여라딜 매출에서 순액조정 차감 */
  const isNetMode = dashboardNetMode === 'net' && dashboardBrand === 'moyeora';
  if (isNetMode && moyeoraDeductTotal > 0) {
    for (let i = 0; i < 12; i++) {
      filteredMonthTotals[i] = filteredMonthTotals[i] - moyeoraDeductMonths[i];
    }
    filteredTotal = viewMonth >= 1 ? (filteredMonthTotals[viewMonth - 1] || 0) : filteredMonthTotals.reduce((a, b) => a + b, 0);
  }

  /* 순매출 모드 기준 모여라딜 브랜드 카드 값 */
  const moyeoraCardVal = isNetMode ? (viewMonth >= 1 ? filteredMonthTotals[viewMonth - 1] : filteredMonthTotals.reduce((a, b) => a + b, 0)) : brandCardMoy;

  /* 모여라딜 탭: filteredShopSales를 그로홈/중개매출 두 항목으로 교체 */
  if (dashboardBrand === 'moyeora') {
    filteredShopSales = {
      'moyeora_dash_grohome': { name: '그로홈', total: moyeoraGrohomeTotal, monthVals: [...moyeoraGrohomeMonths], brand: 'moyeora' },
      'moyeora_dash_jungae': { name: '중개매출', total: moyeoraJungaeTotal, monthVals: [...moyeoraJungaeMonths], brand: 'moyeora' }
    };
  }

  const topShops = Object.entries(filteredShopSales).sort((a, b) => b[1].total - a[1].total).slice(0, 5);
  const topShopMax = topShops[0] ? topShops[0][1].total : 1;

  /* 전월비 계산 */
  const monthDiff = currMonthTotal - prevMonthTotal;
  const changeIcon = monthChange > 0 ? '↑' : monthChange < 0 ? '↓' : '-';
  const changeClass = monthChange > 0 ? 'up' : monthChange < 0 ? 'down' : '';

  /* 전체 쇼핑몰 Top 10 */
  const allTopShops = Object.entries(filteredShopSales).sort((a, b) => b[1].total - a[1].total).slice(0, 10);

  /* 월별 보기 시 제품 데이터도 해당 월로 재계산 */
  if (viewMonth >= 1 && viewMonth <= 12) {
    Object.values(productSalesData).forEach(v => { v.total = v.monthVals[viewMonth - 1] || 0; });
    Object.values(productGroupSalesData).forEach(v => { v.total = v.monthVals[viewMonth - 1] || 0; });
  }

  /* 제품별 Top 10 (그로홈) - 색상별 상세 */
  const topProducts = Object.entries(productSalesData).sort((a, b) => b[1].total - a[1].total).slice(0, 10);

  /* 제품별 Top 10 (그로홈) - 색상 제외 그룹 */
  const topProductGroups = Object.entries(productGroupSalesData).sort((a, b) => b[1].total - a[1].total).slice(0, 10);

  let html = `
  <style>
    /* === 대시보드 메인 스타일 === */
    .dash-controls { display: flex; gap: 4px; align-items: center; }
    .dash-vat-btn { padding: 5px 10px; border-radius: 5px; border: 1px solid #d1d5db; background: #f9fafb; color: #64748b; font-size: 0.68rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    .dash-vat-btn:hover { background: #e5e7eb; }
    .dash-vat-btn.active { background: #f1f5f9; color: #1e293b; border-color: #94a3b8; font-weight: 700; }

    /* === 대시보드 브랜드 탭 (탭바 스타일) === */
    .dash-brand-tabs { display: flex; gap: 0; background: #f3f4f6; padding: 8px 8px 0 8px; border-radius: 10px 10px 0 0; border-bottom: 2px solid #d1d5db; margin-bottom: 16px; }
    .dash-brand-tab { padding: 10px 20px; background: none; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 500; font-size: 0.8rem; color: #9ca3af; position: relative; margin-bottom: -2px; transition: all 0.15s; }
    .dash-brand-tab:hover { color: #374151; background: rgba(255,255,255,0.7); }
    .dash-brand-tab.active { background: white; color: #2563eb; font-weight: 700; border: 2px solid #e2e8f0; border-bottom: 3px solid white; box-shadow: 0 -3px 10px rgba(0,0,0,0.08); }
    .dash-brand-tab.active::after { content: ''; position: absolute; bottom: -3px; left: 10%; width: 80%; height: 3px; background: #2563eb; border-radius: 3px 3px 0 0; }
    .dash-brand-tab.active.cyan { color: #06b6d4; }
    .dash-brand-tab.active.cyan::after { background: #06b6d4; }
    .dash-brand-tab.active.orange { color: #f97316; }
    .dash-brand-tab.active.orange::after { background: #f97316; }
    .dash-brand-tab.active.green { color: #10b981; }
    .dash-brand-tab.active.green::after { background: #10b981; }

    /* === 요약 카드 그리드 === */
    .dash-summary-grid { display: grid; grid-template-columns: 1fr 1fr 1.5fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .dash-summary-grid.month-view { grid-template-columns: 1.2fr 1.5fr 1fr 1fr 1fr; }
    .dash-card { background: white; border-radius: 10px; padding: 14px 16px; box-shadow: 0 3px 15px rgba(0,0,0,0.08); text-align: center; display: flex; flex-direction: column; justify-content: center; min-height: 90px; }
    .dash-card-title { font-size: 0.72rem; color: #64748b; margin-bottom: 4px; font-weight: 500; }
    .dash-card-value { font-size: 1.3rem; font-weight: 700; letter-spacing: -0.02em; }
    .dash-card.blue { border-top: 3px solid #2E75B6; }
    .dash-card.blue .dash-card-value { color: #2E75B6; }
    .dash-card.cyan { border-top: 3px solid #06b6d4; }
    .dash-card.cyan .dash-card-value { color: #06b6d4; }
    .dash-card.orange { border-top: 3px solid #f97316; }
    .dash-card.orange .dash-card-value { color: #f97316; }
    .dash-card.green { border-top: 3px solid #10b981; }
    .dash-card.green .dash-card-value { color: #10b981; }
    .dash-card.important { background: linear-gradient(135deg, #e8f4fd 0%, #f5f9ff 100%); border: 2px solid; box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
    .dash-card.important.blue { border-color: #2E75B6; }
    .dash-card.important.cyan { border-color: #06b6d4; }
    .dash-card.important.orange { border-color: #f97316; }
    .dash-card.important.green { border-color: #10b981; }
    .dash-card.secondary { background: #f8f9fa; border: 1px solid #e0e0e0; box-shadow: 0 1px 5px rgba(0,0,0,0.05); opacity: 0.95; }
    .dash-card.secondary .dash-card-title { color: #888; }
    .dash-card.secondary .dash-card-value { font-size: 1.1rem; }

    /* === 전월비 배지 === */
    .change-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 600; margin-top: 4px; }
    .change-badge.up { background: #d4edda; color: #155724; }
    .change-badge.down { background: #f8d7da; color: #721c24; }
    .change-badge.neutral { background: #e2e8f0; color: #64748b; }

    /* === 달성률 프로그레스 === */
    .achievement-mini { margin-top: 8px; }
    .achievement-mini .track { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
    .achievement-mini .bar { height: 100%; border-radius: 3px; transition: width 0.5s; }
    .achievement-mini .bar.red { background: #ef4444; }
    .achievement-mini .bar.yellow { background: #f59e0b; }
    .achievement-mini .bar.green { background: #22c55e; }

    /* === 패널 카드 === */
    .dash-panel { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e2e8f0; }
    .dash-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #2E75B6; }
    .dash-panel-title { font-size: 0.9rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 8px; }
    .dash-panel-title .material-symbols-outlined { font-size: 18px; color: #64748b; }

    /* === 랭킹 리스트 === */
    .ranking-list { }
    .ranking-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.15s; }
    .ranking-row:hover { background: #f8fafc; margin: 0 -12px; padding: 10px 12px; border-radius: 6px; }
    .ranking-row:last-child { border-bottom: none; }
    .ranking-num { width: 26px; height: 26px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; margin-right: 12px; background: #f1f5f9; color: #64748b; }
    .ranking-row:nth-child(1) .ranking-num { background: #fef3c7; color: #b45309; }
    .ranking-row:nth-child(2) .ranking-num { background: #f1f5f9; color: #475569; }
    .ranking-row:nth-child(3) .ranking-num { background: #fed7aa; color: #c2410c; }
    .ranking-name { flex: 1; font-size: 0.82rem; color: #1e293b; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .ranking-dot { width: 8px; height: 8px; border-radius: 50%; }
    .ranking-dot.grohome { background: #f97316; }
    .ranking-dot.pourstore { background: #10b981; }
    .ranking-dot.moyeora { background: #06b6d4; }
    .ranking-amount { font-size: 0.82rem; font-weight: 600; color: #1e293b; }
    .ranking-percent { font-size: 0.7rem; color: #94a3b8; margin-left: 8px; }

    /* === 브랜드 비중 바 === */
    .brand-ratio-item { margin-bottom: 14px; }
    .brand-ratio-item:last-child { margin-bottom: 0; }
    .brand-ratio-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .brand-ratio-name { font-size: 0.8rem; font-weight: 600; color: #334155; display: flex; align-items: center; gap: 8px; }
    .brand-ratio-value { font-size: 0.8rem; color: #64748b; }
    .brand-ratio-value strong { color: #1e293b; font-weight: 700; }
    .brand-ratio-bar { height: 10px; background: #f1f5f9; border-radius: 5px; overflow: hidden; }
    .brand-ratio-fill { height: 100%; border-radius: 5px; transition: width 0.5s; }

    /* === 월별 꺾은선 차트 === */
    .line-chart-container { position: relative; height: 180px; padding: 10px 0; }
    .line-chart-svg { width: 100%; height: 100%; }
    .line-chart-line { fill: none; stroke: #2E75B6; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; }
    .line-chart-area { fill: url(#lineGradient); opacity: 0.3; }
    .line-chart-dot { fill: #2E75B6; stroke: white; stroke-width: 2; cursor: pointer; transition: r 0.2s; }
    .line-chart-dot:hover { r: 6; }
    .line-chart-dot.current { fill: #dc2626; r: 6; }
    .line-chart-label { font-size: 10px; fill: #94a3b8; text-anchor: middle; }
    .line-chart-label.current { fill: #2E75B6; font-weight: 700; }
    .line-chart-value { font-size: 9px; fill: #64748b; text-anchor: middle; font-weight: 600; }
    .line-chart-grid { stroke: #e2e8f0; stroke-dasharray: 3,3; }

    /* === 카테고리 테이블 === */
    .cat-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .cat-table th { padding: 10px 12px; text-align: right; font-weight: 600; color: #64748b; background: #f8fafc; border-bottom: 2px solid #e2e8f0; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .cat-table th:first-child { text-align: left; }
    .cat-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #1e293b; }
    .cat-table td:first-child { font-weight: 600; }
    .cat-table td:not(:first-child) { text-align: right; font-weight: 500; }
    .cat-table tr:hover { background: #f8fafc; }
    .cat-table tr.total-row { background: #f8fafc; }
    .cat-table tr.total-row td { font-weight: 700; border-top: 2px solid #e2e8f0; }
    .cat-table .zero { color: #cbd5e1; font-weight: 400; }
    .cat-table .highlight { color: #2E75B6; font-weight: 700; }

    /* === 분석 카드 === */
    .analysis-card { background: #1e293b; color: white; border-radius: 10px; padding: 20px; }
    .analysis-card-title { font-size: 0.72rem; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .analysis-card-value { font-size: 2rem; font-weight: 700; }
    .analysis-card-sub { font-size: 0.75rem; color: #64748b; margin-top: 8px; }

    /* === 통계 박스 === */
    .stat-boxes { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
    .stat-box { padding: 14px; border-radius: 8px; text-align: center; }
    .stat-box.positive { background: #f0fdf4; }
    .stat-box.negative { background: #fef2f2; }
    .stat-box.neutral { background: #f8fafc; }
    .stat-box-label { font-size: 0.7rem; color: #64748b; margin-bottom: 4px; }
    .stat-box-value { font-size: 1.1rem; font-weight: 700; }
    .stat-box.positive .stat-box-value { color: #15803d; }
    .stat-box.negative .stat-box-value { color: #dc2626; }
    .stat-box.neutral .stat-box-value { color: #475569; }
  </style>

  <!-- 브랜드 탭 -->
  <div class="dash-brand-tabs">
    <button class="dash-brand-tab ${dashboardBrand === 'all' ? 'active' : ''}" onclick="switchDashboardBrand('all')">전체</button>
    <button class="dash-brand-tab ${dashboardBrand === 'grohome' ? 'active orange' : ''}" onclick="switchDashboardBrand('grohome')">그로홈</button>
    <button class="dash-brand-tab ${dashboardBrand === 'pourstore' ? 'active green' : ''}" onclick="switchDashboardBrand('pourstore')">포어스토어</button>
    <button class="dash-brand-tab ${dashboardBrand === 'moyeora' ? 'active cyan' : ''}" onclick="switchDashboardBrand('moyeora')">모여라딜</button>
    <div style="flex:1;"></div>
    <div class="dash-controls" style="margin-bottom:8px;">
        ${dashboardBrand === 'moyeora' ? `
        <button class="dash-vat-btn ${dashboardNetMode === 'net' ? 'active' : ''}" onclick="switchDashboardNetMode('net')" style="font-size:0.65rem;padding:5px 8px;" title="순매출 (순액조정 반영)">순매출</button>
        <button class="dash-vat-btn ${dashboardNetMode === 'gross' ? 'active' : ''}" onclick="switchDashboardNetMode('gross')" style="font-size:0.65rem;padding:5px 8px;" title="총매출 (순액조정 미반영)">총매출</button>
        <div style="width:1px;height:16px;background:#d1d5db;margin:0 2px;"></div>
        ` : ''}
        <button class="dash-vat-btn ${dashboardViewMonth === 0 ? 'active' : ''}" onclick="switchDashboardViewMonth('total')" style="font-size:0.68rem;padding:5px 10px;">TOTAL</button>
        <div style="width:1px;height:16px;background:#d1d5db;margin:0 2px;"></div>
        <button class="dash-vat-btn" onclick="switchDashboardViewMonth('prev')" style="padding:4px 6px;font-size:0.65rem;">◀</button>
        <button class="dash-vat-btn ${dashboardViewMonth >= 1 ? 'active' : ''}" onclick="${dashboardViewMonth === 0 ? 'switchDashboardViewMonth(' + ((() => { const d = new Date(); const m = d.getMonth(); return m === 0 ? 12 : m; })()) + ')' : ''}" style="min-width:34px;font-size:0.68rem;padding:5px 8px;">${dashboardViewMonth >= 1 ? dashboardViewMonth + '월' : '월별'}</button>
        <button class="dash-vat-btn" onclick="switchDashboardViewMonth('next')" style="padding:4px 6px;font-size:0.65rem;">▶</button>
        <div style="width:1px;height:16px;background:#d1d5db;margin:0 2px;"></div>
        <button class="dash-vat-btn" onclick="toggleVatMode();" style="font-size:0.65rem;padding:5px 8px;color:#94a3b8;">${vatMode === 'minus' ? 'V-' : 'V+'}</button>
      </div>
  </div>

  <!-- 요약 카드 -->
  <div class="dash-summary-grid${viewMonth >= 1 ? ' month-view' : ''}">
    <div class="dash-card important blue">
      <div class="dash-card-title">${viewMonth >= 1 ? viewMonth + '월 매출' : '총 매출'}</div>
      <div class="dash-card-value">${filteredTotal ? (filteredTotal >= 100000000 ? (filteredTotal / 100000000).toFixed(2) + '억' : (filteredTotal / 10000).toFixed(0) + '만') : '-'}</div>
      <div style="font-size:0.65rem;color:#64748b;margin-top:2px;">${filteredTotal ? filteredTotal.toLocaleString() + '원' : ''}</div>
    </div>
    ${viewMonth === 0 ? `
    <div class="dash-card important blue">
      <div class="dash-card-title">${currMonth}월 매출</div>
      <div class="dash-card-value">${currMonthTotal ? (currMonthTotal / 10000).toFixed(0) + '만' : '-'}</div>
      <div class="change-badge ${changeClass || 'neutral'}">${changeIcon} ${Math.abs(monthChange)}%</div>
    </div>
    <div class="dash-card blue" style="padding:12px;">
      <div class="dash-card-title">전월 대비</div>
      <div style="display:flex;justify-content:space-around;align-items:center;">
        <div style="text-align:center;">
          <div style="font-size:0.65rem;color:#64748b;">금액</div>
          <div style="font-size:1rem;font-weight:700;color:${monthDiff >= 0 ? '#15803d' : '#dc2626'};">${monthDiff >= 0 ? '+' : ''}${(monthDiff / 10000).toFixed(0)}만</div>
        </div>
        <div style="width:1px;height:30px;background:#e2e8f0;"></div>
        <div style="text-align:center;">
          <div style="font-size:0.65rem;color:#64748b;">비율</div>
          <div style="font-size:1rem;font-weight:700;color:${monthChange >= 0 ? '#15803d' : '#dc2626'};">${monthChange >= 0 ? '+' : ''}${monthChange}%</div>
        </div>
      </div>
    </div>
    ` : `
    <div class="dash-card blue" style="padding:12px;">
      <div class="dash-card-title">전월(${viewMonth === 1 ? 12 : viewMonth - 1}월) 대비</div>
      ${(() => {
        const vmPrev = viewMonth === 1 ? 12 : viewMonth - 1;
        const vmCurr = monthTotals[viewMonth - 1] || 0;
        const vmPrevVal = monthTotals[vmPrev - 1] || 0;
        const vmDiff = vmCurr - vmPrevVal;
        const vmPct = vmPrevVal > 0 ? ((vmDiff / vmPrevVal) * 100).toFixed(1) : 0;
        return '<div style="display:flex;justify-content:space-around;align-items:center;">' +
          '<div style="text-align:center;"><div style="font-size:0.65rem;color:#64748b;">금액</div><div style="font-size:1rem;font-weight:700;color:' + (vmDiff >= 0 ? '#15803d' : '#dc2626') + ';">' + (vmDiff >= 0 ? '+' : '') + (vmDiff / 10000).toFixed(0) + '만</div></div>' +
          '<div style="width:1px;height:30px;background:#e2e8f0;"></div>' +
          '<div style="text-align:center;"><div style="font-size:0.65rem;color:#64748b;">비율</div><div style="font-size:1rem;font-weight:700;color:' + (vmPct >= 0 ? '#15803d' : '#dc2626') + ';">' + (vmPct >= 0 ? '+' : '') + vmPct + '%</div></div></div>';
      })()}
    </div>
    `}
    <div class="dash-card secondary orange">
      <div class="dash-card-title">그로홈</div>
      <div class="dash-card-value">${brandCardGrh ? (brandCardGrh / 10000).toFixed(0) + '만' : '-'}</div>
    </div>
    <div class="dash-card secondary green">
      <div class="dash-card-title">포어스토어</div>
      <div class="dash-card-value">${brandCardPour ? (brandCardPour / 10000).toFixed(0) + '만' : '-'}</div>
    </div>
    <div class="dash-card secondary cyan">
      <div class="dash-card-title">모여라딜${isNetMode && moyeoraDeductTotal > 0 ? ' <span style="font-size:0.6rem;color:#94a3b8;font-weight:400;">(순)</span>' : ''}</div>
      <div class="dash-card-value">${moyeoraCardVal ? (moyeoraCardVal / 10000).toFixed(0) + '만' : '-'}</div>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
    <!-- 전체 탭: 브랜드별 비중 / 브랜드 탭: 쇼핑몰별 월별 추이 -->
    <div class="dash-panel">
      <div class="dash-panel-header">
        <div class="dash-panel-title"><span class="material-symbols-outlined">${dashboardBrand === 'all' ? 'donut_large' : 'show_chart'}</span>${dashboardBrand === 'all' ? '브랜드별 매출 비중' : dashboardBrand === 'moyeora' ? '그로홈 / 중개매출 월별 추이' : '쇼핑몰별 월별 추이'}</div>
        ${dashboardBrand === 'all' ? `
        <div style="display:flex;gap:4px;">
          <button id="donutTabCumul" onclick="switchDonutTab('cumul')" style="padding:4px 10px;border:1px solid #3b82f6;background:#3b82f6;color:#fff;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:600;">누적</button>
          <button id="donutTabMonth" onclick="switchDonutTab('month')" style="padding:4px 10px;border:1px solid #e2e8f0;background:#fff;color:#64748b;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:500;">월별</button>
        </div>
        ` : ''}
      </div>
      ${dashboardBrand === 'all' ? (() => {
        /* 도넛 차트용 월별 데이터 */
        const monthOptions = [];
        for (let m = 1; m <= 12; m++) {
          const hasData = brandMonthTotals.grohome[m-1] > 0 || brandMonthTotals.pourstore[m-1] > 0 || brandMonthTotals.moyeora[m-1] > 0;
          if (hasData) monthOptions.push(m);
        }

        /* 도넛 차트 계산 (순매출 모드 반영) */
        const donutMoyVal = isNetMode ? moyeoraNetTotal : brandTotals.moyeora;
        const donutData = [
          { name: '그로홈', value: brandTotals.grohome, color: '#f97316' },
          { name: '포어스토어', value: brandTotals.pourstore, color: '#10b981' },
          { name: isNetMode && moyeoraDeductTotal > 0 ? '모여라딜(순)' : '모여라딜', value: donutMoyVal, color: '#06b6d4' }
        ].filter(d => d.value > 0);
        const donutTotal = donutData.reduce((a, b) => a + b.value, 0);
        const size = 280;
        const cx = size / 2;
        const cy = size / 2;
        const outerR = 120;
        const innerR = 75;
        let startAngle = -90;

        function polarToCartesian(cx, cy, r, angle) {
          const rad = (angle * Math.PI) / 180;
          return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
        }
        function describeArc(cx, cy, outerR, innerR, startAngle, endAngle) {
          const start1 = polarToCartesian(cx, cy, outerR, startAngle);
          const end1 = polarToCartesian(cx, cy, outerR, endAngle);
          const start2 = polarToCartesian(cx, cy, innerR, endAngle);
          const end2 = polarToCartesian(cx, cy, innerR, startAngle);
          const largeArc = endAngle - startAngle > 180 ? 1 : 0;
          return [
            'M', start1.x, start1.y,
            'A', outerR, outerR, 0, largeArc, 1, end1.x, end1.y,
            'L', start2.x, start2.y,
            'A', innerR, innerR, 0, largeArc, 0, end2.x, end2.y,
            'Z'
          ].join(' ');
        }

        let paths = '';
        donutData.forEach((d, i) => {
          const angle = (d.value / donutTotal) * 360;
          const endAngle = startAngle + angle;
          if (angle > 0.5) {
            paths += '<path d="' + describeArc(cx, cy, outerR, innerR, startAngle, endAngle - 0.5) + '" fill="' + d.color + '" stroke="white" stroke-width="2"/>';
          }
          startAngle = endAngle;
        });

        return `
      <div id="donutChartArea" data-grohome-months="${JSON.stringify(brandMonthTotals.grohome).replace(/"/g, '&quot;')}" data-pourstore-months="${JSON.stringify(brandMonthTotals.pourstore).replace(/"/g, '&quot;')}" data-moyeora-months="${JSON.stringify(brandMonthTotals.moyeora).replace(/"/g, '&quot;')}" data-month-options="${monthOptions.join(',')}">
        <!-- 누적 뷰 -->
        <div id="donutCumulView" style="display:flex;align-items:center;justify-content:center;gap:24px;">
          <!-- 도넛 차트 -->
          <div style="position:relative;width:${size}px;height:${size}px;">
            <svg viewBox="0 0 ${size} ${size}" style="width:100%;height:100%;">
              ${paths}
            </svg>
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;">
              <div style="font-size:0.7rem;color:#64748b;">총 매출</div>
              <div style="font-size:1.1rem;font-weight:700;color:#1e293b;">${(donutTotal / 10000).toFixed(0)}만</div>
            </div>
          </div>
          <!-- 범례 -->
          <div>
            <div style="margin-bottom:12px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <span style="width:12px;height:12px;border-radius:3px;background:#f97316;"></span>
                <span style="font-size:0.82rem;font-weight:600;color:#1e293b;">그로홈</span>
              </div>
              <div style="font-size:0.9rem;font-weight:700;color:#f97316;">${brandTotals.grohome ? (brandTotals.grohome / 10000).toFixed(0) + '만' : '0만'} <span style="font-size:0.75rem;color:#64748b;font-weight:500;">(${totalSales > 0 ? (brandTotals.grohome / totalSales * 100).toFixed(1) : 0}%)</span></div>
            </div>
            <div style="margin-bottom:12px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <span style="width:12px;height:12px;border-radius:3px;background:#10b981;"></span>
                <span style="font-size:0.82rem;font-weight:600;color:#1e293b;">포어스토어</span>
              </div>
              <div style="font-size:0.9rem;font-weight:700;color:#10b981;">${brandTotals.pourstore ? (brandTotals.pourstore / 10000).toFixed(0) + '만' : '0만'} <span style="font-size:0.75rem;color:#64748b;font-weight:500;">(${totalSales > 0 ? (brandTotals.pourstore / totalSales * 100).toFixed(1) : 0}%)</span></div>
            </div>
            <div>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <span style="width:12px;height:12px;border-radius:3px;background:#06b6d4;"></span>
                <span style="font-size:0.82rem;font-weight:600;color:#1e293b;">모여라딜${isNetMode && moyeoraDeductTotal > 0 ? '<span style="font-size:0.65rem;color:#94a3b8;font-weight:400;margin-left:3px;">(순)</span>' : ''}</span>
              </div>
              <div style="font-size:0.9rem;font-weight:700;color:#06b6d4;">${donutMoyVal ? (donutMoyVal / 10000).toFixed(0) + '만' : '0만'} <span style="font-size:0.75rem;color:#64748b;font-weight:500;">(${donutTotal > 0 ? (donutMoyVal / donutTotal * 100).toFixed(1) : 0}%)</span></div>
            </div>
          </div>
        </div>
        <!-- 월별 뷰 (숨김) -->
        <div id="donutMonthView" style="display:none;">
          <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:16px;">
            <button onclick="changeDonutMonth(-1)" style="width:32px;height:32px;border:1px solid #e2e8f0;background:#fff;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;color:#64748b;">◀</button>
            <span id="donutMonthLabel" style="font-size:1rem;font-weight:700;color:#1e293b;min-width:50px;text-align:center;">${currMonth}월</span>
            <button onclick="changeDonutMonth(1)" style="width:32px;height:32px;border:1px solid #e2e8f0;background:#fff;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;color:#64748b;">▶</button>
            <input type="hidden" id="donutMonthValue" value="${currMonth}" />
          </div>
          <div id="donutMonthChartArea" style="display:flex;align-items:center;justify-content:center;gap:24px;"></div>
        </div>
      </div>
      `;
      })() : `
      <div>
        <!-- 쇼핑몰 검색 -->
        <div style="margin-bottom:12px;">
          <input type="text" id="shopSearchInput" placeholder="쇼핑몰 검색..." oninput="filterShopList()" style="width:100%;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:0.8rem;outline:none;" />
        </div>
        <!-- 쇼핑몰 선택 버튼 -->
        <div id="shopButtonList" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;">
          ${allTopShops.map(([id, data], i) => {
            const brandColor = dashboardBrand === 'grohome' ? '#f97316' : dashboardBrand === 'pourstore' ? '#10b981' : '#06b6d4';
            const isFirst = i === 0;
            const safeName = (data.name || '').replace(/'/g, "\\'");
            return '<button class="shop-select-btn ' + (isFirst ? 'active' : '') + '" data-shop-id="' + id + '" data-shop-name="' + safeName + '" onclick="selectShopForChart(\'' + id + '\', \'' + safeName + '\')" style="padding:5px 10px;border:1px solid ' + (isFirst ? brandColor : '#e2e8f0') + ';background:' + (isFirst ? brandColor + '15' : '#fff') + ';color:' + (isFirst ? brandColor : '#64748b') + ';border-radius:4px;font-size:0.72rem;cursor:pointer;font-weight:' + (isFirst ? '600' : '400') + ';">' + data.name + '</button>';
          }).join('')}
        </div>
        <!-- 꺾은선 그래프 영역 -->
        <div id="inlineShopChart" style="min-height:220px;" data-first-shop="${allTopShops.length > 0 ? allTopShops[0][0] : ''}" data-first-name="${allTopShops.length > 0 ? (allTopShops[0][1].name || '').replace(/"/g, '&quot;') : ''}">
          <div style="color:#94a3b8;font-size:0.8rem;text-align:center;padding:60px;">차트 로딩중...</div>
        </div>
      </div>
      `}
    </div>

    <!-- 쇼핑몰 매출 순위 / 모여라딜은 매출 요약 -->
    ${dashboardBrand === 'moyeora' ? (() => {
      const mJgT = viewMonth >= 1 ? (moyeoraJungaeMonths[viewMonth - 1] || 0) : moyeoraJungaeTotal;
      const mDdT = viewMonth >= 1 ? (moyeoraDeductMonths[viewMonth - 1] || 0) : moyeoraDeductTotal;
      const mGhT = viewMonth >= 1 ? (moyeoraGrohomeMonths[viewMonth - 1] || 0) : moyeoraGrohomeTotal;
      const jgNet = mJgT - mDdT;
      const jgDisplay = isNetMode ? jgNet : mJgT;
      const fmtMan = (v) => v !== 0 ? (v / 10000).toFixed(0) + '만' : '-';
      return `
    <div class="dash-panel">
      <div class="dash-panel-header">
        <div class="dash-panel-title"><span class="material-symbols-outlined">receipt_long</span>모여라딜 매출 요약${viewMonth >= 1 ? ' (' + viewMonth + '월)' : ''}${isNetMode ? ' <span style="font-size:0.65rem;color:#06b6d4;">[순매출]</span>' : ' <span style="font-size:0.65rem;color:#94a3b8;">[총매출]</span>'}</div>
      </div>
      <div style="padding:8px 12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;font-size:0.82rem;font-weight:600;color:#1e293b;">
          <span>1. 중개매출${isNetMode ? ' <span style="font-size:0.65rem;color:#94a3b8;font-weight:400;">(순액조정 반영)</span>' : ''}</span><span>${fmtMan(jgDisplay)}</span>
        </div>
        ${isNetMode ? `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0 5px 16px;font-size:0.78rem;color:#64748b;">
          <span>(A) 총매출</span><span>${fmtMan(mJgT)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0 5px 16px;font-size:0.78rem;color:#64748b;">
          <span>(B) 순액조정</span><span>${mDdT ? '-' + fmtMan(mDdT) : '-'}</span>
        </div>` : ''}
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0 4px 0;margin-top:6px;border-top:1px dashed #e2e8f0;font-size:0.82rem;font-weight:600;color:#1e293b;">
          <span>2. 그로홈매출</span><span>${fmtMan(mGhT)}</span>
        </div>
      </div>
    </div>`;
      })() : `
    <div class="dash-panel">
      <div class="dash-panel-header">
        <div class="dash-panel-title"><span class="material-symbols-outlined">leaderboard</span>쇼핑몰별 매출 순위</div>
      </div>
      <div class="ranking-list" style="max-height:280px;overflow-y:auto;">
        ${allTopShops.slice(0, 7).map(([id, data], i) => {
          const percent = filteredTotal > 0 ? (data.total / filteredTotal * 100).toFixed(1) : 0;
          /* 브랜드별 색상 결정 */
          const dotClass = dashboardBrand === 'grohome' ? 'grohome' : dashboardBrand === 'pourstore' ? 'pourstore' : dashboardBrand === 'moyeora' ? 'moyeora' : (
            (id === 'grohome_jasang' || id.startsWith('gro_') || id === 'both_naver_gro' || id === 'both_smart_gro') ? 'grohome' :
            (id === 'pourstore_jasang' || id.startsWith('pour_') || id === 'both_naver_pour' || id === 'both_smart_pour') ? 'pourstore' :
            id.startsWith('moyeora_') ? 'moyeora' : ''
          );
          const safeName = (data.name || '').replace(/'/g, "\\'");
          return '<div class="ranking-row" onclick="selectShopForChart(\'' + id + '\', \'' + safeName + '\')" style="cursor:pointer;">' +
            '<div class="ranking-num">' + (i + 1) + '</div>' +
            '<div class="ranking-name"><span class="ranking-dot ' + dotClass + '"></span>' + data.name + '</div>' +
            '<div class="ranking-amount">' + (data.total / 10000).toFixed(0) + '만</div>' +
            '<div class="ranking-percent">' + percent + '%</div>' +
          '</div>';
        }).join('')}
        ${allTopShops.length === 0 ? '<div style="color:#94a3b8;font-size:0.8rem;text-align:center;padding:30px;">데이터 없음</div>' : ''}
      </div>
    </div>
    `}
  </div>

  <!-- 숨김 처리된 기존 패널 (호환성 유지) -->
  <div id="shopMonthlyChartPanel" class="dash-panel" style="margin-bottom:20px;display:none;">
    <div class="dash-panel-header">
      <div class="dash-panel-title"><span class="material-symbols-outlined">show_chart</span><span id="shopMonthlyChartTitle">쇼핑몰 월별 추이</span></div>
      <button onclick="document.getElementById('shopMonthlyChartPanel').style.display='none';" style="background:none;border:none;cursor:pointer;color:#94a3b8;font-size:1.2rem;">✕</button>
    </div>
    <div id="shopMonthlyChartContent"></div>
  </div>

  <!-- 월별 매출 추이 (슬림 막대그래프) -->
  <div class="dash-panel" style="margin-bottom:20px;">
    <div class="dash-panel-header">
      <div class="dash-panel-title"><span class="material-symbols-outlined">trending_up</span>월별 매출 추이</div>
    </div>
    <div class="month-chart" style="display:flex;align-items:flex-end;justify-content:space-around;height:160px;padding:10px 20px 0 20px;">
      ${monthTotals.map((val, i) => {
        const maxVal = Math.max(...monthTotals.filter(v => v > 0), 1);
        const barVal = Math.max(val, 0);
        const height = maxVal > 0 ? Math.max((barVal / maxVal * 110), barVal > 0 ? 6 : 0) : 0;
        const isCurr = i + 1 === currMonth;
        return `<div style="display:flex;flex-direction:column;align-items:center;width:40px;">
          <div style="font-size:0.58rem;font-weight:600;color:#64748b;margin-bottom:3px;">${val !== 0 ? (val / 10000).toFixed(0) : ''}</div>
          <div style="width:16px;height:${height}px;border-radius:8px 8px 4px 4px;background:${isCurr ? 'linear-gradient(180deg, #2E75B6 0%, #1e5a8a 100%)' : 'linear-gradient(180deg, #93c5fd 0%, #60a5fa 100%)'};box-shadow:${isCurr ? '0 2px 8px rgba(46,117,182,0.4)' : '0 1px 3px rgba(0,0,0,0.1)'};"></div>
          <div style="font-size:0.62rem;color:${isCurr ? '#2E75B6' : '#94a3b8'};margin-top:8px;font-weight:${isCurr ? '700' : '500'};">${i + 1}월</div>
        </div>`;
      }).join('')}
    </div>
  </div>

  ${dashboardBrand !== 'moyeora' ? `
  <!-- 브랜드별 월별 매출 테이블 -->
  <div class="dash-panel" style="margin-bottom:20px;">
    <div class="dash-panel-header">
      <div class="dash-panel-title"><span class="material-symbols-outlined">calendar_month</span>브랜드별 월별 매출</div>
    </div>
    <div style="overflow-x:auto;">
      <table class="cat-table">
        <thead>
          <tr>
            <th style="min-width:100px;">브랜드</th>
            ${[...Array(12)].map((_, i) => `<th>${i + 1}월</th>`).join('')}
            <th style="background:#1a5a8e;color:white;">합계</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><span class="ranking-dot grohome" style="display:inline-block;margin-right:6px;"></span>그로홈</td>
            ${brandMonthTotals.grohome.map((v, i) => `<td class="${v === 0 ? 'zero' : (i + 1 === currMonth ? 'highlight' : '')}">${v !== 0 ? (v / 10000).toFixed(0) : '-'}</td>`).join('')}
            <td class="highlight">${(brandTotals.grohome / 10000).toFixed(0)}만</td>
          </tr>
          <tr>
            <td><span class="ranking-dot pourstore" style="display:inline-block;margin-right:6px;"></span>포어스토어</td>
            ${brandMonthTotals.pourstore.map((v, i) => `<td class="${v === 0 ? 'zero' : (i + 1 === currMonth ? 'highlight' : '')}">${v !== 0 ? (v / 10000).toFixed(0) : '-'}</td>`).join('')}
            <td class="highlight">${(brandTotals.pourstore / 10000).toFixed(0)}만</td>
          </tr>
          <tr>
            <td><span class="ranking-dot moyeora" style="display:inline-block;margin-right:6px;"></span>모여라딜${isNetMode && moyeoraDeductTotal > 0 ? ' <span style="font-size:0.6rem;color:#94a3b8;">(순)</span>' : ''}</td>
            ${(isNetMode ? moyeoraNetMonths : brandMonthTotals.moyeora).map((v, i) => `<td class="${v === 0 ? 'zero' : (i + 1 === currMonth ? 'highlight' : '')}">${v !== 0 ? (v / 10000).toFixed(0) : '-'}</td>`).join('')}
            <td class="highlight">${((isNetMode ? moyeoraNetTotal : brandTotals.moyeora) / 10000).toFixed(0)}만</td>
          </tr>
          <tr class="total-row">
            <td>합계</td>
            ${filteredMonthTotals.map((v, i) => `<td class="${i + 1 === currMonth ? 'highlight' : ''}">${v !== 0 ? (v / 10000).toFixed(0) : '-'}</td>`).join('')}
            <td class="highlight">${(filteredMonthTotals.reduce((a, b) => a + b, 0) / 10000).toFixed(0)}만</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  ` : ''}

  <!-- 모여라딜 월별 상세 패널 제거됨 (브랜드별 뷰에서 상세 확인) -->

  ${dashboardBrand === 'grohome' ? `
  <!-- 그로홈 제품별 매출 (그로홈 탭에서만 표시) -->
  <div class="dash-panel" style="margin-bottom:20px;">
    <div class="dash-panel-header">
      <div class="dash-panel-title"><span class="material-symbols-outlined">inventory_2</span>제품별 매출 TOP 10</div>
      <div style="display:flex;gap:4px;">
        <button id="productTabGroup" onclick="switchProductTab('group')" style="padding:4px 10px;border:1px solid #f97316;background:#f97316;color:#fff;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:600;">제품별</button>
        <button id="productTabColor" onclick="switchProductTab('color')" style="padding:4px 10px;border:1px solid #e2e8f0;background:#fff;color:#64748b;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:500;">색상별</button>
      </div>
    </div>
    <!-- 제품별 뷰 (색상 제외) -->
    <div id="productGroupView" class="ranking-list">
      ${topProductGroups.length > 0 ? topProductGroups.map(([name, data], i) => {
        const percent = brandCardGrh > 0 ? (data.total / brandCardGrh * 100).toFixed(1) : 0;
        return '<div class="ranking-row"><div class="ranking-num">' + (i + 1) + '</div><div class="ranking-name"><span class="ranking-dot grohome"></span>' + data.name + '</div><div class="ranking-amount">' + (data.total / 10000).toFixed(0) + '만</div><div class="ranking-percent">' + percent + '%</div></div>';
      }).join('') : '<div style="color:#94a3b8;font-size:0.8rem;text-align:center;padding:30px;">데이터 없음</div>'}
    </div>
    <!-- 색상별 뷰 (상세) -->
    <div id="productColorView" class="ranking-list" style="display:none;">
      ${topProducts.length > 0 ? topProducts.map(([code, data], i) => {
        const percent = brandCardGrh > 0 ? (data.total / brandCardGrh * 100).toFixed(1) : 0;
        return '<div class="ranking-row"><div class="ranking-num">' + (i + 1) + '</div><div class="ranking-name"><span class="ranking-dot grohome"></span>' + data.name + '</div><div class="ranking-amount">' + (data.total / 10000).toFixed(0) + '만</div><div class="ranking-percent">' + percent + '%</div></div>';
      }).join('') : '<div style="color:#94a3b8;font-size:0.8rem;text-align:center;padding:30px;">데이터 없음</div>'}
    </div>
  </div>
  ` : ''}

  <div style="display:flex;justify-content:center;gap:12px;margin-top:24px;">
    <button onclick="switchSalesViewMode('byShop')" style="background:#3b82f6;color:#fff;border:none;padding:12px 28px;border-radius:8px;font-size:0.82rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:0 2px 8px rgba(59,130,246,0.3);">
      <span class="material-symbols-outlined" style="font-size:18px;">storefront</span>쇼핑몰별 상세
    </button>
    <button onclick="switchSalesViewMode('byBrand')" style="background:#64748b;color:#fff;border:none;padding:12px 28px;border-radius:8px;font-size:0.82rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:0 2px 8px rgba(100,116,139,0.3);">
      <span class="material-symbols-outlined" style="font-size:18px;">category</span>브랜드별 상세
    </button>
  </div>
  `;

  return html;
}

/* ===== 쇼핑몰 검색 필터 ===== */
function filterShopList() {
  const input = document.getElementById('shopSearchInput');
  if (!input) return;
  const query = input.value.toLowerCase();
  const buttons = document.querySelectorAll('#shopButtonList .shop-select-btn');
  buttons.forEach(btn => {
    const name = btn.getAttribute('data-shop-name').toLowerCase();
    btn.style.display = name.includes(query) ? '' : 'none';
  });
}

/* ===== 브랜드 매출 비중 도넛 탭 전환 ===== */
function switchDonutTab(tab) {
  const cumulBtn = document.getElementById('donutTabCumul');
  const monthBtn = document.getElementById('donutTabMonth');
  const cumulView = document.getElementById('donutCumulView');
  const monthView = document.getElementById('donutMonthView');
  if (!cumulBtn || !monthBtn || !cumulView || !monthView) return;

  if (tab === 'cumul') {
    cumulBtn.style.cssText = 'padding:4px 10px;border:1px solid #3b82f6;background:#3b82f6;color:#fff;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:600;';
    monthBtn.style.cssText = 'padding:4px 10px;border:1px solid #e2e8f0;background:#fff;color:#64748b;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:500;';
    cumulView.style.display = 'flex';
    monthView.style.display = 'none';
  } else {
    cumulBtn.style.cssText = 'padding:4px 10px;border:1px solid #e2e8f0;background:#fff;color:#64748b;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:500;';
    monthBtn.style.cssText = 'padding:4px 10px;border:1px solid #3b82f6;background:#3b82f6;color:#fff;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:600;';
    cumulView.style.display = 'none';
    monthView.style.display = 'block';
    updateDonutByMonth();
  }
}

/* ===== 월별 도넛 차트 월 변경 ===== */
function changeDonutMonth(delta) {
  const valueInput = document.getElementById('donutMonthValue');
  const label = document.getElementById('donutMonthLabel');
  const dataArea = document.getElementById('donutChartArea');
  if (!valueInput || !label || !dataArea) return;

  const monthOptions = (dataArea.getAttribute('data-month-options') || '').split(',').map(Number).filter(n => n > 0);
  if (monthOptions.length === 0) return;

  let currMonth = parseInt(valueInput.value) || 1;
  let currIdx = monthOptions.indexOf(currMonth);
  if (currIdx < 0) currIdx = 0;

  let newIdx = currIdx + delta;
  if (newIdx < 0) newIdx = monthOptions.length - 1;
  if (newIdx >= monthOptions.length) newIdx = 0;

  const newMonth = monthOptions[newIdx];
  valueInput.value = newMonth;
  label.textContent = newMonth + '월';
  updateDonutByMonth();
}

/* ===== 월별 도넛 차트 업데이트 ===== */
function updateDonutByMonth() {
  const valueInput = document.getElementById('donutMonthValue');
  const chartArea = document.getElementById('donutMonthChartArea');
  const dataArea = document.getElementById('donutChartArea');
  if (!valueInput || !chartArea || !dataArea) return;

  const month = parseInt(valueInput.value) - 1;
  const grohomeMonths = JSON.parse(dataArea.getAttribute('data-grohome-months') || '[]');
  const pourstoreMonths = JSON.parse(dataArea.getAttribute('data-pourstore-months') || '[]');
  const moyeoraMonths = JSON.parse(dataArea.getAttribute('data-moyeora-months') || '[]');

  const grohomeVal = grohomeMonths[month] || 0;
  const pourstoreVal = pourstoreMonths[month] || 0;
  const moyeoraVal = moyeoraMonths[month] || 0;
  const total = grohomeVal + pourstoreVal + moyeoraVal;

  const donutData = [
    { name: '그로홈', value: grohomeVal, color: '#f97316' },
    { name: '포어스토어', value: pourstoreVal, color: '#10b981' },
    { name: '모여라딜', value: moyeoraVal, color: '#06b6d4' }
  ].filter(d => d.value > 0);

  const size = 280;
  const cx = size / 2;
  const cy = size / 2;
  const outerR = 120;
  const innerR = 75;
  let startAngle = -90;

  function polarToCartesian(cx, cy, r, angle) {
    const rad = (angle * Math.PI) / 180;
    return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
  }
  function describeArc(cx, cy, outerR, innerR, startAngle, endAngle) {
    const start1 = polarToCartesian(cx, cy, outerR, startAngle);
    const end1 = polarToCartesian(cx, cy, outerR, endAngle);
    const start2 = polarToCartesian(cx, cy, innerR, endAngle);
    const end2 = polarToCartesian(cx, cy, innerR, startAngle);
    const largeArc = endAngle - startAngle > 180 ? 1 : 0;
    return ['M', start1.x, start1.y, 'A', outerR, outerR, 0, largeArc, 1, end1.x, end1.y, 'L', start2.x, start2.y, 'A', innerR, innerR, 0, largeArc, 0, end2.x, end2.y, 'Z'].join(' ');
  }

  let paths = '';
  donutData.forEach((d, i) => {
    const angle = total > 0 ? (d.value / total) * 360 : 0;
    const endAngle = startAngle + angle;
    if (angle > 0.5) {
      paths += '<path d="' + describeArc(cx, cy, outerR, innerR, startAngle, endAngle - 0.5) + '" fill="' + d.color + '" stroke="white" stroke-width="2"/>';
    }
    startAngle = endAngle;
  });

  const groPct = total > 0 ? (grohomeVal / total * 100).toFixed(1) : 0;
  const pourPct = total > 0 ? (pourstoreVal / total * 100).toFixed(1) : 0;
  const moyPct = total > 0 ? (moyeoraVal / total * 100).toFixed(1) : 0;

  chartArea.innerHTML = `
    <div style="position:relative;width:${size}px;height:${size}px;">
      <svg viewBox="0 0 ${size} ${size}" style="width:100%;height:100%;">
        ${paths || '<circle cx="100" cy="100" r="80" fill="#e2e8f0"/>'}
      </svg>
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;">
        <div style="font-size:0.75rem;color:#64748b;">${month + 1}월 매출</div>
        <div style="font-size:1.2rem;font-weight:700;color:#1e293b;">${(total / 10000).toFixed(0)}만</div>
      </div>
    </div>
    <div>
      <div style="margin-bottom:12px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <span style="width:12px;height:12px;border-radius:3px;background:#f97316;"></span>
          <span style="font-size:0.82rem;font-weight:600;color:#1e293b;">그로홈</span>
        </div>
        <div style="font-size:0.9rem;font-weight:700;color:#f97316;">${grohomeVal > 0 ? (grohomeVal / 10000).toFixed(0) + '만' : '0만'} <span style="font-size:0.75rem;color:#64748b;font-weight:500;">(${groPct}%)</span></div>
      </div>
      <div style="margin-bottom:12px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <span style="width:12px;height:12px;border-radius:3px;background:#10b981;"></span>
          <span style="font-size:0.82rem;font-weight:600;color:#1e293b;">포어스토어</span>
        </div>
        <div style="font-size:0.9rem;font-weight:700;color:#10b981;">${pourstoreVal > 0 ? (pourstoreVal / 10000).toFixed(0) + '만' : '0만'} <span style="font-size:0.75rem;color:#64748b;font-weight:500;">(${pourPct}%)</span></div>
      </div>
      <div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <span style="width:12px;height:12px;border-radius:3px;background:#06b6d4;"></span>
          <span style="font-size:0.82rem;font-weight:600;color:#1e293b;">모여라딜</span>
        </div>
        <div style="font-size:0.9rem;font-weight:700;color:#06b6d4;">${moyeoraVal > 0 ? (moyeoraVal / 10000).toFixed(0) + '만' : '0만'} <span style="font-size:0.75rem;color:#64748b;font-weight:500;">(${moyPct}%)</span></div>
      </div>
    </div>
  `;
}

/* ===== 제품별/색상별 탭 전환 ===== */
function switchProductTab(tab) {
  const groupBtn = document.getElementById('productTabGroup');
  const colorBtn = document.getElementById('productTabColor');
  const groupView = document.getElementById('productGroupView');
  const colorView = document.getElementById('productColorView');
  if (!groupBtn || !colorBtn || !groupView || !colorView) return;

  if (tab === 'group') {
    groupBtn.style.cssText = 'padding:4px 10px;border:1px solid #f97316;background:#f97316;color:#fff;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:600;';
    colorBtn.style.cssText = 'padding:4px 10px;border:1px solid #e2e8f0;background:#fff;color:#64748b;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:500;';
    groupView.style.display = 'block';
    colorView.style.display = 'none';
  } else {
    groupBtn.style.cssText = 'padding:4px 10px;border:1px solid #e2e8f0;background:#fff;color:#64748b;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:500;';
    colorBtn.style.cssText = 'padding:4px 10px;border:1px solid #f97316;background:#f97316;color:#fff;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:600;';
    groupView.style.display = 'none';
    colorView.style.display = 'block';
  }
}

/* ===== 인라인 쇼핑몰 차트 선택 ===== */
function selectShopForChart(shopId, shopName) {
  const chartContainer = document.getElementById('inlineShopChart');
  if (!chartContainer) return;

  /* 버튼 active 상태 업데이트 */
  const buttons = document.querySelectorAll('#shopButtonList .shop-select-btn');
  const brandColor = dashboardBrand === 'grohome' ? '#f97316' : dashboardBrand === 'pourstore' ? '#10b981' : '#06b6d4';
  buttons.forEach(btn => {
    const isActive = btn.getAttribute('data-shop-id') === shopId;
    btn.style.border = `1px solid ${isActive ? brandColor : '#e2e8f0'}`;
    btn.style.background = isActive ? brandColor + '15' : '#fff';
    btn.style.color = isActive ? brandColor : '#64748b';
    btn.style.fontWeight = isActive ? '600' : '400';
  });

  /* 월별 데이터 가져오기 */
  const isVatMinus = vatMode === 'minus';
  const fmt = v => isVatMinus ? Math.round(v / 1.1) : v;
  const monthVals = new Array(12).fill(0);

  /* 모여라딜 가상 shopId 처리 (그로홈/중개매출) */
  if (shopId === 'moyeora_dash_grohome' || shopId === 'moyeora_dash_jungae') {
    for (let m = 1; m <= 12; m++) {
      const sales = DATA.sales && DATA.sales[m];
      if (!sales) continue;
      if (shopId === 'moyeora_dash_grohome') {
        const ghRaw = Number(sales['moyeora_grohome']) || 0;
        const offGhRaw = Number(sales['pour_offline_moyeora_grohome']) || 0;
        monthVals[m - 1] = fmt(ghRaw) + fmt(offGhRaw);
      } else {
        let jgRaw = Number(sales['moyeora_moyeora']) || 0;
        if (jgRaw === 0) {
          const legacyVal = Number(sales['moyeora_cafe24']) || 0;
          const grohomeVal = Number(sales['moyeora_grohome']) || 0;
          if (legacyVal > 0 && grohomeVal === 0) jgRaw = legacyVal;
          else if (legacyVal > 0) jgRaw = legacyVal - grohomeVal;
        }
        let offJgRaw = Number(sales['pour_offline_moyeora_jungae']) || 0;
        const offGhRaw = Number(sales['pour_offline_moyeora_grohome']) || 0;
        if (offJgRaw === 0 && offGhRaw === 0) {
          offJgRaw = Number(sales['pour_offline_moyeora']) || 0;
        }
        monthVals[m - 1] = fmt(jgRaw) + fmt(offJgRaw);
      }
    }
  } else {
    const groupShopIds = {
      grohome_jasang: [...JASANG_GROUPS.grohome.shopIds],
      pourstore_jasang: [...JASANG_GROUPS.pourstore.shopIds]
    };

    SHOPS.forEach(shop => {
      if (!SHOP_MAPPINGS[shop.id]) return;
      const dataPaths = getShopSetting(shop.id, 'dataPaths');
      if (!dataPaths || !Array.isArray(dataPaths)) return;

      let matchShopKey = shop.id;
      if (groupShopIds.grohome_jasang.includes(shop.id)) matchShopKey = 'grohome_jasang';
      else if (groupShopIds.pourstore_jasang.includes(shop.id)) matchShopKey = 'pourstore_jasang';
      else if (shop.id === 'pour_coupang_0') matchShopKey = 'pour_coupang_0';
      else if (shop.id === 'pour_coupang_1') matchShopKey = 'pour_coupang_1';

      if (matchShopKey !== shopId) return;

      if (shop.subTabs && shop.subTabs.length > 0) {
        shop.subTabs.forEach(t => {
          const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shop.id, i, t.id)]);
          if (!allUploaded) return;
          const result = executeMerge(shop.id, true, t.id);
          if (result && result.rows.length > 0) {
            aggregateShopMonthly(result, monthVals, fmt, dashboardBrand);
          }
        });
      } else {
        const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shop.id, i)]);
        if (!allUploaded) return;
        const result = executeMerge(shop.id, true);
        if (result && result.rows.length > 0) {
          aggregateShopMonthly(result, monthVals, fmt, dashboardBrand);
        }
      }
    });
  }

  /* SVG 꺾은선 그래프 생성 (음수는 그래프상 0 처리, 숫자는 실제값) */
  const maxVal = Math.max(...monthVals.filter(v => v > 0), 1);
  const width = 400;
  const height = 180;
  const padding = { top: 35, right: 15, bottom: 30, left: 15 };
  const chartWidth = width - padding.left - padding.right;
  const chartHeight = height - padding.top - padding.bottom;

  const points = monthVals.map((val, i) => {
    const x = padding.left + (i / 11) * chartWidth;
    const chartVal = Math.max(val, 0);
    const y = chartVal > 0 ? padding.top + chartHeight - (chartVal / maxVal) * chartHeight : padding.top + chartHeight;
    return { x, y, val, month: i + 1 };
  });

  const linePath = points.map((p, i) => (i === 0 ? 'M' : 'L') + p.x.toFixed(2) + ',' + p.y.toFixed(2)).join(' ');
  const areaPath = linePath + ' L' + points[11].x.toFixed(2) + ',' + (padding.top + chartHeight) + ' L' + points[0].x.toFixed(2) + ',' + (padding.top + chartHeight) + ' Z';

  const total = monthVals.reduce((a, b) => a + b, 0);

  let svgHtml = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <span style="font-size:0.9rem;font-weight:700;color:#1e293b;">${shopName}</span>
      <span style="font-size:0.82rem;color:#64748b;font-weight:600;">연간 ${(total / 10000).toFixed(0)}만</span>
    </div>
    <svg viewBox="0 0 ${width} ${height}" style="width:100%;height:180px;" preserveAspectRatio="xMidYMid meet">
      <defs>
        <linearGradient id="inlineGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:${brandColor};stop-opacity:0.3"/>
          <stop offset="100%" style="stop-color:${brandColor};stop-opacity:0.05"/>
        </linearGradient>
      </defs>
      <path d="${areaPath}" fill="url(#inlineGradient)"/>
      <path d="${linePath}" fill="none" stroke="${brandColor}" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
      ${points.map(p => `
        <circle cx="${p.x.toFixed(2)}" cy="${p.y.toFixed(2)}" r="${p.month === currentMonth ? 7 : 5}" fill="${p.month === currentMonth ? '#dc2626' : brandColor}" stroke="white" stroke-width="2"/>
        ${p.val !== 0 ? `<text x="${p.x.toFixed(2)}" y="${p.y.toFixed(2) - 12}" font-size="11" fill="#374151" text-anchor="middle" font-weight="700">${(p.val / 10000).toFixed(0)}</text>` : ''}
        <text x="${p.x.toFixed(2)}" y="${padding.top + chartHeight + 18}" font-size="11" fill="${p.month === currentMonth ? brandColor : '#6b7280'}" text-anchor="middle" font-weight="${p.month === currentMonth ? '700' : '500'}">${p.month}월</text>
      `).join('')}
    </svg>
  `;

  chartContainer.innerHTML = svgHtml;
}

/* ===== 쇼핑몰 월별 추이 차트 표시 (기존 팝업용) ===== */
let currentShopMonthlyData = {};
function showShopMonthlyChart(shopId, shopName) {
  const panel = document.getElementById('shopMonthlyChartPanel');
  const title = document.getElementById('shopMonthlyChartTitle');
  const content = document.getElementById('shopMonthlyChartContent');

  if (!panel || !content) return;

  /* 현재 쇼핑몰의 월별 데이터 가져오기 */
  const isVatMinus = vatMode === 'minus';
  const fmt = v => isVatMinus ? Math.round(v / 1.1) : v;

  /* shopData에서 해당 쇼핑몰 찾기 - 브랜드별로 합산 */
  const monthVals = new Array(12).fill(0);

  /* 로우데이터에서 해당 쇼핑몰의 월별 매출 집계 */
  const groupShopIds = {
    grohome_jasang: [...JASANG_GROUPS.grohome.shopIds],
    pourstore_jasang: [...JASANG_GROUPS.pourstore.shopIds]
  };

  SHOPS.forEach(shop => {
    if (!SHOP_MAPPINGS[shop.id]) return;
    const dataPaths = getShopSetting(shop.id, 'dataPaths');
    if (!dataPaths || !Array.isArray(dataPaths)) return;

    /* 쇼핑몰 ID 매칭 확인 */
    let matchShopKey = shop.id;
    if (groupShopIds.grohome_jasang.includes(shop.id)) matchShopKey = 'grohome_jasang';
    else if (groupShopIds.pourstore_jasang.includes(shop.id)) matchShopKey = 'pourstore_jasang';
    else if (shop.id === 'pour_coupang_0') matchShopKey = 'pour_coupang_0';
    else if (shop.id === 'pour_coupang_1') matchShopKey = 'pour_coupang_1';

    if (matchShopKey !== shopId) return;

    if (shop.subTabs && shop.subTabs.length > 0) {
      shop.subTabs.forEach(t => {
        const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shop.id, i, t.id)]);
        if (!allUploaded) return;
        const result = executeMerge(shop.id, true, t.id);
        if (result && result.rows.length > 0) {
          aggregateShopMonthly(result, monthVals, fmt, dashboardBrand);
        }
      });
    } else {
      const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shop.id, i)]);
      if (!allUploaded) return;
      const result = executeMerge(shop.id, true);
      if (result && result.rows.length > 0) {
        aggregateShopMonthly(result, monthVals, fmt, dashboardBrand);
      }
    }
  });

  currentShopMonthlyData = { shopId, shopName, monthVals };

  title.textContent = shopName + ' 월별 추이';

  const maxVal = Math.max(...monthVals.filter(v => v > 0), 1);
  const brandColor = dashboardBrand === 'grohome' ? '#06b6d4' : dashboardBrand === 'pourstore' ? '#f97316' : dashboardBrand === 'moyeora' ? '#10b981' : '#2E75B6';

  let chartHtml = '<div style="display:flex;align-items:flex-end;justify-content:space-between;height:140px;padding:10px 4px 0 4px;gap:4px;">';
  monthVals.forEach((val, i) => {
    const height = maxVal > 0 ? Math.max((val / maxVal * 100), val > 0 ? 8 : 0) : 0;
    const isCurr = i + 1 === currentMonth;
    chartHtml += `<div style="flex:1;display:flex;flex-direction:column;align-items:center;">
      <div style="font-size:0.6rem;font-weight:600;color:#64748b;margin-bottom:4px;">${val > 0 ? (val / 10000).toFixed(0) : ''}</div>
      <div style="width:100%;height:${height}px;border-radius:4px 4px 0 0;background:${isCurr ? brandColor : brandColor + '60'};"></div>
      <div style="font-size:0.65rem;color:${isCurr ? brandColor : '#94a3b8'};margin-top:6px;font-weight:${isCurr ? '700' : '500'};">${i + 1}월</div>
    </div>`;
  });
  chartHtml += '</div>';

  const total = monthVals.reduce((a, b) => a + b, 0);
  chartHtml += `<div style="text-align:center;margin-top:12px;font-size:0.85rem;font-weight:600;color:#1e293b;">연간 합계: ${(total / 10000).toFixed(0)}만원</div>`;

  content.innerHTML = chartHtml;
  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function aggregateShopMonthly(result, monthVals, fmt, targetBrand) {
  const brandIdx = result.headers.indexOf('브랜드');
  const amtIdx = result.headers.indexOf('매출금액(v+)');
  const monthIdx = result.headers.indexOf('매출월');

  if (amtIdx < 0) return;

  const brandMatch = targetBrand === 'grohome' ? '그로홈' :
                     targetBrand === 'pourstore' ? '포어스토어' :
                     targetBrand === 'moyeora' ? '모여라딜' : null;

  result.rows.forEach(row => {
    if (brandMatch && brandIdx >= 0) {
      const brand = String(row[brandIdx] || '').trim();
      if (brand !== brandMatch) return;
    }

    const amt = Number(String(row[amtIdx] || 0).replace(/,/g, '')) || 0;
    if (amt === 0) return;

    let month = currentMonth;
    if (monthIdx >= 0) {
      const monthVal = String(row[monthIdx] || '');
      const m = monthVal.match(/(\d{4})-(\d{2})/);
      if (m) month = parseInt(m[2]);
    }

    monthVals[month - 1] += fmt(amt);
  });
}

/* ===== 데이터 취합 뷰 렌더링 ===== */
function renderMergeView() {
  const container = document.getElementById('mergeView');

  /* 취합 상태 계산 */
  let readyList = [], notReadyList = [], totalRows = 0;
  const shopStatus = [];

  SHOPS.forEach(shop => {
    if (!SHOP_MAPPINGS[shop.id]) return;
    const dataPaths = getShopSetting(shop.id, 'dataPaths');
    if (!dataPaths || !Array.isArray(dataPaths)) return;

    if (shop.subTabs && shop.subTabs.length > 0) {
      shop.subTabs.forEach(t => {
        const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shop.id, i, t.id)]);
        let rowCount = 0;
        if (allUploaded) {
          const result = executeMerge(shop.id, true, t.id);
          if (result) rowCount = result.rows.length;
          readyList.push(t.label);
        } else {
          notReadyList.push(t.label);
        }
        shopStatus.push({ name: t.label, ready: allUploaded, rows: rowCount, lastUpload: allUploaded ? '업로드됨' : '-' });
        totalRows += rowCount;
      });
    } else {
      const allUploaded = dataPaths.every((_, i) => UPLOAD_FILES[getUploadKey(shop.id, i)]);
      let rowCount = 0;
      if (allUploaded) {
        const result = executeMerge(shop.id, true);
        if (result) rowCount = result.rows.length;
        readyList.push(shop.name);
      } else {
        notReadyList.push(shop.name);
      }
      shopStatus.push({ name: shop.name.replace('포어_','').replace('그로홈_',''), ready: allUploaded, rows: rowCount, lastUpload: allUploaded ? '업로드됨' : '-' });
      totalRows += rowCount;
    }
  });

  const totalShops = readyList.length + notReadyList.length;
  const completedShops = readyList.length;
  const pendingShops = notReadyList.length;

  let html = `
  <div class="merge-header" style="margin-bottom:24px;">
    <h2 style="font-size:1.2rem;font-weight:700;margin-bottom:4px;">데이터 취합</h2>
    <p style="font-size:0.8rem;color:var(--text-muted);">각 쇼핑몰에서 업로드한 데이터를 하나의 엑셀로 통합</p>
  </div>

  <!-- 액션 버튼 -->
  <div style="display:flex;gap:12px;margin-bottom:24px;">
    <button class="btn-primary" onclick="executeMergeAll()" style="background:var(--primary);color:white;border:none;padding:12px 24px;border-radius:var(--radius-sm);font-size:0.8rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;">
      <span class="material-symbols-outlined" style="font-size:18px;">download</span>로우데이터 다운로드
    </button>
    <button class="btn-primary" onclick="downloadMaeibMaechulFormat()" style="background:#10b981;color:white;border:none;padding:12px 24px;border-radius:var(--radius-sm);font-size:0.8rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;">
      <span class="material-symbols-outlined" style="font-size:18px;">description</span>위하고 업로드 양식
    </button>
    <button class="btn-secondary" onclick="location.reload()" style="background:white;color:var(--primary);border:1px solid var(--primary);padding:12px 24px;border-radius:var(--radius-sm);font-size:0.8rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;">
      <span class="material-symbols-outlined" style="font-size:18px;">refresh</span>새로고침
    </button>
  </div>

  <!-- 취합 현황 카드 -->
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;">
    <div style="background:white;border:1px solid var(--gray-light);border-radius:var(--radius);padding:20px;text-align:center;">
      <div style="font-size:1.8rem;font-weight:700;color:var(--primary);">${totalShops}</div>
      <div style="font-size:0.7rem;color:var(--text-muted);margin-top:4px;">전체 쇼핑몰</div>
    </div>
    <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:var(--radius);padding:20px;text-align:center;">
      <div style="font-size:1.8rem;font-weight:700;color:#16a34a;">${completedShops}</div>
      <div style="font-size:0.7rem;color:#16a34a;margin-top:4px;">업로드 완료</div>
    </div>
    <div style="background:#fef3c7;border:1px solid #fde68a;border-radius:var(--radius);padding:20px;text-align:center;">
      <div style="font-size:1.8rem;font-weight:700;color:#d97706;">${pendingShops}</div>
      <div style="font-size:0.7rem;color:#d97706;margin-top:4px;">업로드 대기</div>
    </div>
    <div style="background:white;border:1px solid var(--gray-light);border-radius:var(--radius);padding:20px;text-align:center;">
      <div style="font-size:1.8rem;font-weight:700;color:var(--primary);">${totalRows.toLocaleString()}</div>
      <div style="font-size:0.7rem;color:var(--text-muted);margin-top:4px;">총 행 수</div>
    </div>
  </div>

  <!-- 쇼핑몰별 상태 테이블 -->
  <div style="background:white;border:1px solid var(--gray-light);border-radius:var(--radius);overflow:hidden;">
    <div style="padding:16px 20px;border-bottom:1px solid var(--gray-light);">
      <h3 style="font-size:0.85rem;font-weight:700;">쇼핑몰별 상태</h3>
    </div>
    <table style="width:100%;border-collapse:collapse;font-size:0.75rem;">
      <thead>
        <tr style="background:var(--bg);">
          <th style="padding:12px 16px;text-align:left;font-weight:600;border-bottom:2px solid var(--primary);">쇼핑몰</th>
          <th style="padding:12px 16px;text-align:center;font-weight:600;border-bottom:2px solid var(--primary);">상태</th>
          <th style="padding:12px 16px;text-align:right;font-weight:600;border-bottom:2px solid var(--primary);">행 수</th>
        </tr>
      </thead>
      <tbody>
        ${shopStatus.map(s => `
          <tr style="border-bottom:1px solid var(--gray-light);">
            <td style="padding:12px 16px;font-weight:500;">${s.name}</td>
            <td style="padding:12px 16px;text-align:center;">
              ${s.ready
                ? '<span style="color:#16a34a;font-weight:600;">✓ 완료</span>'
                : '<span style="color:#d97706;">⏳ 대기</span>'}
            </td>
            <td style="padding:12px 16px;text-align:right;font-weight:500;">${s.rows > 0 ? s.rows.toLocaleString() : '-'}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  </div>
  `;

  container.innerHTML = html;
}

init();
</script>

<!-- 키워드 관리 모달 -->
<div id="keywordModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;">
  <div style="background:white;border-radius:12px;width:90%;max-width:900px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column;">
    <div style="padding:16px 20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div style="font-weight:700;font-size:1.1rem;">그로홈 제품 키워드 관리</div>
        <div style="font-size:0.75rem;color:var(--text-muted);">상품명 키워드 매칭 규칙 (우선순위 높은 순서대로 매칭)</div>
      </div>
      <button onclick="closeKeywordModal()" style="background:none;border:none;cursor:pointer;padding:4px;">
        <span class="material-symbols-outlined" style="font-size:24px;color:var(--gray);">close</span>
      </button>
    </div>
    <div style="padding:20px;overflow-y:auto;flex:1;">
      <table class="mapping-table" id="keywordTableModal">
        <thead>
          <tr>
            <th style="width:50px;">순위</th>
            <th style="width:70px;">상품코드</th>
            <th style="min-width:160px;">표준상품명</th>
            <th style="min-width:90px;">키워드1</th>
            <th style="min-width:90px;">키워드2</th>
            <th style="min-width:90px;">키워드3</th>
            <th style="width:60px;">조건</th>
            <th style="width:50px;"></th>
          </tr>
        </thead>
        <tbody id="keywordTableBodyModal"></tbody>
      </table>
    </div>
    <div style="padding:16px 20px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:space-between;">
      <div style="display:flex;gap:8px;">
        <button class="btn-cancel" onclick="downloadKeywordsExcel()" title="키워드 백업"><span class="material-symbols-outlined" style="font-size:13px;">download</span> 다운로드</button>
        <label class="btn-cancel" style="cursor:pointer;display:inline-flex;align-items:center;gap:4px;" title="키워드 복원">
          <span class="material-symbols-outlined" style="font-size:13px;">upload</span> 업로드
          <input type="file" accept=".xlsx,.xls" onchange="uploadKeywordsExcel(event)" style="display:none;">
        </label>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn-cancel" onclick="addKeywordRowModal()"><span class="material-symbols-outlined" style="font-size:13px;">add</span> 추가</button>
        <button class="btn-save" onclick="saveKeywordsModal()">키워드 저장</button>
      </div>
    </div>
  </div>
</div>

<script>
/* 키워드 모달 열기/닫기 */
function openKeywordModal() {
  document.getElementById('keywordModal').style.display = 'flex';
  renderKeywordTableModal();
}
function closeKeywordModal() {
  document.getElementById('keywordModal').style.display = 'none';
}

/* 모달용 키워드 테이블 렌더링 */
function renderKeywordTableModal() {
  const tbody = document.getElementById('keywordTableBodyModal');
  tbody.innerHTML = '';
  PRODUCT_KEYWORDS.forEach((kw, idx) => {
    const kws = kw.keywords || [];
    tbody.innerHTML += `<tr>
      <td><input type="number" value="${kw.priority || idx}" min="0" data-field="priority" style="width:40px;text-align:center;"></td>
      <td><input type="text" value="${kw.code || ''}" data-field="code" style="width:60px;"></td>
      <td><input type="text" value="${kw.name || ''}" data-field="name" style="width:150px;"></td>
      <td><input type="text" value="${kws[0] || ''}" data-field="kw0" style="width:80px;"></td>
      <td><input type="text" value="${kws[1] || ''}" data-field="kw1" style="width:80px;"></td>
      <td><input type="text" value="${kws[2] || ''}" data-field="kw2" style="width:80px;"></td>
      <td><select data-field="match" style="width:55px;">
        <option value="AND" ${kw.match==='AND'?'selected':''}>AND</option>
        <option value="OR" ${kw.match==='OR'?'selected':''}>OR</option>
        <option value="SINGLE" ${kw.match==='SINGLE'?'selected':''}>SINGLE</option>
      </select></td>
      <td><button onclick="removeKeywordRowModal(${idx})" style="background:none;border:none;color:#e53935;cursor:pointer;"><span class="material-symbols-outlined" style="font-size:16px;">delete</span></button></td>
    </tr>`;
  });
}

function addKeywordRowModal() {
  const maxPriority = PRODUCT_KEYWORDS.length > 0 ? Math.max(...PRODUCT_KEYWORDS.map(k => k.priority || 0)) + 1 : 1;
  PRODUCT_KEYWORDS.push({ priority: maxPriority, code: '', name: '', keywords: ['', '', ''], match: 'AND' });
  renderKeywordTableModal();
}

function removeKeywordRowModal(idx) {
  PRODUCT_KEYWORDS.splice(idx, 1);
  renderKeywordTableModal();
}

function saveKeywordsModal() {
  const rows = document.querySelectorAll('#keywordTableBodyModal tr');
  rows.forEach((row, idx) => {
    if (!PRODUCT_KEYWORDS[idx]) return;
    const inputs = row.querySelectorAll('input, select');
    inputs.forEach(inp => {
      const field = inp.dataset.field;
      if (!field) return;
      if (field === 'priority') PRODUCT_KEYWORDS[idx].priority = Number(inp.value) || 0;
      else if (field === 'code') PRODUCT_KEYWORDS[idx].code = inp.value.trim();
      else if (field === 'name') PRODUCT_KEYWORDS[idx].name = inp.value.trim();
      else if (field === 'kw0') PRODUCT_KEYWORDS[idx].keywords[0] = inp.value.trim();
      else if (field === 'kw1') PRODUCT_KEYWORDS[idx].keywords[1] = inp.value.trim();
      else if (field === 'kw2') PRODUCT_KEYWORDS[idx].keywords[2] = inp.value.trim();
      else if (field === 'match') PRODUCT_KEYWORDS[idx].match = inp.value;
    });
  });
  /* 빈 키워드 필터링 및 정렬 */
  PRODUCT_KEYWORDS.forEach(kw => { kw.keywords = kw.keywords.filter(k => k !== ''); });
  PRODUCT_KEYWORDS.sort((a, b) => (a.priority || 0) - (b.priority || 0));
  localStorage.setItem('productKeywords', JSON.stringify(PRODUCT_KEYWORDS));
  renderKeywordTableModal();
  showToast('키워드가 저장되었습니다');
}

/* 키워드 엑셀 다운로드 */
function downloadKeywordsExcel() {
  /* 현재 모달 입력값 먼저 저장 */
  saveKeywordsModal();

  const headers = ['순위', '상품코드', '표준상품명', '키워드1', '키워드2', '키워드3', '조건'];
  const rows = PRODUCT_KEYWORDS.map(kw => {
    const kws = kw.keywords || [];
    return [
      kw.priority || 0,
      kw.code || '',
      kw.name || '',
      kws[0] || '',
      kws[1] || '',
      kws[2] || '',
      kw.match || 'AND'
    ];
  });

  const wsData = [headers, ...rows];
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [
    { wch: 6 },   /* 순위 */
    { wch: 12 },  /* 상품코드 */
    { wch: 35 },  /* 표준상품명 */
    { wch: 15 },  /* 키워드1 */
    { wch: 15 },  /* 키워드2 */
    { wch: 15 },  /* 키워드3 */
    { wch: 8 }    /* 조건 */
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '키워드관리');
  const fileName = '키워드관리_백업_' + new Date().toISOString().slice(0, 10) + '.xlsx';
  XLSX.writeFile(wb, fileName);
  showToast('키워드 백업 다운로드: ' + fileName);
}

/* 키워드 엑셀 업로드 */
function uploadKeywordsExcel(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      if (rows.length < 2) {
        showToast('유효한 데이터가 없습니다');
        return;
      }

      /* 헤더 확인 */
      const header = rows[0];
      const expectedHeaders = ['순위', '상품코드', '표준상품명', '키워드1', '키워드2', '키워드3', '조건'];
      const isValid = expectedHeaders.every((h, i) => header[i] === h);

      if (!isValid) {
        showToast('엑셀 양식이 올바르지 않습니다. 다운로드된 양식을 사용해주세요.');
        return;
      }

      /* 데이터 파싱 */
      const newKeywords = [];
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.length < 3) continue;
        if (!row[2]) continue; /* 표준상품명 없으면 스킵 */

        const keywords = [];
        if (row[3]) keywords.push(String(row[3]).trim());
        if (row[4]) keywords.push(String(row[4]).trim());
        if (row[5]) keywords.push(String(row[5]).trim());

        newKeywords.push({
          priority: Number(row[0]) || i,
          code: String(row[1] || '').trim(),
          name: String(row[2] || '').trim(),
          keywords: keywords,
          match: String(row[6] || 'AND').toUpperCase()
        });
      }

      if (newKeywords.length === 0) {
        showToast('유효한 키워드가 없습니다');
        return;
      }

      /* 기존 데이터 교체 */
      PRODUCT_KEYWORDS.length = 0;
      newKeywords.forEach(kw => PRODUCT_KEYWORDS.push(kw));
      PRODUCT_KEYWORDS.sort((a, b) => (a.priority || 0) - (b.priority || 0));
      localStorage.setItem('productKeywords', JSON.stringify(PRODUCT_KEYWORDS));

      renderKeywordTableModal();
      showToast('키워드 ' + newKeywords.length + '개 복원 완료');

    } catch (err) {
      console.error(err);
      showToast('파일 읽기 오류: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
  event.target.value = ''; /* 같은 파일 다시 선택 가능하도록 */
}

/* 모달 외부 클릭 시 닫기 */
document.getElementById('keywordModal').addEventListener('click', function(e) {
  if (e.target === this) closeKeywordModal();
});
</script>
</body>
</html>
